<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Шахматный квест</title>

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Spectral:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    html, body{
  background: var(--bg);
  color: var(--text);
  font-family: var(--font);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Sand + plants (eye-friendly) theme for chessboard.js v1
   Мягкий контраст, хорошая читаемость фигур, приятное тёплое свечение.
   Вставь ПОСЛЕ chessboard.css */

:root{
  /* Клетки: “песок” + “шалфей/листья” (мягко, но различимо) */
  --sq-light: #f3ecdf;  /* светлый песок */
  --sq-dark:  #a9c1a8;  /* приглушённый шалфей */

  --grid-line: rgba(35, 28, 18, 0.07);

  /* Свечение: тёплое солнечное + лёгкий зелёный оттенок */
  --glow-sun:  rgba(255, 205, 135, 0.18);
  --glow-leaf: rgba(140, 210, 160, 0.12);
}

/* (Опционально) подложка вокруг доски, если есть контейнер #board */
#board{
  padding: 14px;
  border-radius: 18px;
  background:
    radial-gradient(120% 100% at 25% 10%, rgba(255,255,255,0.75), rgba(255,255,255,0.35) 60%),
    linear-gradient(180deg, #f8f4ec 0%, #eee6d8 100%);
}

/* Контейнер доски: аккуратная рамка + мягкое “живое” свечение */
.board-b72b1{
  border-radius: 14px;
  overflow: hidden;

  border: 1px solid rgba(35, 28, 18, 0.16);
  background: #0b1220; /* даёт глубину по краям */

  box-shadow:
    0 14px 38px rgba(17, 24, 39, 0.16),
    0 0 18px var(--glow-sun),
    0 0 40px var(--glow-leaf),
    inset 0 0 0 1px rgba(255,255,255,0.22);
}

/* Клетки */
.white-1e1d7{
  background: var(--sq-light) !important;
  /* лёгкая фактура “песка”, очень деликатно */
  background-image:
    radial-gradient(18px 14px at 28% 32%, rgba(255,255,255,0.25), rgba(255,255,255,0) 65%),
    radial-gradient(16px 12px at 70% 74%, rgba(120, 90, 40, 0.06), rgba(120,90,40,0) 70%),
    linear-gradient(180deg, rgba(255,255,255,0.14), rgba(0,0,0,0.04));
  background-blend-mode: screen, multiply, overlay;
}

.black-3c85d{
  background: var(--sq-dark) !important;
  /* лёгкий “листовой” оттенок + мягкий объём */
  background-image:
    radial-gradient(18px 14px at 32% 72%, rgba(255,255,255,0.16), rgba(255,255,255,0) 65%),
    radial-gradient(16px 12px at 76% 28%, rgba(35, 60, 35, 0.08), rgba(35,60,35,0) 70%),
    linear-gradient(180deg, rgba(255,255,255,0.10), rgba(0,0,0,0.08));
  background-blend-mode: screen, multiply, overlay;
}

/* Тонкие разделители — помогают видеть сетку, не “шумят” */
.white-1e1d7, .black-3c85d{
  box-shadow: inset 0 0 0 1px var(--grid-line);
}

/* Ненавязчивая реакция на наведение */
.white-1e1d7:hover, .black-3c85d:hover{
  filter: brightness(1.03) saturate(1.02);
}

/* Опционально: мягкая тень фигур для читаемости (актуально для PNG) */
.board-b72b1 img{
  filter: drop-shadow(0 2px 2px rgba(20, 14, 8, 0.18));
}



body{
  text-align: center; /* можно оставить, но лучше убрать и центрировать контейнер */
}

    /* Общий лейаут: слева оглавление, справа квест */
   #layout{
  max-width: 1120px;
  margin: 0 auto;
  padding: 16px 16px 28px;
  display: grid;
  grid-template-columns: 360px 1fr;
  gap: 18px;
  align-items: start;
}
    /* Оглавление – минимализм и пастельные тона */
    #toc {
      width: 350px;
      text-align: left;
      border-right: 1px solid #e5e7eb;
      padding-right: 14px;
      box-sizing: border-box;
      padding-top: 10px;
    }

    #toc h3 {
       position: sticky;
  
  margin: 0;
  background: linear-gradient(180deg, rgba(247,247,251,0.95), rgba(247,247,251,0.65));
  backdrop-filter: blur(10px);
  padding: 10px 0 8px;
  z-index: 1;
    }

    /* === ГРУППЫ В ОГЛАВЛЕНИИ === */
   .toc-group{
  background: rgba(255,255,255,0.48);
  border: 1px solid rgba(255,255,255,0.34);
  box-shadow: 0 14px 34px rgba(0,0,0,0.12);
  backdrop-filter: blur(12px) saturate(140%);
  -webkit-backdrop-filter: blur(12px) saturate(140%);
}

.toc-group.has-active{
  border-color: rgba(10, 132, 255, 0.30);
}

.toc-group.has-active .toc-group-title{
  background: rgba(10, 132, 255, 0.10);
}

.toc-group.has-active .toc-group-toggle-icon{
  border-color: rgba(10, 132, 255, 0.55);
  color: rgba(29, 78, 216, 1);
  background: rgba(10, 132, 255, 0.10);
}


  .toc-group:hover{
  box-shadow:
    0 0 0 1px rgba(124,58,237,0.18),
    0 20px 48px rgba(124,58,237,0.16),
    0 14px 34px rgba(0,0,0,0.12);
  background: rgba(255,255,255,0.52);
}


    .toc-group-title {
      margin: 0;
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.2px;
      color: #111827;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      gap: 10px;
    }

    .toc-group-title-left {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }

    .toc-group-title-badge {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: linear-gradient(135deg, #93c5fd, #c4b5fd);
      box-shadow: 0 0 0 3px rgba(147, 197, 253, 0.35);
      flex-shrink: 0;
    }

    .toc-group-title-text {
      font-size: 13px;
      font-weight: 700;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      color: #111827;
    }

    .toc-group-toggle-icon {
      flex-shrink: 0;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #4b5563;
      background: rgba(255, 255, 255, 0.9);
      transition:
        transform 0.18s ease,
        background-color 0.18s ease,
        border-color 0.18s ease,
        color 0.18s ease;
    }

    .toc-group:not(.collapsed) .toc-group-toggle-icon {
      transform: rotate(90deg);
      background: #e5edff;
      border-color: #93c5fd;
      color: #1d4ed8;
    }

    .toc-group ol {
      margin: 0;
      padding: 8px 4px 10px 4px;
      list-style: none;
      border-top: 1px solid rgba(209, 213, 219, 0.7);
    }

    .toc-group.collapsed ol {
      display: none;
    }

    #toc ol:not(.toc-group ol) {
      margin: 0;
      padding: 0;
      list-style: none;
    }

    #toc li + li {
      margin-top: 6px;
    }

    #toc .toc-item {
      width: 100%;
      background: transparent;
      border: none;
      padding: 7px 9px;
      margin: 0;
      cursor: pointer;
      font: inherit;
      text-align: left;
      display: flex;
      align-items: flex-start;
      gap: 8px;
      border-radius: 8px;
      color: #111827;
      transition:
        background-color 0.15s ease,
        box-shadow 0.15s ease,
        transform 0.05s ease,
        color 0.15s ease;
    }

    #toc .toc-item-number {
      flex-shrink: 0;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #1d4ed8;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      margin-top: 1px;
      transition:
        background-color 0.15s ease,
        color 0.15s ease;
    }

    #toc .toc-item-text {
      flex: 1;
      min-width: 0;
    }

    #toc .toc-item-main {
      display: block;
      font-size: 14px;
      font-weight: 600;
      line-height: 1.25;
      margin-bottom: 1px;
      letter-spacing: 0.2px;
    }

    #toc .toc-item-sub {
      display: block;
      font-size: 12px;
      color: #6b7280;
      line-height: 1.3;
      transition: color 0.15s ease;
    }

    #toc .toc-item:hover {
     background: rgba(10, 132, 255, 0.10);
  box-shadow:
    0 0 0 1px rgba(10, 132, 255, 0.35),
    0 10px 24px rgba(10, 132, 255, 0.14);
  transform: translateY(-1px);
    }

    #toc .toc-item:hover .toc-item-number {
     	background: #3b82f6;
      color: #ffffff;
    }

    #toc .toc-item:hover .toc-item-sub {
      color: #1d4ed8;
    }

    #toc .toc-item.active {
      background: #dbeafe;
      box-shadow:
        0 0 0 1px rgba(59, 130, 246, 0.6),
        0 3px 10px rgba(59, 130, 246, 0.35);
    }

    #toc .toc-item.active .toc-item-number {
      background: #3b82f6;
      color: #ffffff;
    }

    /* === ВОЛШЕБНИК ПОД ВОПРОСАМИ В ПРАВОЙ КОЛОНКЕ === */
    #toc-wizard {
      margin-top: 14px;
      padding-top: 10px;
      border-top: 1px solid rgba(209, 213, 219, 0.8);
      text-align: left;
    }

    #toc-wizard-inner {
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    #toc-wizard img {
      width: 72px;
      height: auto;
      display: block;
      filter: drop-shadow(0 6px 10px rgba(15, 23, 42, 0.25));
      user-select: none;
      -webkit-user-drag: none;
    }

    #wizard-bubble {
      position: relative;
      flex: 1;
      min-height: 40px;
      padding: 8px 10px;
      border-radius: 12px;
      background: #ffffff;
      border: 1px solid rgba(148, 163, 184, 0.55);
      box-shadow:
        0 2px 8px rgba(15, 23, 42, 0.08);
      color: #0f172a;
      font-size: 12.5px;
      line-height: 1.35;

      opacity: 0;
      transform: translateY(6px) scale(0.98);
      pointer-events: none;

      transition: opacity 0.18s ease, transform 0.18s ease;
    }

    #wizard-bubble::before {
      content: '';
      position: absolute;
      left: -7px;
      top: 16px;
      width: 12px;
      height: 12px;
      background: #ffffff;
      border-left: 1px solid rgba(148, 163, 184, 0.55);
      border-bottom: 1px solid rgba(148, 163, 184, 0.55);
      transform: rotate(45deg);
    }

    #wizard-bubble.visible {
      opacity: 1;
      transform: translateY(0) scale(1);
      animation: none;
    }

    @keyframes bubblePop {
      0% { opacity: 0; transform: translateY(8px) scale(0.98); }
      10% { opacity: 1; transform: translateY(0) scale(1); }
      80% { opacity: 1; transform: translateY(0) scale(1); }
      100% { opacity: 0; transform: translateY(6px) scale(0.99); }
    }

    #wizard-bubble-text {
      white-space: pre-wrap;
    }

    #quest-container {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 20px;
    }

    #board-column {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #board-wrapper {
      position: relative;
      margin: 0 0 6px; /* верх убрали */
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }
    #board-column,
#question-block{
  padding-top: 10px; /* одинаковый старт по вертикали */
}
    #board-wrapper.hit-impact {
      animation: hitImpact 0.4s ease-out;
    }

    @keyframes hitImpact {
      0% {
        transform: scale(1) translate(0, 0);
        box-shadow:
          0 0 18px rgba(0, 0, 0, 0.9),
          0 0 18px rgba(90, 150, 255, 0.7);
      }
      20% {
        transform: scale(1.03) translate(-4px, 2px);
        box-shadow:
          0 0 26px rgba(250, 204, 21, 0.95),
          0 0 36px rgba(250, 204, 21, 0.9);
      }
      40% {
        transform: scale(0.98) translate(3px, -2px);
        box-shadow:
          0 0 24px rgba(59, 130, 246, 0.9),
          0 0 38px rgba(59, 130, 246, 0.8);
      }
      60% {
        transform: scale(1.02) translate(-2px, 1px);
      }
      100% {
        transform: scale(1) translate(0, 0);
        box-shadow:
          0 0 18px rgba(0, 0, 0, 0.9),
          0 0 18px rgba(90, 150, 255, 0.7);
      }
    }

/* === DIAMOND IMPACT: “молния / level up” для 3 очков === */
#board-wrapper.hit-impact-diamond{
  animation: diamondImpact 0.65s ease-out;
}

@keyframes diamondImpact{
  0%{
    transform: scale(1);
    filter: brightness(1) saturate(1);
    box-shadow:
      0 0 0 1px rgba(255,255,255,0.10),
      0 18px 50px rgba(0,0,0,0.35);
  }
  12%{
    transform: scale(1.035);
    filter: brightness(1.5) saturate(1.25);
    box-shadow:
      0 0 0 2px rgba(255,255,255,0.35),
      0 0 24px rgba(255,255,255,0.95),
      0 0 58px rgba(56,189,248,0.55),
      0 22px 70px rgba(0,0,0,0.40);
  }
  30%{
    transform: scale(1.01);
    filter: brightness(1.2) saturate(1.15);
    box-shadow:
      0 0 0 2px rgba(255,255,255,0.22),
      0 0 18px rgba(255,255,255,0.65),
      0 0 44px rgba(124,58,237,0.35),
      0 18px 55px rgba(0,0,0,0.38);
  }
  55%{
    transform: scale(1.02);
    filter: brightness(1.15) saturate(1.05);
    box-shadow:
      0 0 0 1px rgba(255,255,255,0.18),
      0 0 14px rgba(255,255,255,0.40),
      0 0 34px rgba(56,189,248,0.28),
      0 18px 50px rgba(0,0,0,0.35);
  }
  100%{
    transform: scale(1);
    filter: brightness(1) saturate(1);
    box-shadow:
      0 0 0 1px rgba(255,255,255,0.14),
      0 18px 50px rgba(0,0,0,0.35),
      0 0 34px rgba(124,58,237,0.18),
      0 0 26px rgba(14,165,233,0.14);
  }
}




    #board-arrow-layer {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: visible;
    }

    #board {
      width: 380px;
  border-radius: 14px;
  overflow: hidden;

  box-shadow:
    0 0 0 1px rgba(255,255,255,0.14),
    0 18px 50px rgba(0,0,0,0.35),
    0 0 34px rgba(124,58,237,0.18),
    0 0 26px rgba(14,165,233,0.14);
    }

    #board .square-55d63.hover-highlight-from {
      box-shadow: inset 0 0 0 3px rgba(34, 197, 94, 0.95);
      background: radial-gradient(circle, rgba(250, 204, 21, 0.55), transparent 70%);
    }

    #board .square-55d63.hover-highlight-to {
      box-shadow: inset 0 0 0 3px rgba(34, 197, 94, 0.95);
      background: radial-gradient(circle, rgba(34, 197, 94, 0.55), transparent 70%);
    }

    #board .square-55d63.user-highlight-square {
      box-shadow:
        inset 0 0 0 3px rgba(59, 130, 246, 0.9),
        inset 0 0 12px rgba(59, 130, 246, 0.85);
      background:
        radial-gradient(circle, rgba(59, 130, 246, 0.35), transparent 70%);
    }

    .board-arrow {
      stroke: rgba(59, 130, 246, 0.95);
      stroke-width: 3;
      stroke-linecap: round;
      stroke-linejoin: round;
      filter: drop-shadow(0 0 1px rgba(15, 23, 42, 0.4));
    }

    .board-arrow-head {
      fill: rgba(59, 130, 246, 0.98);
      filter: drop-shadow(0 0 1px rgba(15, 23, 42, 0.4));
    }

    #flip-board-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      padding: 2px 6px;
      font-size: 10px;
      line-height: 1;
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, 0.12);
      background: rgba(255, 255, 255, 0.5);
      color: #555;
      cursor: pointer;
      opacity: 0.35;
      transition: opacity 0.15s ease;
      z-index: 2;
    }

    #flip-board-btn:hover {
      opacity: 0.8;
    }

    #resize-board-handle {
      position: absolute;
      right: 6px;
      bottom: 60px;
      width: 14px;
      height: 14px;
      border-radius: 3px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background:
        linear-gradient(135deg,
          rgba(148, 163, 184, 0.4) 0%,
          rgba(148, 163, 184, 0.1) 60%,
          rgba(255, 255, 255, 0.0) 100%);
      cursor: nwse-resize;
      opacity: 0.35;
      box-shadow:
        0 0 0 1px rgba(148, 163, 184, 0.2),
        0 0 6px rgba(15, 23, 42, 0.35);
      z-index: 3;
      transition: opacity 0.15s ease, box-shadow 0.15s ease, transform 0.1s ease;
    }

    #resize-board-handle::before,
    #resize-board-handle::after {
      content: '';
      position: absolute;
      right: 2px;
      bottom: 2px;
      width: 8px;
      height: 1px;
      background: rgba(51, 65, 85, 0.65);
      transform-origin: right bottom;
    }

    #resize-board-handle::before {
      transform: rotate(45deg);
      opacity: 0.9;
    }

    #resize-board-handle::after {
      transform: rotate(45deg) translateY(-3px);
      opacity: 0.6;
    }

    #resize-board-handle:hover {
      opacity: 0.8;
      box-shadow:
        0 0 0 1px rgba(59, 130, 246, 0.6),
        0 0 10px rgba(59, 130, 246, 0.85);
      transform: scale(1.05);
    }

    #resize-board-handle:active {
      opacity: 1;
      box-shadow:
        0 0 0 1px rgba(37, 99, 235, 0.9),
        0 0 14px rgba(37, 99, 235, 0.95);
      transform: scale(0.97);
    }

    #notation-block {
      width: 420px;
      margin: 6px 0 0;
      text-align: left;
      border: 1px solid #d1d5db;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 14px;
      background: #f9fafb;
      box-sizing: border-box;
    }

    #notation-block h3 {
      margin: 0 0 6px 0;
      font-size: 15px;
    }
    #notation-content {
      max-height: 150px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-family: "Courier New", monospace;
    }

    .current-move {
      background: #ffe599;
      font-weight: bold;
      padding: 1px 2px;
      border-radius: 3px;
    }

    #question-block {
      width: 340px;
      text-align: left;
      padding: 0px 10px;
    }

    #intro-text h2 {
      font-size: 18px;
    }

    #answers {
      margin-top: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #answers .answer-option {
      position: relative;
      display: block;
      width: 100%;
      padding: 10px 14px 10px 44px;
      border-radius: 8px;
      border: 1px solid #d0d7e2;
      background: #f7f9fc;
      cursor: pointer;
      text-align: left;
      font-size: 14px;
      line-height: 1.4;
      transition:
        background 0.15s ease,
        border-color 0.15s ease,
        box-shadow 0.15s ease,
        transform 0.05s ease;
    }

    #answers .answer-option::before {
      content: attr(data-letter);
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: #4b6fff;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: bold;
    }

    #answers .answer-option:hover:not(:disabled),
    #answers .answer-option:focus-visible:not(:disabled) {
      background: #eef3ff;
      border-color: #4b6fff;
      box-shadow: 0 0 0 3px rgba(75, 111, 255, 0.15);
      outline: none;
      transform: translateY(-1px);
    }

    #answers .answer-option:disabled {
      cursor: default;
      opacity: 0.85;
    }

    #answers .answer-option.correct {
      border-color: #2e9b4f;
      background: #ecf8f0;
    }

    #answers .answer-option.incorrect {
      border-color: #d93025;
      background: #fff3f2;
    }

    #status {
      margin-top: 10px;
      font-weight: 600;
      font-size: 14px;
      min-height: 18px;
    }

    #explanation {
      margin-top: 6px;
      font-size: 13px;
      color: #333;
      min-height: 18px;
    }

    #survival-controls {
      margin: 14px auto 6px;
      width: 100%;
      display: flex;
      align-items: center;           /* центр по ширине TOC */
  justify-content: center;
  gap: 10px;    }

    #survival-btn{
      position: relative;
      overflow: hidden;

      padding: 8px 12px;
      border-radius: 10px;

      background: #ffffff;
      border: 1px solid rgba(15, 23, 42, 0.14);

      color: rgba(15, 23, 42, 0.92);
      font-size: 13px;
      font-weight: 650;
      letter-spacing: 0.2px;

      cursor: pointer;
      user-select: none;

      transition:
        transform 0.12s ease,
        box-shadow 0.18s ease,
        border-color 0.18s ease,
        background-color 0.18s ease;
      box-shadow:
        0 1px 0 rgba(15, 23, 42, 0.04),
        0 10px 24px rgba(15, 23, 42, 0.08);
    }

    #survival-btn:hover{
      transform: translateY(-1px);
      border-color: rgba(15, 23, 42, 0.22);
      box-shadow:
        0 1px 0 rgba(15, 23, 42, 0.04),
        0 14px 34px rgba(15, 23, 42, 0.10);
    }

    #survival-btn:active{
      transform: translateY(0);
      box-shadow:
        0 1px 0 rgba(15, 23, 42, 0.03),
        0 8px 18px rgba(15, 23, 42, 0.10);
    }

    #survival-btn:focus-visible{
      outline: none;
      box-shadow:
        0 0 0 3px rgba(15, 23, 42, 0.18),
        0 14px 34px rgba(15, 23, 42, 0.10);
    }

    #survival-btn.active{
      background: rgba(15, 23, 42, 0.04);
      border-color: rgba(15, 23, 42, 0.24);
      color: rgba(15, 23, 42, 0.95);
    }

    #survival-btn::after{
      content:"";
      position:absolute;
      inset:0;
      opacity:0;
      pointer-events:none;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(105, 203, 42, 0.5),
        transparent
      );
      transform: translateX(-60%);
      transition: opacity 0.18s ease;
    }

    #survival-btn:hover::after{
      opacity: 1;
      animation: btn-sheen 0.9s ease-out infinite;
    }

    @keyframes btn-sheen{
      from { transform: translateX(-60%); }
      to   { transform: translateX(60%); }
    }

    @media (prefers-reduced-motion: reduce){
      #survival-btn,
      #survival-btn::after{
        transition: none;
        animation: none;
      }
    }

    #lives-container {
      display: none;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 12px;
      border: 1px solid rgba(239, 68, 68, 0.25);
      background: rgba(255, 255, 255, 0.8);
      box-shadow: 0 2px 10px rgba(15, 23, 42, 0.08);
    }

    #lives-container.visible {
      display: inline-flex;
    }

    .life-heart {
      font-size: 18px;
      line-height: 1;
      color: #ef4444;
      text-shadow: 0 2px 8px rgba(239, 68, 68, 0.35);
      user-select: none;
    }

    .life-heart.lost {
      color: rgba(239, 68, 68, 0.22);
      text-shadow: none;
      filter: grayscale(1);
    }

    #score {
      margin-top: 10px;
      font-weight: 700;
      font-size: 15px;
      position: relative;
      display: inline-block;
      padding-right: 40px;
    }

    #score-value {
      display: inline-block;
      transition: transform 0.35s ease, color 0.35s ease;
    }

    .score-pulse {
      transform: scale(1.2);
      color: #16a34a;
    }

    .score-popup {
      position: absolute;
      right: 0;
      top: 0;
      font-size: 13px;
      font-weight: 700;
      opacity: 0;
      pointer-events: none;
      transform: translateY(0);
      animation: scoreFloat 1.6s ease-out forwards;
      text-shadow: 0 0 4px rgba(0,0,0,0.4);
    }

    .score-popup.positive {
      color: #22c55e;
    }

    .score-popup.negative {
      color: #ef4444;
    }

    @keyframes scoreFloat {
      0% {
        opacity: 0;
        transform: translateY(0);
      }
      20% {
        opacity: 1;
        transform: translateY(-4px);
      }
      100% {
        opacity: 0;
        transform: translateY(-18px);
      }
    }

    #progress-container {
      margin-top: 8px;
      font-size: 12px;
      color: #4b5563;
    }

    #progress-label {
      margin-bottom: 4px;
    }

    #progress-track {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
      box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.35);
    }

    #progress-bar {
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, #4b6fff, #22c55e);
      box-shadow:
        0 0 6px rgba(59, 130, 246, 0.7),
        0 0 12px rgba(34, 197, 94, 0.6);
      transition: width 0.35s ease;
    }

    #move-controls {
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

 /* move buttons become square minimal */
.move-btn{
  border-radius: 12px;
  min-width: 0;
  height: 44px;
  padding: 0 14px;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  font-weight: 700;
  box-shadow: var(--btn-shadow);
  background: var(--btn-bg);
  border: 1px solid var(--btn-border);
  color: var(--btn-text);
  animation: none !important;
}

.move-btn:hover:not(:disabled){
  animation: none !important;
  transform: translateY(-1px);
  box-shadow: var(--btn-shadow-hover);
  border-color: rgba(79, 70, 229, 0.30);
}

    .move-btn .icon {
      font-size: 14px;
      line-height: 1;
    }

    @keyframes btn-pulse {
      0% {
        box-shadow:
          0 0 0 0 rgba(191, 219, 254, 0.9),
          0 0 10px rgba(59, 130, 246, 0.45);
        transform: translateY(-0.5px) scale(1);
      }
      50% {
        box-shadow:
          0 0 0 6px rgba(191, 219, 254, 0),
          0 0 16px rgba(59, 130, 246, 0.7);
        transform: translateY(-1px) scale(1.03);
      }
      100% {
        box-shadow:
          0 0 0 0 rgba(191, 219, 254, 0),
          0 0 10px rgba(59, 130, 246, 0.45);
        transform: translateY(-0.5px) scale(1);
      }
    }

    .move-btn:hover:not(:disabled) {
      background-color: #f9fafb;
      border-color: #93c5fd;
      color: #111827;
      animation: btn-pulse 1.1s ease-out infinite;
    }

    .move-btn:focus-visible {
      outline: none;
      animation: none;
      transform: translateY(-0.5px);
      box-shadow:
        0 0 0 2px rgba(191, 219, 254, 0.9),
        0 0 14px rgba(59, 130, 246, 0.45);
    }

    .move-btn:active:not(:disabled) {
      animation: none;
      transform: translateY(0) scale(0.98);
      box-shadow:
        0 0 0 1px rgba(147, 197, 253, 0.9),
        0 0 8px rgba(59, 130, 246, 0.3);
    }

    .move-btn:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
      transform: none;
      animation: none;
    }

    #move-counter {
      font-size: 13px;
      color: #6b7280;
      min-width: 90px;
      text-align: center;
    }

    #welcome-screen h2 {
      text-align: center;
    }

    #welcome-screen p {
      text-indent: 40px;
    }

    #welcome-screen {
      max-width: 600px;
      margin: 20px auto;
      text-align: left;
    }

   

    #victory-effect {
      position: fixed;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 9999;
      display: none;
      background:
        radial-gradient(circle at 20% 0%, rgba(248, 250, 252, 0.04), transparent 55%),
        radial-gradient(circle at 80% 0%, rgba(248, 250, 252, 0.04), transparent 55%);
      backdrop-filter: blur(1.5px);
    }

    .firework {
      position: absolute;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #fff;
      opacity: 0;
      box-shadow:
        0 0 8px rgba(255, 255, 255, 0.95),
        0 0 18px rgba(255, 255, 255, 0.9);
      filter: saturate(1.4);
      mix-blend-mode: screen;
      animation: firework-burst 1.8s ease-out forwards;
    }

    .firework-core {
      position: absolute;
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: radial-gradient(circle, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0) 65%);
      opacity: 0;
      mix-blend-mode: screen;
      animation: firework-core-pulse 1.4s ease-out forwards;
      pointer-events: none;
    }

    .firework-ring {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 2px solid rgba(255, 255, 255, 0.9);
      opacity: 0;
      mix-blend-mode: screen;
      animation: firework-ring-expand 1.6s ease-out forwards;
      pointer-events: none;
    }

    @keyframes firework-burst {
      0% { transform: translate(0, 0) scale(0.4); opacity: 0; }
      10% { opacity: 1; }
      60% { opacity: 1; }
      100% { transform: translate(var(--dx), var(--dy)) scale(1.15); opacity: 0; }
    }

    @keyframes firework-core-pulse {
      0% { opacity: 0; transform: scale(0.3); }
      20% { opacity: 1; transform: scale(1); }
      80% { opacity: 1; }
      100% { opacity: 0; transform: scale(1.4); }
    }

    @keyframes firework-ring-expand {
      0% { opacity: 0; transform: scale(0.2); }
      15% { opacity: 1; }
      100% { opacity: 0; transform: scale(3.2); }
    }

    #gameover-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.78);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      backdrop-filter: blur(2px);
    }

    #gameover-overlay.visible {
      display: flex;
    }

    #gameover-content {
      text-align: center;
      color: #f9fafb;
      max-width: 640px;
      padding: 24px 28px;
      border-radius: 16px;
      background: radial-gradient(circle at top, rgba(248, 250, 252, 0.18), rgba(15, 23, 42, 0.95));
      box-shadow:
        0 0 40px rgba(0, 0, 0, 0.8),
        0 0 80px rgba(30, 64, 175, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.6);
      animation: gameover-pop 0.4s ease-out;
    }

    #gameover-video {
      width: 100%;
      max-height: 360px;
      border-radius: 12px;
      display: block;
      margin-bottom: 16px;
      background: #000;
    }

    @keyframes gameover-pop {
      0% {
        opacity: 0;
        transform: scale(0.9) translateY(10px);
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

.next-quest-btn {
  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;

  padding: 10px 24px;
  border-radius: 999px;

  border: 1px solid rgba(0, 0, 0, 0.14);
  background: #ffffff;
  color: #222;

  font-size: 13px;
  font-weight: 500;
  letter-spacing: 0.06em;
  text-transform: uppercase;

  cursor: pointer;
  white-space: nowrap;

  transition:
    background-color 0.22s ease-out,
    border-color 0.22s ease-out,
    color 0.22s ease-out,
    box-shadow 0.22s ease-out,
    transform 0.22s ease-out;
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.05);
  overflow: hidden;
}

.next-quest-btn span {
  position: relative;
  transform: translateX(-2px);
  transition: transform 0.22s ease-out;
}

.next-quest-btn::after {
  content: "";
  position: relative;
  width: 10px;
  height: 10px;
  margin-left: 8px;

  border-right: 2px solid currentColor;
  border-bottom: 2px solid currentColor;
  transform: translateX(-4px) rotate(-45deg);
  transition:
    transform 0.22s ease-out,
    opacity 0.22s ease-out;
  opacity: 0.9;
}

.next-quest-btn::before {
  content: "";
  position: absolute;
  top: 0;
  left: -40%;
  width: 40%;
  height: 100%;
  background: linear-gradient(
    120deg,
    rgba(255, 255, 255, 0) 0%,
    rgba(255, 255, 255, 0.7) 50%,
    rgba(255, 255, 255, 0) 100%
  );
  transform: skewX(-20deg);
  opacity: 0;
  pointer-events: none;
}

/* Hover — подсветка синим */
.next-quest-btn:hover {
  background: #e6f0ff;               /* мягкий голубой фон */
  border-color: #2f80ff;             /* синяя рамка */
  color: #1454c4;                    /* синеватый текст/стрелка */
  box-shadow:
    0 0 0 1px rgba(47, 128, 255, 0.28),
    0 10px 22px rgba(47, 128, 255, 0.35);  /* синее свечение */
  transform: translateX(3px) translateY(-1px);
}

.next-quest-btn:hover span {
  transform: translateX(-1px);
}

.next-quest-btn:hover::after {
  transform: translateX(1px) rotate(-45deg);
  opacity: 1;
}

.next-quest-btn:hover::before {
  animation: nextQuestShine 0.65s ease-out forwards;
}

.next-quest-btn:active {
  background: #d0e2ff;
  transform: translateX(4px) translateY(0);
  box-shadow: 0 4px 10px rgba(47, 128, 255, 0.4);
}

.next-quest-btn:focus-visible {
  outline: none;
  box-shadow:
    0 0 0 1px #2f80ff,
    0 0 0 4px rgba(47, 128, 255, 0.35),
    0 6px 16px rgba(0, 0, 0, 0.08);
}

.next-quest-btn:disabled {
  opacity: 0.55;
  cursor: default;
  transform: none;
  box-shadow: none;
}

@keyframes nextQuestShine {
  0% {
    left: -40%;
    opacity: 0;
  }
  20% {
    opacity: 0.7;
  }
  100% {
    left: 120%;
    opacity: 0;
  }
}



    .restart-btn {
      padding: 12px 22px;
      border-radius: 999px;
      border: 2px solid #3b82f6;
      background:
        radial-gradient(circle at 0 0, rgba(96, 165, 250, 0.35), transparent 55%),
        radial-gradient(circle at 100% 0, rgba(129, 140, 248, 0.35), transparent 55%),
        linear-gradient(180deg, #0f172a 0%, #020617 100%);
      color: #e5f0ff;
      font-size: 14px;
      font-weight: 900;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      position: relative;
      z-index: 1;
      --hover: rgba(59, 130, 246, 0.7);
      box-shadow:
        0 0 12px rgba(59, 130, 246, 0.6),
        0 0 30px rgba(59, 130, 246, 0.2),
        inset 0 0 10px rgba(15, 23, 42, 0.8);
      transition:
        transform 0.12s ease-out,
        box-shadow 0.12s ease-out,
        background 0.12s ease-out,
        border-color 0.12s ease-out;
    }

    .restart-btn::before {
      content: "";
      position: absolute;
      inset: -3px;
      border-radius: inherit;
      background: radial-gradient(circle, rgba(56, 189, 248, 0.7), transparent 60%);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease-out;
      z-index: -1;
    }

    .restart-btn:hover,
    .restart-btn:focus {
      animation: pulse 1s;
      box-shadow:
        0 0 18px rgba(59, 130, 246, 0.9),
        0 0 40px rgba(59, 130, 246, 0.4),
        inset 0 0 10px rgba(15, 23, 42, 0.9);
      transform: translateY(-1px).scale(1.03);
      border-color: #60a5fa;
    }

    .restart-btn:hover::before,
    .restart-btn:focus::before {
      opacity: 1;
    }

    .restart-btn:active {
      transform: translateY(1px) scale(0.97);
      box-shadow:
        0 0 5px rgba(37, 99, 235, 0.8),
        0 0 15px rgba(37, 99, 235, 0.4),
        inset 0 0 14px rgba(15, 23, 42, 1);
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 var(--hover);
      }
      100% {
        box-shadow: 0 0 0 18px transparent;
      }
    }

    #era-progress {
      max-width: 1100px;
      margin: 24px auto 10px;
      padding: 8px 16px 14px;
      box-sizing: border-box;
      font-size: 11px;
      color: #6b7280;
      display: none;
    }

    #era-progress-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
    }

    #era-progress-header span {
      white-space: nowrap;
    }

    #era-progress-track {
      position: relative;
      width: 100%;
      height: 5px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: visible;
    }

    #era-progress-fill {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 0%;
      background: linear-gradient(90deg, #4b6fff, #22c55e);
      transition: width 0.35s ease;
    }

    #era-progress-thumb {
      position: absolute;
      top: -15px;
      left: 0%;
      transform: translate(-50%, -50%);
      width: 85px;
      height: auto;
      pointer-events: none;
    }

    @keyframes timecar-nudge {
      0%   { transform: translate(-50%, -50%) scale(1); }
      40%  { transform: translate(-50%, -54%) scale(1.03); }
      70%  { transform: translate(-50%, -48%) scale(0.99); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }

    #era-progress-track:hover #era-progress-thumb {
      filter:
        drop-shadow(0 0 6px rgba(59, 130, 246, 1))
        drop-shadow(0 0 18px rgba(56, 189, 248, 0.9));
      animation: timecar-nudge 0.9s ease-out;
    }

    #era-progress-current {
      margin-top: 4px;
      font-size: 11px;
      color: #4b5563;
      text-align: center;
      min-height: 14px;
    }
/* =========================
   MOBILE / RESPONSIVE
   ========================= */

html, body {
  max-width: 100%;
  overflow-x: hidden;
}

img, video, canvas {
  max-width: 100%;
  height: auto;
}

/* Чтобы “iOS safe area” не прятала контент */
body {
  padding-left: env(safe-area-inset-left);
  padding-right: env(safe-area-inset-right);
}

/* Планшеты и узкие ноутбуки */
@media (max-width: 900px) {
  h1 {
    display: none;
  }
  #notation-block {
    display: none;
  }
   #survival-controls {
    display: none;
  }
  #layout {
    max-width: 100%;
    margin-left: 0;        /* Важно: убираем ваш margin-left:150px */
    padding: 0 12px;
    flex-direction: column;
    gap: 14px;
  }

  #toc {
    width: 100%;
    border-right: none;
    padding-right: 0;
  }

  /* Оглавление можно сделать “аккордеоном” шириной 100% */
  .toc-group {
    margin: 10px 0;
  }

  #quest-container {
    width: 100%;
    flex-direction: column;
    align-items: stretch;
    gap: 6px;
  }

  #board-column {
    width: 100%;
  }

  /* Доска и нотация — не фиксированные 420px, а резиновые */
  #board {
    width: 100%;
  }

  #notation-block {
    width: 100%;
  }

  #question-block {
   padding-top: 0;
  }

  /* Чуть компактнее кнопки управления ходами */
  #move-controls {
    justify-content: space-between;
    flex-wrap: wrap;
  }

  .move-btn {
    min-width: 120px;
  }
#board-wrapper {
    margin: 8px 0 4px;   /* было 20px 0 (десктоп) и 12px 0 (<=520) */
  }
  /* Варианты ответов — чуть компактнее */
  #answers .answer-option {
    padding: 10px 12px 10px 44px;
  }

  /* Экран приветствия */
  #welcome-screen {
    padding: 0 12px;
  }
}

/* Телефоны */
@media (max-width: 520px) {
  
  body {
    font-size: 14px;
    line-height: 1.35;
  }
  h1 {
    font-size: 18px;
    margin: 8px 0;
  }

  #board-wrapper {
    margin: 12px 0;
  }

  /* Нотация поменьше по высоте */
  #notation-content {
    max-height: 120px;
    font-size: 13px;
  }

  /* Кнопка переворота доски и хэндл — крупнее для пальца */
  #flip-board-btn {
    font-size: 12px;
    padding: 4px 8px;
    opacity: 0.7;
  }

  #resize-board-handle {
    width: 18px;
    height: 18px;
    opacity: 0.7;
  }
  #question-block {
    padding: 6px 0;
  }

  /* Вопросы/ответы */
  #question-title {
    font-size: 16px;
    margin: 8px 0 6px;
    margin-top: 0;
  }
 #question-text {
    font-size: 12px;
    line-height: 1.35;
    margin: 0 0 8px;
  }
 #answers {
    gap: 6px;
    margin-top: 8px;
  }

  #answers .answer-option {
    padding: 8px 10px 8px 40px;
    border-radius: 8px;
  }

  #answers .answer-option::before {
    width: 18px;
    height: 18px;
    font-size: 11px;
    left: 10px;
  }

  #status { margin-top: 6px; }
  #explanation { margin-top: 4px; }

  #answers .answer-option::before {
    width: 20px;
    height: 20px;
    font-size: 12px;
    left: 10px;
  }

  /* Волшебник/пузырь — компактнее */
  #toc-wizard img {
    width: 44px;
  }

  #wizard-bubble {
    font-size: 10px;
    padding: 6px 8px;
  }
  /* Чтобы кнопки не были слишком маленькие */
  .move-btn {
    min-width: 46%;
    flex: 1 1 auto;
  }

  #move-counter {
   display: none;
  }
#intro-text p {
    margin: 6px 0;
    font-size: 12px;
    line-height: 1.3;
    text-indent: 0;
  }

  /* Оглавление: чуть компактнее текст */
  #toc .toc-item-main {
    font-size: 13px;
  }
  #toc .toc-item-sub {
    font-size: 11px;
  }
}

/* ===== MOBILE TOC: скрыто, но доступно через кнопку ===== */
.toc-toggle-btn {
  display: none; /* на десктопе не показываем */
}

/* Оверлей (затемнение фона) */
.toc-overlay {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.55);
  backdrop-filter: blur(2px);
  z-index: 9998;
}

/* Мобильная логика: оглавление становится выезжающей панелью */
@media (max-width: 900px) {
  .toc-toggle-btn {
    display: flex;
    position: sticky;
    width: calc(100% - 32px); /* чтобы совпасть с вашим padding: 0 12px у #layout */
    top: 8px;
    z-index: 9999;
    margin: 8px 12px 0;
    align-items: center;
    justify-content: center;

    padding: 10px 14px;
    border-radius: 12px;
    border: 1px solid rgba(15, 23, 42, 0.18);
    background: #ffffff;
    text-transform: uppercase;
    color: var(--btn-text);
    letter-spacing: 0.06em;
    font-weight: 700;
    cursor: pointer;

  }

  /* Превращаем #toc в выезжающее меню */
  #toc {
    position: fixed;
    top: 0;
    left: 0;
    height: 100dvh;      /* корректнее на мобилках */
    width: min(92vw, 420px);
    max-width: 420px;

    background: #f7f7fb;
    border-right: 1px solid #e5e7eb;
    padding: 12px 12px 16px;

    z-index: 9999;

    /* скрыто по умолчанию */
    transform: translateX(-105%);
    transition: transform 0.2s ease;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }

  /* когда открыто */
  body.toc-open #toc {
    transform: translateX(0);
  }

  body.toc-open .toc-overlay {
    display: block;
  }

  /* overlay виден только когда toc-open, иначе скрываем */
  .toc-overlay[hidden] {
    display: none;
  }

  /* чтобы остальной контент не “ездил” под меню */
  body.toc-open {
    overflow: hidden;
    touch-action: none;
  }
}

:root{
  /* Neutral “Apple-like” palette */
  --bg: #f5f5f7;
  --surface: rgba(255, 255, 255, 0.72);      /* glass surface */
  --surface-strong: rgba(255, 255, 255, 0.92);
  --text: #0b0b0f;
  --muted: rgba(11, 11, 15, 0.58);
  --hairline: rgba(11, 11, 15, 0.10);

  /* Accent */
  --accent: #0a84ff;                         /* iOS blue */
  --accent-weak: rgba(10, 132, 255, 0.16);

  /* Status */
  --good: #16a34a;
  --bad: #dc2626;

  /* Radii & spacing */
  --r-sm: 10px;
  --r-md: 14px;
  --r-lg: 18px;

  /* Shadows: very soft */
  --shadow-1: 0 1px 1px rgba(0,0,0,0.04), 0 8px 24px rgba(0,0,0,0.06);
  --shadow-2: 0 2px 2px rgba(0,0,0,0.06), 0 16px 36px rgba(0,0,0,0.10);

  /* Typography */
  --font: ui-sans-serif, system-ui, -apple-system, "SF Pro Display", "SF Pro Text", "Segoe UI", Roboto, Arial, sans-serif;
  --mono: ui-monospace, "SF Mono", Menlo, Monaco, Consolas, "Courier New", monospace;

  /* Focus ring */
  --focus: 0 0 0 3px var(--accent-weak);

/* === Glass + Arcana tokens (add to the end of your existing :root) === */
  --glass: rgba(255,255,255,0.62);
  --glass-strong: rgba(255,255,255,0.78);
  --glass-dark: rgba(17, 24, 39, 0.28);

  --blur: 14px;
  --sat: 140%;

  --stroke: rgba(255,255,255,0.40);
  --stroke-2: rgba(15, 23, 42, 0.10);

  --arcana-1: #7c3aed;   /* violet */
  --arcana-2: #0ea5e9;   /* cyan/sky */
  --arcana-3: #22c55e;   /* green spark */
  --arcana-glow: rgba(124, 58, 237, 0.35);
  --arcana-glow-2: rgba(14, 165, 233, 0.28);

  --bg-0: #070A12;
  --bg-1: #0b1020;
  --bg-2: #0b1224;

  --shadow-glass: 0 10px 30px rgba(0,0,0,0.18);
  --shadow-glow: 0 0 0 1px rgba(124,58,237,0.18), 0 14px 40px rgba(124,58,237,0.18);

  --radius-xl: 22px;

}
body::before{
  content:"";
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 0;

  /* very subtle "arcana dust" pattern */
  background-image:
    radial-gradient(circle at 20% 30%, rgba(255,255,255,0.10) 0 1px, transparent 2px),
    radial-gradient(circle at 70% 60%, rgba(255,255,255,0.08) 0 1px, transparent 2px),
    radial-gradient(circle at 40% 80%, rgba(255,255,255,0.06) 0 1px, transparent 2px);
  background-size: 240px 240px;
  opacity: 0.25;
  mix-blend-mode: screen;
  filter: blur(0.2px);
}


.next-quest-btn.is-shimmering{
  position: relative;
  border-color: rgba(47, 128, 255, 0.40);
  box-shadow:
    0 0 0 1px rgba(47, 128, 255, 0.20),
    0 14px 34px rgba(47, 128, 255, 0.22);
  animation: nextQuestGlow 1.25s ease-in-out infinite;
}

.next-quest-btn.is-shimmering::before{
  opacity: 1;
  animation: nextQuestShine 0.85s ease-out infinite;
}

@keyframes nextQuestGlow{
  0%{
    transform: translateY(0);
    filter: brightness(1);
  }
  50%{
    transform: translateY(-1px);
    filter: brightness(1.12);
  }
  100%{
    transform: translateY(0);
    filter: brightness(1);
  }
}


#board .square-55d63.tap-selected{
  box-shadow: inset 0 0 0 3px rgba(10, 132, 255, 0.85);
  background: radial-gradient(circle, rgba(10,132,255,0.18), transparent 70%);
}

#board .square-55d63.tap-legal{
  position: relative;
}

#board .square-55d63.tap-legal::after{
  content:"";
  position:absolute;
  left:50%;
  top:50%;
  width: 12px;
  height: 12px;
  transform: translate(-50%,-50%);
  border-radius: 999px;
  background: rgba(34, 197, 94, 0.92);
  box-shadow:
    0 0 0 3px rgba(34, 197, 94, 0.18),
    0 0 14px rgba(34, 197, 94, 0.35);
  pointer-events: none;
}

/* если это взятие — точка "кольцом" (необязательно, но удобно) */

#board .square-55d63.tap-capture::after{
  width: 14px;
  height: 14px;
  background: transparent;
  border: 3px solid rgba(239, 68, 68, 0.90);
  box-shadow:
    0 0 0 3px rgba(239, 68, 68, 0.12),
    0 0 14px rgba(239, 68, 68, 0.25);
}


/* Минималистичная кнопка "Режим выживания":
   при hover текст исчезает, появляется пульсирующая кардиограмма (ECG) */

#survival-btn{
  --accent: #9ca3af;
  --border: rgba(17, 24, 39, 0.14);

  position: relative;
  isolation: isolate;
  overflow: hidden;

  padding: 10px 14px;
  border-radius: 12px;

  border: 1px solid var(--border);
  background: #fff;
  color: #111827;

  font: 700 13px/1 system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  letter-spacing: .2px;

  cursor: pointer;
  transition: transform 120ms ease, border-color 150ms ease, box-shadow 150ms ease;
}

#survival-btn:hover{
  transform: translateY(-1px);
  border-color: rgba(156, 163, 175, 0.55);
  box-shadow: 0 8px 20px rgba(17, 24, 39, 0.08);
}

/* 1) На hover "прячем" текст (без изменения размеров кнопки) */
#survival-btn:hover,
#survival-btn:focus-visible{
  color: transparent;
}

/* 2) Кардиограмма поверх текста */
#survival-btn::after{
  content: "";
  position: absolute;
  inset: 0;
  pointer-events: none;

  opacity: 0;
  transform: scaleY(0.9);

  /* SVG-линия кардиограммы (data URI) */
  background-image: url("data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20160%2040'%3E%3Cpath%20d='M0%2020%20L18%2020%20L26%2012%20L34%2028%20L44%2020%20L60%2020%20L68%205%20L78%2035%20L90%2020%20L110%2020%20L118%2014%20L126%2026%20L136%2020%20L160%2020'%20fill='none'%20stroke='%239ca3af'%20stroke-width='3'%20stroke-linecap='round'%20stroke-linejoin='round'/%3E%3C/svg%3E");
  background-repeat: repeat-x;
  background-size: 160px 40px;
  background-position: 0 50%;

  /* мягкая подсветка */
  filter: drop-shadow(0 6px 10px rgba(156, 163, 175, 0.22));

  transition: opacity 140ms ease;
}

#survival-btn:hover::after,
#survival-btn:focus-visible::after{
  opacity: 1;
  animation: ecg-move 1500ms linear infinite, ecg-pulse 1500ms ease-in-out infinite;
}

/* Движение кардиограммы влево (как монитор) */
@keyframes ecg-move{
  from { background-position: 0 50%; }
  to   { background-position: -160px 50%; }
}

/* Лёгкая "пульсация" */
@keyframes ecg-pulse{
  0%, 100% { transform: scaleY(0.88); opacity: 0.95; }
  35%      { transform: scaleY(1.05); opacity: 1; }
  70%      { transform: scaleY(0.92); opacity: 0.98; }
}

/* Фокус для клавиатуры */
#survival-btn:focus-visible{
  outline: none;
  box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.18);
}

/* Уважение к prefers-reduced-motion */
@media (prefers-reduced-motion: reduce){
  #survival-btn:hover::after,
  #survival-btn:focus-visible::after{
    animation: none;
  }
}



/* ===== WELCOME AS MODAL ===== */
/* FIX: welcome-screen всегда на весь экран (и blur тоже) */
#welcome-screen{
  position: fixed;
  inset: 0;
  width: 100vw;
  height: 100vh;

  max-width: none;     /* важно: снимаем старое ограничение */
  margin: 0;           /* важно: убираем auto-центрирование */
  padding: 0;

  z-index: 10001;
  display: flex;
  align-items: center;
  justify-content: center;
  isolation: isolate;
}

#welcome-screen::before{
  content: "";
  position: absolute;
  inset: 0;
  z-index: -1;

  / светлая вуаль + лёгкая дымка /
  background:
    radial-gradient(circle at 30% 20%, rgba(255,255,255,0.70), rgba(255,255,255,0.35) 55%, rgba(255,255,255,0.22) 100%),
    linear-gradient(180deg, rgba(255,255,255,0.34), rgba(255,255,255,0.18));
backdrop-filter: blur(100px) saturate(140%) brightness(1.08);
-webkit-backdrop-filter: blur(28px) saturate(140%) brightness(1.08);

}

/* сама карточка */
#welcome-screen .welcome-card{
  width: min(720px, 100%);
  max-height: 90vh;
  overflow: auto;

  background: rgba(255,255,255,0.92);
  border: 1px solid rgba(148, 163, 184, 0.55);
  border-radius: 18px;
  box-shadow: 0 30px 80px rgba(0,0,0,0.45);
  padding: 18px 18px 22px;
}

/* можно чуть подправить текст внутри */
#welcome-screen h2{
  margin-top: 0;
}

/* Welcome wizard bubble */
.welcome-wizard{
  display: flex;
  align-items: flex-start;
  gap: 12px;
  margin-bottom: 14px;
}

.welcome-wizard img{
  width: 84px;
  height: auto;
  filter: drop-shadow(0 8px 14px rgba(15, 23, 42, 0.28));
  user-select: none;
  -webkit-user-drag: none;
}

.welcome-bubble{
  position: relative;
  flex: 1;
  padding: 12px 14px;
  border-radius: 14px;
  background: #ffffff;
  border: 1px solid rgba(148, 163, 184, 0.55);
  box-shadow: 0 2px 10px rgba(15, 23, 42, 0.08);
}

.welcome-bubble::before{
  content: '';
  position: absolute;
  left: -7px;
  top: 18px;
  width: 12px;
  height: 12px;
  background: #ffffff;
  border-left: 1px solid rgba(148, 163, 184, 0.55);
  border-bottom: 1px solid rgba(148, 163, 184, 0.55);
  transform: rotate(45deg);
}

.welcome-bubble-title{
  font-weight: 800;
  margin-bottom: 6px;
}

.welcome-bubble-text{
  font-size: 14px;
  line-height: 1.45;
  color: #0f172a;
}

/* Яркая синяя пульсация (привлекает внимание), с "аурой" вокруг */
#welcome-screen button{
  display: block;
  margin: 18px auto 0;
  padding: 12px 18px;

  font-size: 14px;
  font-weight: 800;
  letter-spacing: 0.4px;
  text-transform: none;

  color: #0f172a;
  background: rgba(255,255,255,0.92);
  border: 1px solid rgba(148, 163, 184, 0.55);
  border-radius: 14px;

  box-shadow: 0 8px 22px rgba(15, 23, 42, 0.14);
  text-shadow: none;

  cursor: pointer;
  position: relative;
  isolation: isolate;

  transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.15s ease, border-color 0.2s ease;
  animation: ctaPulse 1.8s ease-in-out infinite;
}

/* Внешняя аура */
#welcome-screen button::before{
  content: "";
  position: absolute;
  inset: -14px;
  border-radius: 20px;
  background: radial-gradient(closest-side,
    rgba(59, 130, 246, 0.55),
    rgba(59, 130, 246, 0.00) 70%
  );
  filter: blur(12px);
  opacity: 0.55;
  z-index: -1;
  pointer-events: none;
  animation: auraPulse 1.8s ease-in-out infinite;
}

/* Лёгкая "искринка" по краю */
#welcome-screen button::after{
  content: "";
  position: absolute;
  inset: -1px;
  border-radius: 15px;
  background: linear-gradient(135deg,
    rgba(96, 165, 250, 0.00) 0%,
    rgba(96, 165, 250, 0.55) 45%,
    rgba(96, 165, 250, 0.00) 70%
  );
  opacity: 0.0;
  filter: blur(0.3px);
  z-index: 0;
  pointer-events: none;
  transition: opacity 0.2s ease;
}

@keyframes ctaPulse{
  0%, 100%{
    border-color: rgba(148, 163, 184, 0.55);
    box-shadow:
      0 8px 22px rgba(15, 23, 42, 0.14),
      0 0 0 1px rgba(59, 130, 246, 0.12),
      0 0 18px rgba(59, 130, 246, 0.22);
    transform: translateY(0) scale(1);
  }
  50%{
    border-color: rgba(59, 130, 246, 0.70);
    box-shadow:
      0 12px 30px rgba(15, 23, 42, 0.18),
      0 0 0 2px rgba(59, 130, 246, 0.26),
      0 0 34px rgba(59, 130, 246, 0.55);
    transform: translateY(-1px) scale(1.02);
  }
}

@keyframes auraPulse{
  0%, 100%{
    opacity: 0.45;
    filter: blur(12px);
    transform: scale(0.98);
  }
  50%{
    opacity: 0.95;
    filter: blur(16px);
    transform: scale(1.03);
  }
}

#welcome-screen button:hover{
  background: rgba(255,255,255,0.98);
  transform: translateY(-1px) scale(1.02);
  border-color: rgba(59, 130, 246, 0.85);
  box-shadow:
    0 14px 34px rgba(15, 23, 42, 0.20),
    0 0 0 2px rgba(59, 130, 246, 0.30),
    0 0 42px rgba(59, 130, 246, 0.65);
}

#welcome-screen button:hover::before{
  opacity: 1;
}

#welcome-screen button:hover::after{
  opacity: 0.75;
}

#welcome-screen button:active{
  transform: translateY(0px) scale(0.99);
  box-shadow:
    0 6px 16px rgba(15, 23, 42, 0.12),
    0 0 0 2px rgba(59, 130, 246, 0.22),
    0 0 28px rgba(59, 130, 246, 0.45);
}

/* На всякий случай: уважение к "уменьшить анимации" */
@media (prefers-reduced-motion: reduce){
  #welcome-screen button,
  #welcome-screen button::before{
    animation: none;
  }
}
	



/* === Apple-like minimal TOC (override) === */

/* Токены (можно подстроить под твой :root) */
:root{
  --toc-bg: rgba(248, 248, 250, 0.92);
  --toc-border: rgba(0, 0, 0, 0.10);
  --toc-divider: rgba(0, 0, 0, 0.08);
  --toc-text: rgba(17, 24, 39, 0.92);
  --toc-muted: rgba(17, 24, 39, 0.58);

  --toc-accent: #0A84FF;              /* системный “iOS blue” */
  --toc-hover: rgba(10, 132, 255, 0.08);
  --toc-active-bg: rgba(10, 132, 255, 0.12);

  --toc-radius: 12px;
}

/* Контейнер TOC: меньше “карточности”, больше “sidebar” */
#toc{
  width: 320px;
  padding: 12px 12px;
  box-sizing: border-box;

  background: var(--toc-bg);
  border-right: 1px solid var(--toc-border);

  /* Apple обычно без тяжёлых теней в сайдбаре */
  box-shadow: none;

  /* Системный шрифт */
  font-family: ui-sans-serif, system-ui, -apple-system, "SF Pro Display", "SF Pro Text", "Segoe UI", Roboto, Arial, sans-serif;
  color: var(--toc-text);
}

/* Sticky заголовок: без градиента и сильного blur */
#toc h3{
  position: sticky;
  top: 0;
  margin: 0 0 10px;
  padding: 10px 2px 10px;

  font-size: 13px;
  font-weight: 600;
  letter-spacing: 0.2px;

  background: rgba(248, 248, 250, 0.88);
  backdrop-filter: saturate(160%) blur(8px);
  -webkit-backdrop-filter: saturate(160%) blur(8px);
  border-bottom: 1px solid var(--toc-divider);
  z-index: 1;
}

/* Группа: убрать glass/box-shadow, оставить аккуратный блок */
.toc-group{
  background: transparent;
  border: 0;
  box-shadow: none;
  backdrop-filter: none;
  -webkit-backdrop-filter: none;
  border-radius: var(--toc-radius);
  overflow: hidden; /* чтобы hover/active выглядели “чисто” */
}

/* Заголовок группы: спокойный, без ярких заливок */
.toc-group-title{
  padding: 10px 10px;
  font-size: 12px;
  font-weight: 600;
  color: var(--toc-muted);
  background: transparent;
}

/* Бейдж: лучше сделать нейтральным или убрать совсем */
.toc-group-title-badge{
  width: 8px;
  height: 8px;
  background: rgba(0, 0, 0, 0.18);
  box-shadow: none;
}

/* Иконка раскрытия: без “пилюли” и рамки */
.toc-group-toggle-icon{
  width: 18px;
  height: 18px;
  border-radius: 8px;
  border: 0;
  background: transparent;
  color: rgba(0,0,0,0.45);
}

/* Список внутри группы: тонкий разделитель */
.toc-group ol{
  margin: 0;
  padding: 6px 4px 10px 4px;
  list-style: none;
  border-top: 1px solid var(--toc-divider);
}

/* Пункты: без теней и “подпрыгивания” */
#toc .toc-item{
  border-radius: 10px;
  padding: 8px 10px;
  gap: 10px;

  background: transparent;
  box-shadow: none;
  transform: none;

  color: var(--toc-text);
  transition: background-color 0.12s ease, color 0.12s ease;
}

/* Номер: вместо яркого круга — спокойный “secondary” */
#toc .toc-item-number{
  width: 22px;
  height: 22px;
  border-radius: 7px;
  background: rgba(0,0,0,0.06);
  color: rgba(0,0,0,0.55);
  font-weight: 600;
}

/* Текст: чуть спокойнее, без лишних акцентов */
#toc .toc-item-main{
  font-size: 13px;
  font-weight: 600;
  letter-spacing: 0;
}

#toc .toc-item-sub{
  font-size: 12px;
  color: var(--toc-muted);
}

/* Hover: мягкая заливка, без glow/теней */
#toc .toc-item:hover{
  background: rgba(0, 0, 0, 0.04);
  box-shadow: none;
  transform: none;
}

#toc .toc-item:hover .toc-item-sub{
  color: var(--toc-muted);
}

#toc .toc-item:hover .toc-item-number{
  background: rgba(0,0,0,0.08);
  color: rgba(0,0,0,0.65);
}

/* Active: “Apple-паттерн” — тонкий индикатор + лёгкая заливка */
#toc .toc-item.active{
  background: var(--toc-active-bg);
  position: relative;
}

#toc .toc-item.active::before{
  content: "";
  position: absolute;
  left: 6px;
  top: 8px;
  bottom: 8px;
  width: 3px;
  border-radius: 2px;
  background: var(--toc-accent);
}

#toc .toc-item.active .toc-item-number{
  background: rgba(10,132,255,0.18);
  color: rgba(10,132,255,1);
}

#toc .toc-item.active .toc-item-sub{
  color: rgba(10,132,255,0.95);
}

/* Группа с активным элементом: лучше не подсвечивать всю группу */
.toc-group.has-active{
  border-color: transparent;
}

.toc-group.has-active .toc-group-title{
  color: rgba(0,0,0,0.65);
  background: transparent;
}


/* =========================
   APPLE-LIKE QUESTIONS UI
   (add at the VERY END of <style>)
   ========================= */

:root{
  --qa-bg: rgba(248, 248, 250, 0.92);
  --qa-border: rgba(0, 0, 0, 0.10);
  --qa-divider: rgba(0, 0, 0, 0.08);
  --qa-text: rgba(17, 24, 39, 0.92);
  --qa-muted: rgba(17, 24, 39, 0.58);

  /* subtle iOS-like selection */
  --qa-active: rgba(0, 0, 0, 0.055);
}

#question-block{
  width: 340px;
  padding: 12px 12px;
  box-sizing: border-box;

  background: var(--qa-bg);
  border: 1px solid var(--qa-border);
  border-radius: 12px;
  box-shadow: none;

  color: var(--qa-text);
}

#intro-text h2,
#question-title{
  margin: 6px 0 8px;
  font-size: 15px;
  font-weight: 650;
  letter-spacing: 0.1px;
  color: var(--qa-text);
}

#question-text{
  margin: 0 0 10px;
  font-size: 13px;
  line-height: 1.35;
  color: var(--qa-muted);
}

/* Answers list */
#answers{
  margin-top: 10px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

/* Answer button — Apple-like row */
#answers .answer-option{
  position: relative;
  width: 100%;

  padding: 10px 12px 10px 42px;
  border-radius: 12px;

  background: transparent;
  border: 1px solid var(--qa-divider);

  color: var(--qa-text);
  font-size: 13px;
  line-height: 1.35;

  box-shadow: none;
  transform: none;

  transition: background-color 0.12s ease, border-color 0.12s ease;
}

/* Letter badge: neutral, not bright blue */
#answers .answer-option::before{
  content: attr(data-letter);
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);

  width: 22px;
  height: 22px;
  border-radius: 7px;

  background: rgba(0,0,0,0.06);
  color: rgba(0,0,0,0.60);

  display: flex;
  align-items: center;
  justify-content: center;

  font-size: 12px;
  font-weight: 650;
}

/* Hover: same calm light gray as in Apple sidebar */
#answers .answer-option:hover:not(:disabled),
#answers .answer-option:focus-visible:not(:disabled){
  background: rgba(0,0,0,0.04);
  border-color: rgba(0,0,0,0.12);
  outline: none;
}

/* Correct/incorrect — subtle, not кислотный */
#answers .answer-option.correct{
  background: rgba(34, 197, 94, 0.10);
  border-color: rgba(34, 197, 94, 0.28);
}

#answers .answer-option.incorrect{
  background: rgba(239, 68, 68, 0.10);
  border-color: rgba(239, 68, 68, 0.28);
}

#status{
  margin-top: 10px;
  font-weight: 600;
  font-size: 13px;
  color: var(--qa-text);
}

#explanation{
  margin-top: 6px;
  font-size: 12.5px;
  color: var(--qa-muted);
}


/* =========================
   TOC ACTIVE: remove blue indicator, make Apple-like selection
   (add at the VERY END of <style>)
   ========================= */

#toc .toc-item.active::before{
  display: none !important;
  content: none !important;
}

/* Replace blue selection with subtle Apple gray */
#toc .toc-item.active{
  background: rgba(0,0,0,0.055) !important;
}

#toc .toc-item.active .toc-item-number{
  background: rgba(0,0,0,0.08) !important;
  color: rgba(0,0,0,0.70) !important;
}

#toc .toc-item.active .toc-item-sub{
  color: rgba(17, 24, 39, 0.58) !important;
}









  </style>
</head>
<body>
  <h1>Шахматные квесты</h1>
<button id="toc-toggle-btn" class="toc-toggle-btn" aria-controls="toc" aria-expanded="false">
  Выбрать квест
</button>
<div id="toc-overlay" class="toc-overlay" hidden></div>

  <div id="victory-effect"></div>

  <div id="gameover-overlay">
    <div id="gameover-content">
      <video
        id="gameover-video"
        src="RobertWeirde.mp4"
        autoplay
        playsinline
        controls
      ></video>

      <button id="gameover-restart-btn" class="restart-btn">
        Начать заново
      </button>
    </div>
  </div>

  <audio
    id="victory-sound"
    src="quest_success.mp3"
    preload="auto">
  </audio>

  <audio
    id="gameover-sound"
    src="gameover.mp3"
    preload="auto">
  </audio>

  <audio
    id="full-victory-sound"
    src="full_victory.mp3"
    preload="auto">
  </audio>

  <audio
    id="sound-right"
    src="sound_right.mp3"
    preload="auto">
  </audio>

  <audio
    id="sound-wrong"
    src="nope.mp3"
    preload="auto">
  </audio>

  <audio
    id="diamond-sound"
    src="diamond.mp3"
    preload="auto">
  </audio>

  <div id="welcome-screen">
<div class="welcome-card">
  <div class="welcome-wizard">
    <img src="wizard.png" alt="Маленький волшебник" />
    <div class="welcome-bubble">
      <div class="welcome-bubble-title">Добро пожаловать, мой друг!</div>
      <div class="welcome-bubble-text">
        В этом интерактиве представлены разборы легендарных шахматных партий в формате квеста.
        В ключевые моменты партии тебе будут заданы вопросы на позиционное понимание и на тактику.
        В конце каждой партии мы посчитаем итоговое количество очков. В путь!
      </div>

    <button id="start-quest-btn" class="start-quest-btn">Начать квест</button>
   </div>
  </div>
    </div>
  </div>

  <div id="layout" style="display:grid;">

    <div id="toc">
      <h3>Оглавление партий</h3>

      <!-- Итальянский романтизм -->
      <div class="toc-group collapsed">
        <div class="toc-group-title">
          <div class="toc-group-title-left">
            <span class="toc-group-title-badge"></span>
            <span class="toc-group-title-text">Итальянский романтизм (1620-1850)</span>
          </div>
          <span class="toc-group-toggle-icon">›</span>
        </div>
        <ol id="toc-greco-list">
          <li>
            <button class="toc-item" data-game-index="0">
              <span class="toc-item-number">1</span>
              <span class="toc-item-text">
                <span class="toc-item-main">Джоакино Греко – NN</span>
                <span class="toc-item-sub">Лондон, 1623 · Быстрый мат в дебюте</span>
              </span>
            </button>
          </li>
          <li>
            <button class="toc-item" data-game-index="1">
              <span class="toc-item-number">2</span>
              <span class="toc-item-text">
                <span class="toc-item-main">Джоакино Греко – NN</span>
                <span class="toc-item-sub">ок. 1620 · Атака на короля в центре</span>
              </span>
            </button>
          </li>
          <li>
            <button class="toc-item" data-game-index="2">
              <span class="toc-item-number">3</span>
              <span class="toc-item-text">
                <span class="toc-item-main">Джоакино Греко – NN</span>
                <span class="toc-item-sub">ок. 1620 · Жертва слона на h7</span>
              </span>
            </button>
          </li>
          <li>
            <button class="toc-item" data-game-index="3">
              <span class="toc-item-number">4</span>
              <span class="toc-item-text">
                <span class="toc-item-main">NN – Джоакино Греко</span>
                <span class="toc-item-sub">ок. 1620 · Атака ферзём и конём</span>
              </span>
            </button>
          </li>

          <!-- НОВАЯ ПАРТИЯ: ЛА БУРДОННЕ – МАКДОННЕЛЛ -->
          <li>
            <button class="toc-item" data-game-index="4">
              <span class="toc-item-number">5</span>
              <span class="toc-item-text">
                <span class="toc-item-main">Александер Макдоннелл – Л. де Ла Бурдонне</span>
                <span class="toc-item-sub">Лондон, 1834 · Классический сицилианский штурм</span>
              </span>
            </button>
          </li>

          <!-- БЕССМЕРТНАЯ (Андерссен – Кизерицкий) -->
          <li>
            <button class="toc-item" data-game-index="5">
              <span class="toc-item-number">6</span>
              <span class="toc-item-text">
                <span class="toc-item-main">Адольф Андерссен – Лионель Кизерицкий</span>
                <span class="toc-item-sub">Лондон, 1851 · Бессмертная партия</span>
              </span>
            </button>
          </li>

          <li>
            <button class="toc-item" data-game-index="6">
              <span class="toc-item-number">7</span>
              <span class="toc-item-text">
                <span class="toc-item-main">Адольф Андерссен – Жан Дюфресн</span>
                <span class="toc-item-sub">Берлин, 1852 · Жертва качества и атака в Эвансе</span>
              </span>
            </button>
          </li>
        </ol>
      </div>

      <!-- Орлеанский волшебник -->
      <div class="toc-group collapsed">
        <div class="toc-group-title">
          <div class="toc-group-title-left">
            <span class="toc-group-title-badge"></span>
            <span class="toc-group-title-text">Пол Чарльз Морфи (1850-1860-е)</span>
          </div>
          <span class="toc-group-toggle-icon">›</span>
        </div>
        <ol id="toc-morphy-list">
          <li>
            <button class="toc-item" data-game-index="7">
              <span class="toc-item-number">8</span>
              <span class="toc-item-text">
                <span class="toc-item-main">Пол Морфи – Консультанты</span>
                <span class="toc-item-sub">Оперная партия, 1858 · Классическая атака</span>
              </span>
            </button>
          </li>
          <li>
            <button class="toc-item" data-game-index="8">
              <span class="toc-item-number">9</span>
              <span class="toc-item-text">
                <span class="toc-item-main">Луи Паульсен – Пол Морфи</span>
                <span class="toc-item-sub">Нью-Йорк, 1857 · Жертва ферзя в атаке</span>
              </span>
            </button>
          </li>
          <li>
            <button class="toc-item" data-game-index="9">
              <span class="toc-item-number">10</span>
              <span class="toc-item-text">
                <span class="toc-item-main">Сент-Аман / де Бастеро – Пол Морфи</span>
                <span class="toc-item-sub">Париж, 1858 · Консультативная партия</span>
              </span>
            </button>
          </li>
          <li>
            <button class="toc-item" data-game-index="10">
              <span class="toc-item-number">11</span>
              <span class="toc-item-text">
                <span class="toc-item-main">Джон В. Шультен – Пол Морфи</span>
                <span class="toc-item-sub">Нью-Йорк, 1857 · Гамбит короля с атакой Морфи</span>
              </span>
            </button>
          </li>
        </ol>
      </div>

      <!-- Стейниц и претенденты -->
      <div class="toc-group collapsed">
        <div class="toc-group-title">
          <div class="toc-group-title-left">
            <span class="toc-group-title-badge"></span>
            <span class="toc-group-title-text">Стейниц и претенденты (1860-1890-е)</span>
          </div>
          <span class="toc-group-toggle-icon">›</span>
        </div>
        <ol id="toc-steinitz-list">
          <li>
            <button class="toc-item" data-game-index="11">
              <span class="toc-item-number">12</span>
              <span class="toc-item-text">
                <span class="toc-item-main">Исидор Гунсберг – Михаил Чигорин</span>
                <span class="toc-item-sub">Гавана, 1890 · Динамическая защита в испанской партии</span>
              </span>
            </button>
          </li>
          <li>
            <button class="toc-item" data-game-index="12">
              <span class="toc-item-number">13</span>
              <span class="toc-item-text">
                <span class="toc-item-main">Чигорин – Поллок</span>
                <span class="toc-item-sub">Нью-Йорк, 1889 · Прорыв, жертва и атака</span>
              </span>
            </button>
          </li>
          <li>
            <button class="toc-item" data-game-index="13">
              <span class="toc-item-number">14</span>
              <span class="toc-item-text">
                <span class="toc-item-main">М. Чигорин – В. Стейниц</span>
                <span class="toc-item-sub">Гавана, 1892 · Матч на первенство мира</span>
              </span>
            </button>
          </li>
          <li>
            <button class="toc-item" data-game-index="14">
              <span class="toc-item-number">15</span>
              <span class="toc-item-text">
                <span class="toc-item-main">В. Стейниц - А. Зельман</span>
                <span class="toc-item-sub">Балтимор, 1885 · Позиционная игра</span>
              </span>
            </button>
          </li>
        </ol>
      </div>

<!-- Ласкер и современники -->
<div class="toc-group collapsed">
  <div class="toc-group-title">
    <div class="toc-group-title-left">
      <span class="toc-group-title-badge"></span>
      <span class="toc-group-title-text">Ласкер и современники (1890-1920-е)</span>
    </div>
    <span class="toc-group-toggle-icon">›</span>
  </div>
  <ol id="toc-lasker-list">
    <li>
      <button class="toc-item" data-game-index="15">
        <span class="toc-item-number">16</span>
        <span class="toc-item-text">
          <span class="toc-item-main">Эм. Ласкер – И. Бауэр</span>
          <span class="toc-item-sub">пример · Тема атаки на короля</span>
        </span>
      </button>
    </li>
  </ol>
</div>


<!-- Капабланка. Простота и Гармония -->
<div class="toc-group collapsed">
  <div class="toc-group-title">
    <div class="toc-group-title-left">
      <span class="toc-group-title-badge"></span>
      <span class="toc-group-title-text">Капабланка. Простота и Гармония</span>
    </div>
    <span class="toc-group-toggle-icon">›</span>
  </div>
  <ol id="toc-capablanca-list">
    <li>
      <button class="toc-item" data-game-index="16">
        <span class="toc-item-number">17</span>
        <span class="toc-item-text">
          <span class="toc-item-main">Х.Р. Капабланка – Ф.Д. Маршалл</span>
          <span class="toc-item-sub">Испанская партия, интересный план</span>
        </span>
      </button>
    </li>
  </ol>
</div>

<!-- Алехин. Глубина и динамика -->
<div class="toc-group collapsed">
  <div class="toc-group-title">
    <div class="toc-group-title-left">
      <span class="toc-group-title-badge"></span>
      <span class="toc-group-title-text">Алехин. Глубина и динамика</span>
    </div>
    <span class="toc-group-toggle-icon">›</span>
  </div>
  <ol id="toc-alekhine-list">
    <li>
      <button class="toc-item" data-game-index="17">
        <span class="toc-item-number">18</span>
        <span class="toc-item-text">
          <span class="toc-item-main">Алехин-Капабланка</span>
          <span class="toc-item-sub">Комбинация, динамические шахматы</span>
        </span>
      </button>
    </li>
  </ol>
</div>


<!-- Эйве. Метод и логика -->
<div class="toc-group collapsed">
  <div class="toc-group-title">
    <div class="toc-group-title-left">
      <span class="toc-group-title-badge"></span>
      <span class="toc-group-title-text">Эйве. Метод и логика</span>
    </div>
    <span class="toc-group-toggle-icon">›</span>
  </div>
  <ol id="toc-eywe-list">
    <li>
      <button class="toc-item" data-game-index="19">
        <span class="toc-item-number">20</span>
        <span class="toc-item-text">
          <span class="toc-item-main">Эйве-Алехин</span>
          <span class="toc-item-sub">Методичность, рациональные шахматы</span>
        </span>
      </button>
    </li>
  </ol>
</div>


<!-- Ботвинник. Асфальтоукладочный каток -->
<div class="toc-group collapsed">
  <div class="toc-group-title">
    <div class="toc-group-title-left">
      <span class="toc-group-title-badge"></span>
      <span class="toc-group-title-text">Ботвинник. Асфальтоукладочный каток</span>
    </div>
    <span class="toc-group-toggle-icon">›</span>
  </div>
  <ol id="toc-botvinnik-list">
    <li>
      <button class="toc-item" data-game-index="20">
        <span class="toc-item-number">21</span>
        <span class="toc-item-text">
          <span class="toc-item-main">Ботвинник - Капабланка</span>
          <span class="toc-item-sub">Сеанс одновременной игры</span>
        </span>
      </button>
    </li>
  </ol>
</div>
<div id="survival-controls">
          <button id="survival-btn">
            <span class="survival-text">Режим выживания</span>
            <span class="survival-ecg"></span>
          </button>

          <div id="lives-container" aria-label="Жизни">
            <span class="life-heart" data-life="1">♥</span>
            <span class="life-heart" data-life="2">♥</span>
            <span class="life-heart" data-life="3">♥</span>
          </div>
        </div>





      <!-- Остальные партии (пока пусто, резерв для будущих добавлений) -->
      <ol id="toc-list"></ol>
    </div>


    <div id="quest-container">
      <div id="board-column">
        <div id="board-wrapper">
          <div id="board"></div>
	<div id="move-controls">
          <button id="prev-move-btn" class="move-btn">
            <span class="icon">←</span>
            <span>Назад</span>
          </button>
          <span id="move-counter"></span>
          <button id="next-move-btn" class="move-btn">
            <span>Вперёд</span>
            <span class="icon">→</span>
          </button>
        </div>
          <svg id="board-arrow-layer">
            <defs>
              <marker id="board-arrow-head-marker"
                      class="board-arrow-head"
                      markerWidth="10"
                      markerHeight="10"
                      refX="5"
                      refY="3"
                      orient="auto"
                      markerUnits="strokeWidth">
                <path d="M0,0 L8,3 L0,6 z"></path>
              </marker>
            </defs>
          </svg>

          <button id="flip-board-btn" title="Перевернуть доску">⇄</button>
          <div id="resize-board-handle" title="Потяните, чтобы изменить размер доски"></div>
        </div>
	
        <div id="notation-block">
          <div id="notation-content"></div>
        </div>
      </div>

      <div id="question-block">
        <div id="intro-text"></div>        

        <h2 id="question-title" style="display:none;"></h2>
        <p id="question-text" style="display:none;"></p>
        <div id="answers"></div>

        <div id="toc-wizard">
          <div id="toc-wizard-inner">
            <img
              id="toc-wizard-img"
              src="wizard.png"
              alt="Маленький волшебник" />
            <div id="wizard-bubble" aria-live="polite" aria-atomic="true">
              <div id="wizard-bubble-text">Я буду комментировать выбранные ходы!</div>
            </div>
          </div>
        </div>

        <div id="score">
          <span id="score-value">Очки: 0</span>
        </div>

        <div id="progress-container" style="display:none;">
          <div id="progress-label"></div>
          <div id="progress-track">
            <div id="progress-bar"></div>
          </div>
        </div>

        <div id="status"></div>
        <div id="explanation"></div>

        <button id="next-btn" style="display:none;">Дальше</button>

        
      </div>
    </div>
  </div>

  <div id="era-progress">
    <div id="era-progress-header">
      <span>XVII век · Романтизм</span>
      <span>XXI век · Современные шахматы</span>
    </div>
    <div id="era-progress-track">
      <div id="era-progress-fill"></div>
      <img id="era-progress-thumb" src="DeLorean.png" alt="Машина времени DeLorean">
    </div>
    <div id="era-progress-current"></div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const gamesData = [
        {
          id: 'greco1',
          title: 'Партия 1. Джоакино Греко – NN, Лондон 1623',
          introParagraphs: [
            'Наше путешествие мы начнём с 17 века - ',
            'Белые быстро открывают линии против короля и используют неудачное расположение чёрных фигур, чтобы поставить мат уже на 8‑м ходу.',
            'Попробуй сам(а) найти ключевые удары Греко за белых.'
          ],
          pgn: `
[Event "London"]
[Site "London ENG"]
[Date "1623.??.??"]
[EventDate "?"]
[Round "?"]
[Result "1-0"]
[White "Gioachino Greco"]
[Black "NN"]
[ECO "B00"]
[WhiteElo "?"]
[BlackElo "?"]
[PlyCount "15"]

1.e4 b6 2.d4 Bb7 3.Bd3 f5 4.exf5 Bxg2 5.Qh5+ g6 6.fxg6 Nf6
7.gxh7 Nxh5 8.Bg6# 1-0
          `.trim(),
          keyMoments: [
            {
              index: 2,
              question: 'Какой лучший развивающий ход за белых?',
              correctMoveSan: 'd4',
              options: ['d4', 'Nf3', 'Bc4', 'Nc3'],
              explanations: {
                'd4': 'Захватываем центр!',
                'Nf3': 'Стандартное развитие.',
                'Bc4': 'Стандартное развитие.',
                'Nc3': 'Стандартное развитие.'
              }
            },
            {
              index: 6,
              question: 'Позиция после 3...f5. Как Греко наказывает преждевременное продвижение пешки f у чёрных?',
              correctMoveSan: 'exf5',
              options: ['exf5', 'Nc3', 'Qe2', 'Nf3'],
              explanations: {
                'exf5': '4.exf5! — сразу подрываем пешку f и открываем линию e. Чёрные ослабили короля — пора вскрывать центр.',
                'Nc3': '4.Nc3 развивает фигуру, но не использует слабость пешки f и короля в центре.',
                'Qe2': '4.Qe2 выглядит аккуратно, но отдаёт инициативу и не раскрывает позицию соперника.',
                'Nf3': '4.Nf3 — нормальное развитие, но тактический ресурс 4.exf5! здесь намного сильнее.'
              }
            },
            {
              index: 8,
              type: 'manual',
              question: 'Какой ход наилучший?',
              correctMoveSan: 'Qh5+',
              points: 2,
              explanations: {
                'Qh5+': '5.Qh5+! — классический шах по диагонали, сразу атакуя короля и пешку h7. Начинается форсированная охота на чёрного короля.',
              }
            },
            {
              index: 12,
              type: 'manual',
              question: 'Какой ход наилучший?',
              correctMoveSan: 'gxh7+',
              points: 3,
              explanations: {
                'gxh7+': 'Ход, ведущий к победе.',
              }
            },
            {
              index: 14,
              type: 'manual',
              question: 'Найдите победу!',
              correctMoveSan: 'Bg6#',
              points: 2,
              explanations: {
                'Bg6#': '8.Bg6# — изящный мат слоном: король g8 заперт своими фигурами и пешками, все поля бегства контролируются.',
              }
            }
          ]
        },

        {
          id: 'greco2',
          title: 'Партия 2. Джоакино Греко – NN, ок. 1620 (атака на короля в центре)',
          introParagraphs: [
            'Во второй миниатюре Греко демонстрирует типичное наказание за ход 2...f6?! в открытых дебютах.',
            'Белые вскрывают центр, выманивают короля на e7–f7–g6–h6 и заканчивают атаку красивым матом в углу.',
            'Проследи, как каждое темповое нападение ферзём и слоном ведёт короля всё дальше от безопасных полей.'
          ],
          pgn: `
[Event "Miscellaneous Game"]
[Site "?"]
[Date "1620.??.??"]
[EventDate "?"]
[Round "24"]
[Result "1-0"]
[White "Gioachino Greco"]
[Black "NN"]
[ECO "C40"]
[WhiteElo "?"]
[BlackElo "?"]
[PlyCount "21"]

1.e4 e5 2.Nf3 f6 3.Nxe5 fxe5 4.Qh5+ Ke7 5.Qxe5+ Kf7 6.Bc4+ Kg6
7.Qf5+ Kh6 8.d4+ g5 9.h4 Kg7 10.Qf7+ Kh6 11.hxg5# 1-0
          `.trim(),
          keyMoments: [
            {
              index: 4,
              question: 'После 2...f6?! чёрные ослабили диагональ a2–g8 и поле h5. Как Греко немедленно наказывает этот ход?',
              correctMoveSan: 'Nxe5',
              options: ['Nxe5', 'd4', 'Bc4', 'Nc3'],
              explanations: {
                'Nxe5': '3.Nxe5! — классический тактический удар: белые жертвуют коня, вскрывая диагональ и атакуя слабые поля вокруг короля.',
                'd4': '3.d4 — логичный дебютный ход, но тактика 3.Nxe5! здесь намного сильнее и конкретнее.',
                'Bc4': '3.Bc4 развивает слона, но упускает возможность сразу захватить инициативу жертвой на e5.',
                'Nc3': '3.Nc3 — обычное развитие, без использования грубого ослабления 2...f6?.'
              }
            },
            {
              index: 6,
              question: 'После 3...fxe5 белые уже отдали коня. Как продолжить атаку на короля в центре?',
              correctMoveSan: 'Qh5+',
              options: ['Qh5+', 'Bc4', 'd4', 'Qf3'],
              explanations: {
                'Qh5+': '4.Qh5+! — немедленный шах, выманивающий короля в центр и подготавливающий Bc4+ с дальнейшей атакой.',
                'Bc4': '4.Bc4+ тоже даёт шах, но Qh5+ точнее: ферзь сразу давит на e5 и h7.',
                'd4': '4.d4 — логичный подрыв центра, но не использует тактических ресурсов против короля.',
                'Qf3': '4.Qf3 атакует пешку e5, но без темпа на короля — Греко играет гораздо энергичнее.'
              }
            },
            {
              index: 12,
              question: 'Король чёрных уже забрёл на g6 после 6...Kg6. Как Греко продолжает «загонять» его по доске?',
              correctMoveSan: 'Qf5+',
              options: ['Qf5+', 'Qf4', 'Qg3', 'h4'],
              explanations: {
                'Qf5+': '7.Qf5+! — точный шах с угрозой Qf7+ и матовых сеток. Король вынужден идти на h6, ещё дальше от центра.',
                'Qf4': '7.Qf4+ тоже шах, но после Kh5 король уходит из-под основных угроз.',
                'Qg3': '7.Qg3 даёт шах, но оставляет королю больше полей для бегства.',
                'h4': '7.h4 — полезный ход для будущей атаки, но сначала полезнее продолжить серию шахов ферзём.'
              }
            },
            {
              index: 20,
              question: 'После 10...Kh6 король загнан в угол и почти лишён полей. Как Греко завершает комбинацию?',
              correctMoveSan: 'hxg5#',
              options: ['hxg5#', 'Qf6+', 'Qf8+', 'Qh5+'],
              explanations: {
                'hxg5#': '11.hxg5# — красивый мат пешкой: король h6 окружён собственными фигурами и под боем белых.',
                'Qf6+': '11.Qf6+ продолжает атаку, но упускает возможность немедленного мата.',
                'Qf8+': '11.Qf8+ выглядит эффектно, но после Kg6 мат откладывается.',
                'Qh5+': '11.Qh5+ — ещё один шах, но Греко видит прямой мат 11.hxg5#.'
              }
            }
          ]
        },

        {
          id: 'greco3',
          title: 'Партия 3. Джоакино Греко – NN, ок. 1620 (жертва слона на h7)',
          introParagraphs: [
            'В этой миниатюре Греко образцово проводит атаку на рокировавшего коротко короля.',
            'Белые подготавливают прорыв e5, затем жертвуют слона на h7 и организуют сильнейшую атаку на короля.',
            'Обрати внимание, как ферзь и пешки поддерживают слона и коня, создавая неотразимую матовую сеть.'
          ],
          pgn: `
[Event "Miscellaneous Game"]
[Site "?"]
[Date "1620.??.??"]
[EventDate "?"]
[Round "25"]
[Result "1-0"]
[White "Gioachino Greco"]
[Black "NN"]
[ECO "C01"]
[WhiteElo "?"]
[BlackElo "?"]
[PlyCount "23"]

1.e4 e6 2.d4 Nf6 3.Bd3 Nc6 4.Nf3 Be7 5.h4 O-O 6.e5 Nd5 7.Bxh7+
Kxh7 8.Ng5+ Bxg5 9.hxg5+ Kg8 10.Qh5 f5 11.g6 Re8 12.Qh8# 1-0
          `.trim(),
          keyMoments: [
            {
              index: 8,
              question: 'Чёрные собираются рокировать в короткую сторону. Какое энергичное продолжение выбирает Греко, чтобы начать атаку на короля?',
              correctMoveSan: 'h4',
              options: ['h4', 'O-O', 'Nc3', 'c3'],
              explanations: {
                'h4': '5.h4! — сразу начинаем пешечную атаку на короля. План h5–Qg4/Qh5 очень типичен против короткой рокировки.',
                'O-O': '5.O-O — надёжно, но слишком спокойно: чёрные успеют рокировать и укрепиться.',
                'Nc3': '5.Nc3 развивает фигуру, но не ставит непосредственных проблем королю соперника.',
                'c3': '5.c3 подготавливает центр, однако атакующие ресурсы на королевском фланге здесь важнее.'
              }
            },
            {
              index: 10,
              question: 'Чёрные только что рокировали в короткую сторону. Как белые немедленно вскрывают позицию короля?',
              correctMoveSan: 'e5',
              options: ['e5', 'Ng5', 'c3', 'Be3'],
              explanations: {
                'e5': '6.e5! — мощный ход: выгоняем коня f6 с защиты h7 и выигрываем темп на развитие атаки.',
                'Ng5': '6.Ng5 выглядит грозно, но конкретно сильнее сначала прогнать коня ходом e5.',
                'c3': '6.c3 — слишком медленно, чёрные успевают перегруппироваться.',
                'Be3': '6.Be3 развивает слона, но не использует момент, пока конь f6 уязвим для хода e5.'
              }
            },
            {
              index: 12,
              question: 'После 6...Nd5 конь ушёл, и поле h7 ослаблено. Как Греко жертвует материал ради атаки на короля?',
              correctMoveSan: 'Bxh7+',
              options: ['Bxh7+', 'Ng5', 'c4', 'Qe2'],
              explanations: {
                'Bxh7+': '7.Bxh7+! — классическая жертва слона на h7. Король вынужден выйти на h7 и попадает под мощную атаку.',
                'Ng5': '7.Ng5 угрожает матом, но жертва 7.Bxh7+! конкретнее и сильнее с точки зрения форсированной атаки.',
                'c4': '7.c4 не несёт прямых угроз королю, упуская тактический момент.',
                'Qe2': '7.Qe2 улучшает позицию ферзя, но даёт чёрным время укрепить короля.'
              }
            },
            {
              index: 22,
              question: 'После 11...Re8 король чёрных зажат на g8. Найди мат в один ход за Греко.',
              correctMoveSan: 'Qh8#',
              options: ['Qh8#', 'Qh7+', 'Qf7+', 'Qh6'],
              explanations: {
                'Qh8#': '12.Qh8# — точный мат: ферзь добирается до угла, король g8 лишён полей из‑за собственного расположения фигур и пешек.',
                'Qh7+': '12.Qh7+ — всего лишь шах, чёрные могут закрыться или уйти королём.',
                'Qf7+': '12.Qf7+ — красивый шах, но до мата ещё далеко, в отличие от Qh8#.',
                'Qh6': '12.Qh6 усиливает давление, но упускает немедленный мат Qh8#.'
              }
            }
          ]
        },

        {
          id: 'greco4',
          title: 'Партия 4. NN – Джоакино Греко, ок. 1620 (атака ферзём и конём)',
          introParagraphs: [
            'Теперь посмотрим на атаку Греко за чёрных в спокойной итальянской партии.',
            'Чёрные аккуратно заканчивают развитие, затем вскрывают центр ходом ...exd4 и бросают в атаку ферзя и коня.',
            'Обрати внимание, как идея Qh4, Qxf2+ и Qg1+ приводит к изящному мату конём на f2.'
          ],
          pgn: `
[Event "Miscellaneous Game"]
[Site "?"]
[Date "1620.??.??"]
[EventDate "?"]
[Round "12"]
[Result "0-1"]
[White "NN"]
[Black "Gioachino Greco"]
[ECO "C50"]
[WhiteElo "?"]
[BlackElo "?"]
[PlyCount "26"]

1.e4 e5 2.Nf3 Nc6 3.Bc4 Bc5 4.O-O Nf6 5.Re1 O-O 6.c3 Qe7 7.d4
exd4 8.e5 Ng4 9.cxd4 Nxd4 10.Nxd4 Qh4 11.Nf3 Qxf2+ 12.Kh1 Qg1+
13.Nxg1 Nf2# 0-1
          `.trim(),
          keyMoments: [
            {
              index: 15,
              question: 'Белые только что пошли 8.e5, атакуя коня f6. Как Греко отвечает, сохраняя инициативу и усиливая давление на короля?',
              correctMoveSan: 'Ng4',
              options: ['Ng4', 'Ne8', 'Nd5', 'Nh5'],
              explanations: {
                'Ng4': '8...Ng4! — активный отступ: конь смотрит на f2 и h2, готовя типичную атаку ферзём и конём.',
                'Ne8': '8...Ne8 — пассивно: конь отходит назад, атака белых усиливается.',
                'Nd5': '8...Nd5? попадает под e6 и теряет координацию.',
                'Nh5': '8...Nh5 переводит коня на край доски без конкретных угроз.'
              }
            },
            {
              index: 17,
              question: 'После 9.cxd4 белые взяли пешкой на d4. Как чёрные используют открывшийся центр и ослабление поля d4?',
              correctMoveSan: 'Nxd4',
              options: ['Nxd4', 'Bb6', 'Re8', 'd6'],
              explanations: {
                'Nxd4': '9...Nxd4! — конь занимает мощный центральный пункт и вскрывает диагональ ферзю для прыжка на h4.',
                'Bb6': '9...Bb6 — просто отход слона, без конкретных угроз.',
                'Re8': '9...Re8 выглядит логично, но чёрные упускают сильный активный ход Nxd4.',
                'd6': '9...d6 — укрепляет центр, но не использует тактические возможности позиции.'
              }
            },
            {
              index: 19,
              question: 'Белые отбили коня ходом 10.Nxd4. Как Греко начинает прямую атаку на короля?',
              correctMoveSan: 'Qh4',
              options: ['Qh4', 'Qf6', 'd6', 'Re8'],
              explanations: {
                'Qh4': '10...Qh4! — типичный ход: ферзь прицеливается к f2 и h2, создавая угрозы матовой сети.',
                'Qf6': '10...Qf6 активен, но не так конкретен, как Qh4 с атакой на короля.',
                'd6': '10...d6 слишком спокойно для такой острой позиции.',
                'Re8': '10...Re8 развивает ладью, но здесь важно атаковать короля немедленно.'
              }
            },
            {
              index: 21,
              question: 'После 11.Nf3 белые защитили h2 и f2 конём. Как чёрные жертвуют материал, чтобы взорвать прикрытие короля?',
              correctMoveSan: 'Qxf2+',
              options: ['Qxf2+', 'Qh5', 'Qf2+', 'Qh6'],
              explanations: {
                'Qxf2+': '11...Qxf2+! — жертва ферзя на f2, открывающая короля и подготавливающая мотив Qg1+ и мат конём.',
                'Qh5': '11...Qh5 усиливает давление, но не использует конкретную возможность жертвы на f2.',
                'Qf2+': '11...Qf2+ — несуществующий ход: поле f2 уже занято фигурой.',
                'Qh6': '11...Qh6 уводит ферзя от короля, ослабляя атаку.'
              }
            },
            {
              index: 25,
              question: 'После 13.Nxg1 белые вроде бы съели ферзя. Как Греко завершает комбинацию за чёрных?',
              correctMoveSan: 'Nf2#',
              options: ['Nf2#', 'Nf2+', 'Nf6', 'Qh4'],
              explanations: {
                'Nf2#': '13...Nf2# — изящный мат конём: король h1 окружён своими фигурами, все поля бегства под боем.',
                'Nf2+': '13...Nf2+ обозначает шах, но в позиции уже мат: знак # обязателен.',
                'Nf6': '13...Nf6 упускает немедленный мат.',
                'Qh4': 'Ферзя у чёрных уже нет — он был отдан на f2.'
              }
            }
          ]
        },

        /* ===== НОВАЯ ПАРТИЯ: ЛА БУРДОННЕ – МАКДОННЕЛЛ, ЛОНДОН 1834 ===== */
        {
          id: 'labourdonnais_mcdonnell_1834',
          title: 'Партия 5. Александер Макдоннелл – Л. де Ла Бурдонне, Лондон 1834',
          introParagraphs: [
            'Один из самых известных поединков матча Макдоннелл – Ла Бурдонне в Лондоне 1834 года.',
            'Возникает ранний сицилианский с резким захватом пространства чёрными: Ла Бурдонне продвигает пешки ферзевого фланга, вторгается d4–d3 и создаёт проходную «монстра».',
            'Проследи, как чёрные шаг за шагом усиливают давление по центральным и ферзевым линиям и в итоге проводят пешку до превращения.'
          ],
          pgn: `
[Event "La Bourdonnais - McDonnell 4th Casual Match"]
[Site "London ENG"]
[Date "1834.??.??"]
[EventDate "1834.04.04"]
[Round "16"]
[Result "0-1"]
[White "Alexander McDonnell"]
[Black "Louis Charles Mahe De La Bourdonnais"]
[ECO "B32"]
[WhiteElo "?"]
[BlackElo "?"]
[PlyCount "74"]

1.e4 c5 2.Nf3 Nc6 3.d4 cxd4 4.Nxd4 e5 5.Nxc6 bxc6 6.Bc4 Nf6
7.Bg5 Be7 8.Qe2 d5 9.Bxf6 Bxf6 10.Bb3 O-O 11.O-O a5 12.exd5
cxd5 13.Rd1 d4 14.c4 Qb6 15.Bc2 Bb7 16.Nd2 Rae8 17.Ne4 Bd8
18.c5 Qc6 19.f3 Be7 20.Rac1 f5 21.Qc4+ Kh8 22.Ba4 Qh6 23.Bxe8
fxe4 24.c6 exf3 25.Rc2 Qe3+ 26.Kh1 Bc8 27.Bd7 f2 28.Rf1 d3
29.Rc3 Bxd7 30.cxd7 e4 31.Qc8 Bd8 32.Qc4 Qe1 33.Rc1 d2 34.Qc5
Rg8 35.Rd1 e3 36.Qc3 Qxd1+ 37.Rxd1 e2 0-1
          `.trim(),
          keyMoments: [
            {
              index: 8,
              question: 'После 4...e5 чёрные захватывают пространство в центре и выгоняют коня d4. Как белым лучше всего отреагировать?',
              correctMoveSan: 'Nxc6',
              options: ['Nxc6', 'Nb5', 'Nf3', 'Ne2'],
              explanations: {
                'Nxc6': '5.Nxc6! — конкретный ход: белые меняют активного коня на c6, ослабляя пешечную структуру чёрных (двойные пешки «с»–«b»).',
                'Nb5': '5.Nb5?! отходит назад, не нанося вреда лагерю чёрных.',
                'Nf3': '5.Nf3 — пассивный отход, позволяющий чёрным безнаказанно держать пешку e5.',
                'Ne2': '5.Ne2 уводит коня слишком далеко от центра и не пользуется тактическими мотивами.'
              }
            },
            {
              index: 16,
              question: 'Чёрные только что сыграли 8...d5, подрывая центр. Как белые могут немедленно воспользоваться тем, что слон f6 оказался под боем?',
              correctMoveSan: 'Bxf6',
              options: ['Bxf6', 'exd5', 'Nc3', 'Rd1'],
              explanations: {
                'Bxf6': '9.Bxf6! — точный размен: белые забирают активного слона, ослабляя контроль чёрных над центром и полем d5.',
                'exd5': '9.exd5?! позволяет чёрным после cxd5 сохранить сильного слона f6.',
                'Nc3': '9.Nc3 — обычное развитие, но здесь есть конкретный ресурс: Bxf6.',
                'Rd1': '9.Rd1 — полезно, но недостаточно конкретно против последнего хода чёрных.'
              }
            },
            {
              index: 26,
              question: 'После 13...d4 чёрные захватывают пространство и продвигают пешку вперёд. Как белые пытаются ограничить эту пешку и фигуры чёрных?',
              correctMoveSan: 'c4',
              options: ['c4', 'a4', 'Nd2', 'Qf3'],
              explanations: {
                'c4': '14.c4! — логичный ход: белые фиксируют пешку d4, ограничивая её подвижность и закрывая линию "c" от тяжёлых фигур чёрных.',
                'a4': '14.a4 не решает проблему пешки d4 и даёт чёрным время развить фигуры.',
                'Nd2': '14.Nd2 всё ещё пассивно — центр и ферзевый фланг требуют немедленного решения.',
                'Qf3': '14.Qf3 нападает на пешку d5, но чёрные легко защищаются и сохраняют инициативу.'
              }
            },
            {
              index: 40,
              question: 'Ходом 20...f5 чёрные резко усилили давление на центр и поле e4. Какую главную идею реализует этот ход?',
              correctMoveSan: 'f5',
              options: ['f5', 'g5', 'h5', 'Rac8'],
              explanations: {
                'f5': '20...f5! — ключевой подрыв: чёрные захватывают пространство на королевском фланге и подготавливают продвижение e4 с атакой на короля.',
                'g5': '20...g5? ослабляет короля и не даёт такой центральной динамики, как f5.',
                'h5': '20...h5 лишь продвигает крайнюю пешку без серьёзных угроз.',
                'Rac8': '20...Rac8 — логичное развитие, но чёрные могут играть гораздо энергичнее в центре.'
              }
            },
            {
              index: 52,
              question: 'После 27.Bd7 у чёрных уже есть проходная пешка "d" далеко продвинутая вперёд. Как они усиливают давление и готовят проход пешки ещё дальше?',
              correctMoveSan: 'd3',
              options: ['d3', 'Qe1', 'Qe2', 'Rd8'],
              explanations: {
                'd3': '28...d3! — пешка становится настоящим монстром: она связывает фигуры белых и готова пройти вплоть до превращения.',
                'Qe1': '28...Qe1+ — шах возможен, но продвижение пешки d куда опаснее.',
                'Qe2': '28...Qe2?! нападает на пешку, но не использует силу проходной d3.',
                'Rd8': '28...Rd8 — просто развитие, без немедленной конкретики.'
              }
            },
            {
              index: 60,
              question: 'После 33.Rc1 чёрные уже подвели все фигуры к полю d2. Какой ход решает исход партии в их пользу?',
              correctMoveSan: 'd2',
              options: ['d2', 'Qe4', 'Rf8', 'Qg3'],
              explanations: {
                'd2': '33...d2! — решающий рывок: пешка практически превращается в ферзя, и белые не в силах её остановить без потери материала.',
                'Qe4': '33...Qe4+ даёт шах, но не столь форсирован, как продвижение d2.',
                'Rf8': '33...Rf8 — слишком медленный ход; положение пешки d уже созрело для прорыва.',
                'Qg3': '33...Qg3 создаёт угрозы, но не решает партию немедленно.'
              }
            }
          ]
        },

        /* ===== ПАРТИЯ: АНДЕРССЕН – КИЗЕРИЦКИЙ, БЕССМЕРТНАЯ ===== */
        {
          id: 'anderssen_kieseritzky_1851',
          title: 'Партия 6. Адольф Андерссен – Лионель Кизерицкий, Лондон 1851 (Бессмертная партия)',
          introParagraphs: [
            'Перед тобой одна из самых знаменитых партий в истории — Бессмертная партия Андерссена против Кизерицкого.',
            'Белые жертвуют сначала фигуру, затем обе ладьи и, наконец, ферзя, чтобы поставить мат оставшимися лёгкими фигурами.',
            'Обрати внимание, как Андерссен шаг за шагом выводит фигуры к королю соперника и постоянно открывает линии. В ключевых моментах остановимся и попробуем найти его ходы.'
          ],
          pgn: `
[Event "Casual game"]
[Site "London ENG"]
[Date "1851.06.21"]
[EventDate "?"]
[Round "?"]
[Result "1-0"]
[White "Adolf Anderssen"]
[Black "Lionel Adalbert Bagration Felix Kieseritzky"]
[ECO "C33"]
[WhiteElo "?"]
[BlackElo "?"]
[Source "La Régence, v3 n7, July 1851, pp221-222"]
[SourceNote "ends 19.Ke2"]
[Source2 "The Chess Player, vol.i no.1, 1851.07.19, p.2"]
[PlyCount "45"]

1.e4 e5 2.f4 exf4 3.Bc4 Qh4+ 4.Kf1 b5 5.Bxb5 Nf6 6.Nf3 Qh6
7.d3 Nh5 8.Nh4 Qg5 9.Nf5 c6 10.g4 Nf6 11.Rg1 cxb5 12.h4 Qg6
13.h5 Qg5 14.Qf3 Ng8 15.Bxf4 Qf6 16.Nc3 Bc5 17.Nd5 Qxb2 18.Bd6
Bxg1 19.e5 Qxa1+ 20.Ke2 Na6 21.Nxg7+ Kd8 22.Qf6+ Nxf6
23.Be7# 1-0
          `.trim(),
          keyMoments: [
            {
              index: 8,
              question: 'После 4...b5 чёрные атакуют слона c4 и пытаются захватить инициативу. Как Андерссен реагирует на этот вызов?',
              correctMoveSan: 'Bxb5',
              options: ['Bxb5', 'Bd5', 'Bb3', 'Qf3'],
              explanations: {
                'Bxb5': '5.Bxb5! — спокойно съедаем пешку, не давая чёрным захватить пространство и сохраняя давление по диагонали a4–e8.',
                'Bd5': '5.Bd5?! уходит от нападения, но теряет важную пешку b5 и темп.',
                'Bb3': '5.Bb3 — пассивный отход, позволяющий чёрным укрепить ферзевый фланг.',
                'Qf3': '5.Qf3 выглядит активно, но пешку b5 всё равно лучше забрать немедленно.'
              }
            },
            {
              index: 18,
              question: 'После 9...c6 чёрные готовят подрыв в центре и хотят прогнать коня f5. Какое энергичное продолжение выбирают белые?',
              correctMoveSan: 'g4',
              options: ['g4', 'Qf3', 'Nc3', 'Nd6+'],
              explanations: {
                'g4': '10.g4! — типичный атакующий приём в гамбите короля: белые захватывают пространство на королевском фланге и выгоняют коня f6.',
                'Qf3': '10.Qf3 давит на f4, но не использует момент для захвата пространства ходом g4.',
                'Nc3': '10.Nc3 — нормальное развитие, но атакующий ресурс g4 намного острее.',
                'Nd6+': '10.Nd6+ выглядит эффектно, но после Bxd6 у белых просто не хватает компенсации.'
              }
            },
            {
              index: 22,
              question: 'После 11...cxb5 чёрные отъели пешку и получили лишний материал. Как Андерссен начинает новый этап атаки на короля?',
              correctMoveSan: 'h4',
              options: ['h4', 'Qf3', 'Nc3', 'Qe2'],
              explanations: {
                'h4': '12.h4! — ещё один пешечный штурм: белые открывают линии для ладьи g1 и ферзя, готовя h5–g5.',
                'Qf3': '12.Qf3 развивает ферзя, но не вскрывает дополнительных линий против короля чёрных.',
                'Nc3': '12.Nc3 спокойно развивает коня, но атака пешками здесь важнее.',
                'Qe2': '12.Qe2 — аккуратно, но слишком медленно для такой резкой позиции.'
              }
            },
            {
              index: 28,
              question: 'После 14...Ng8 чёрные отводят коня и вроде бы защищают короля. Как белые немедленно используют ослабление диагонали a4–e8 и центральных полей?',
              correctMoveSan: 'Bxf4',
              options: ['Bxf4', 'Qf4', 'Re1', 'Kg2'],
              explanations: {
                'Bxf4': '15.Bxf4! — слон выходит с темпом, забирая пешку f4 и усиливая давление на диагонали a4–e8 и b8–h2.',
                'Qf4': '15.Qf4 тоже съедает пешку, но развивать фигуру с темпом обычно лучше, чем ходить ферзём.',
                'Re1': '15.Re1 — полезно, но не так конкретно, как немедленный удар Bxf4.',
                'Kg2': '15.Kg2 — профилактика, которая не использует тактических возможностей позиции.'
              }
            },
            {
              index: 34,
              question: 'После 17...Qxb2 чёрные схватили пешку на b2, но король остаётся в центре. Какое сильное продолжение находит Андерссен?',
              correctMoveSan: 'Bd6',
              points: 3,
              options: ['Bd6', 'Re1', 'Qe2', 'Nd6+'],
              explanations: {
                'Bd6': '18.Bd6! — мощный ход: слон вторгается в лагерь соперника, ограничивает короля и готовит решающую атаку по диагонали a3–f8.',
                'Re1': '18.Re1 — логичный ход, но после Bd6! атака развивается куда быстрее и конкретнее.',
                'Qe2': '18.Qe2 спокойнее, однако не создаёт такой жёсткой связки и давления, как Bd6!.',
                'Nd6+': '18.Nd6+ выглядит эффектно, но после Bxd6 чёрные разменяют активную фигуру белых и частично разрядят напряжение.'
              }
            },
            {
              index: 42,
              question: 'После 21...Kd8 король чёрных ушёл на d8. Какой точный ход завершает подготовку к финальной комбинации?',
              correctMoveSan: 'Qf6+',
              options: ['Qf6+', 'Qg2', 'Qf3', 'Qe2'],
              explanations: {
                'Qf6+': '22.Qf6+! — ключевой шах: король вынужден бить коня на f6, после чего следует матовая атака.',
                'Qg2': '22.Qg2 сохраняет давление, но не форсирует события так сильно, как Qf6+.',
                'Qf3': '22.Qf3 — просто усиление, без форсированных угроз.',
                'Qe2': '22.Qe2 выглядит аккуратно, но момент для решающего удара уже настал.'
              }
            }
          ]
        },

        {
          id: 'anderssen_dufresne_1852',
          title: 'Партия 7. Адольф Андерссен – Жан Дюфресн, Берлин 1852 (Эванс‑гамбит)',
          introParagraphs: [
            'Классическая романтическая атака Андерссена в гамбите Эванса. Белые жертвуют пешку и вскоре качеством ради мощной инициативы.',
            'Обрати внимание, как Андерссена использует развитие фигур и каждое ослабление чёрных, чтобы добраться до короля.',
            'Попробуем найти ключевые жертвы — особенно удары Nf6+ и Rxe7+.'
          ],
          pgn: `
[Event "Berlin GER"]
[Site "Berlin GER"]
[Date "1852.??.??"]
[EventDate "?"]
[Round "?"]
[Result "1-0"]
[White "Adolf Anderssen"]
[Black "Jean Dufresne"]
[ECO "C52"]
[WhiteElo "?"]
[BlackElo "?"]
[PlyCount "47"]

1.e4 e5 2.Nf3 Nc6 3.Bc4 Bc5 4.b4 Bxb4 5.c3 Ba5 6.d4 exd4 7.O-O d3
8.Qb3 Qf6 9.e5 Qg6 10.Re1 Nge7 11.Ba3 b5 12.Qxb5 Rb8 13.Qa4 Bb6
14.Nbd2 Bb7 15.Ne4 Qf5 16.Bxd3 Qh5 17.Nf6+ gxf6 18.exf6 Rg8
19.Rad1 Qxf3 20.Rxe7+ Nxe7 21.Qxd7+ Kxd7 22.Bf5+ Ke8 23.Bd7+ Kf8
24.Bxe7# 1-0
          `.trim(),
          keyMoments: [
            {
              index: 8,
              question: 'После 4...Bxb4 чёрные приняли гамбит Эванса. Как белые логично продолжают развитие и борьбу за центр?',
              correctMoveSan: 'c3',
              options: ['c3', 'O-O', 'Bb2', 'a3'],
              explanations: {
                'c3': '5.c3! — типичный ход в гамбите Эванса: белые выгоняют слона с b4 и подготавливают мощный центр d4–e4.',
                'O-O': '5.O-O безопасно, но темп на слона b4 и борьба за центр здесь важнее.',
                'Bb2': '5.Bb2 слишком пассивно: слон упирается в пешку e5, а центр ещё не занят.',
                'a3': '5.a3 даёт темп, но не готовит прорыв в центре так чётко, как c3.'
              }
            },
            {
              index: 14,
              question: 'После 7...d3 чёрные хотят удержать лишнюю пешку. Как Андерссен усиливает давление на королевский фланг и пешку f7?',
              correctMoveSan: 'Qb3',
              options: ['Qb3', 'Ng5', 'Re1', 'Ba3'],
              explanations: {
                'Qb3': '8.Qb3! — классический ход в Эвансе: ферзь давит на f7 и b7, создавая сразу несколько угроз.',
                'Ng5': '8.Ng5 выглядит грозно, но без давления на f7 и b7 конкретных угроз меньше.',
                'Re1': '8.Re1 — полезное усиление, но можно сразу прицелиться к f7 ходом Qb3.',
                'Ba3': '8.Ba3?! слишком рано: сначала лучше ударить по слабостям f7 и b7.'
              }
            },
            {
              index: 16,
              question: 'После 8...Qf6 белые могут захватить инициативу в центре. Как они играют?',
              correctMoveSan: 'e5',
              options: ['e5', 'Ng5', 'Bd5', 'Nbd2'],
              explanations: {
                'e5': '9.e5! — ход с темпом на ферзя: белые выигрывают пространство и вскрывают диагонали для слона c4 и ферзя b3.',
                'Ng5': '9.Ng5 — типичный прыжок коня, но ход e5 с выигрышем темпа ещё сильнее.',
                'Bd5': '9.Bd5?! нападает на ферзя, но перекрывает собственную диагональ a2–g8.',
                'Nbd2': '9.Nbd2 — спокойное развитие, но здесь позиция требует энергичной игры в центре.'
              }
            },
            {
              index: 22,
              question: 'После 11...b5? чёрные ослабили ферзевый фланг. Как Андерссен немедленно использует это ослабление?',
              correctMoveSan: 'Qxb5',
              options: ['Qxb5', 'Bd5', 'Ng5', 'Rad1'],
              explanations: {
                'Qxb5': '12.Qxb5! — простое и сильное опровержение: белые забирают пешку, атакуют ладью a8 и сохраняют инициативу.',
                'Bd5': '12.Bd5 выглядит активно, но проигрывает конкретный тактический ресурс Qxb5!.',
                'Ng5': '12.Ng5 — красивый ход, но пешку на b5 лучше забрать сразу.',
                'Rad1': '12.Rad1 — развитие без прямого использования ошибки b5?.'
              }
            },
            {
              index: 32,
              type: 'manual',
              question: 'После 16...Qh5 у белых есть сильная жертва, разрушающая королевский фланг чёрных. Найдите её за белых.',
              correctMoveSan: 'Nf6+',
              points: 3,
              explanations: {
                'Nf6+': '17.Nf6+! — удар по королю: жертва коня вскрывает диагональ a3–f8 и линию g, чёрный король становится крайне уязвим.'
              }
            },
            {
              index: 38,
              type: 'manual',
              question: 'После 19...Qxf3 белые могут провести решающую жертву качества. Какой ход сыграл Андерссен?',
              correctMoveSan: 'Rxe7+',
              points: 3,
              explanations: {
                'Rxe7+': '20.Rxe7+! — блестящая жертва качества: король чёрных вытягивается на d7 и попадает под решающую атаку ладьи и слона.'
              }
            }
          ]
        },

        {
          id: 'game1',
          title: 'Партия 8. Пол Морфи – герцог Карл / граф Изуар (Оперная партия)',
          introParagraphs: [
            'Перед тобой легендарная оперная партия Морфи, сыгранная против двух консультантов — герцога Карла и графа Изуара. Это один из самых наглядных примеров быстрой и мощной атаки развитием.',
            'Ты увидишь, как Морфи жертвует материал, открывает линии против короля и использует каждую темповую возможность. В ключевые моменты мы остановимся и ты попробуешь сам найти сильнейшее продолжение.',
            'Следи за гармонией фигур: почти каждая жертва Морфи основана на том, что его армия развивается быстрее и активнее. Попробуем понять его замысел шаг за шагом.'
          ],
          pgn: `
[Event "Opera"]
[Site "Paris"]
[Date "1858.??.??"]
[Round "?"]
[White "Paul Morphy"]
[Black "Duke Karl / Count Isouard"]
[Result "1-0"]

1. e4 e5 2. Nf3 d6 3. d4 Bg4 4. dxe5 Bxf3
5. Qxf3 dxe5 6. Bc4 Nf6 7. Qb3 Qe7 8. Nc8 c6
9. Bg5 b5 10. Nxb5 cxb5 11. Bxb5+ Nbd7 12. O-O-O
Rd8 13. Rxd7 Rxd7 14. Rd1 Qe6 15. Bxd7+ Nxd7
16. Qb8+ Nxb8 17. Rd8# 1-0
          `.trim(),
          keyMoments: [
            {
              index: 4,
              question: 'Какой ход белых самый сильный?',
              correctMoveSan: 'd4',
              options: ['d4', 'Nc3', 'Bb5+'],
              explanations: {
                'd4': 'Самое решительное и сильное продолжение.',
                'Nc3': 'Обычный развивающий ход, достаточно медлительный здесь.',
                'Bb5+': 'Этот ход не дает белым ничего, только потерю темпа после 3...c6.'
              }
            },
            {
              index: 8,
              question: 'Чем взять на f3?',
              correctMoveSan: 'Qxf3',
              options: ['gxf3', 'Qxf3'],
              explanations: {
                'Qxf3': 'Развиваем ферзя и сохраняем пешечную структуру.',
                'gxf3': 'Ход не самый лучший. Разрушается пешечная структура. Что если я захочу рокироваться?'
              }
            },
            {
              index: 10,
              question: 'Как бы ты продолжил развитие?',
              correctMoveSan: 'Bc4',
              options: ['Bc4', 'Nc3', 'Be3'],
              explanations: {
                'Bc4': 'В данной позиции самый лучший развивающий ход. Ход с нападением на мат!',
                'Nc3': 'Неплохо, но можно лучше.',
                'Be3': 'Неплохо, но можно лучше.'
              }
            },
            {
              index: 12,
              question: 'Найди самый сильный ход.',
              type: 'manual',
              correctMoveSan: 'Qb3',
              points: 3,
              explanations: {
                'Qb3': 'Отличный двойной удар на b7 и f7. А еще получилась неплохая пушка!',
              }
            },
            {
              index: 16,
              question: 'Как продолжить развитие?',
              type: 'manual',
              correctMoveSan: 'Bg5',
              explanations: {
                'Bg5': 'Сильный развивающий ход со связкой.',
              }
            },
            {
              index: 18,
              question: 'Как гений атаки Пол Морфи продолжает в этой позиции?',
              correctMoveSan: 'Nxb5',
              points: 3,
              options: ['Nxb5', 'Be2', 'Bxf7+', 'Bd5'],
              explanations: {
                'Nxb5': '10.Nxb5! — типичная жертва фигуры на b5. Белые разрушают пешечный щит, открывают диагонали для слона c4 и ферзя b3 и вскоре возвращают материал с мощной атакой.',
                'Be2': 'Отступление слоном выглядит безопасно, но уводит фигуру с атаки и позволяет чёрным спокойно развиваться. Морфи предпочитает немедленно вскрыть позицию.',
                'Bxf7+': 'Кто-то зевнул слона, ай-ай-ай.',
              }
            },
            {
              index: 22,
              question: 'Как бы ты продолжил в этой позиции?',
              type: 'manual',
              points: 2,
              correctMoveSan: 'O-O-O',
              explanations: {
                'O-O-O': 'Абсолютно сильнейшее продолжение. Улучшается король, ладья сразу захватывает линию, усиливается связка коня на d7.',
              }
            },
            {
              index: 24,
              question: 'Черные построили неприступную крепость. Однако действительно ли она неприступна? Какое сильное решение принимает Морфи?',
              correctMoveSan: 'Rxd7',
              options: ['Rxd7', 'Bxf6', 'Qd3', 'Rhe1'],
              points: 3,
              explanations: {
                'Rxd7': '13.Rxd7!! — знаменитая жертва ладьи. Ощутимый удар по защите, скоро крепость падет.',
                'Bxf6': 'Взятие на f6 дает пространство. Морфи предпочитает действовать по линии d, где король чёрных уязвим.',
                'Qd3': 'Это усиление связки ни к чему не приводит. Ищи другие пути.',
                'Rhe1': 'Спокойное усиление, но слишком медленное. Морфи наказывает нерокированного короля максимально быстро.'
              }
            },
            {
              index: 26,
              question: 'Кого-то не хватает в атаке. Кого?',
              type: 'manual',
              correctMoveSan: 'Rd1',
              points: 2,
              explanations: {
                'Rd1': 'Мощное усиление связки. Все в сборе.',
              }
            },
            {
              index: 28,
              question: 'Выбери лучший вариант.',
              correctMoveSan: 'Bxd7+',
              options: ['Qxe6+', 'Bxd7+'],
              explanations: {
                'Bxd7+': 'Разрушаем защиту! Ферзей не меняем!',
                'Qxe6+': 'В атаке ферзей не меняем.',
              }
            },
            {
              index: 30,
              question: 'После 15...Nxd7 белые уже отдали ладью и слона. Какой ход завершает комбинацию Морфи?',
              type: 'manual',
              correctMoveSan: 'Qb8+',
              points: 3,
              explanations: {
                'Qb8+': 'Блестящий ход, ведущий к мату.',
              }
            },
            {
              index: 32,
              question: 'Заверши эту партию.',
              type: 'manual',
              correctMoveSan: 'Rd8#',
              explanations: {
                'Rd8#': 'Обрати внимание на гармонию белых фиигур. Торжество духа над материей.',
              }
            }
          ]
        },

        {
          id: 'game2',
          title: 'Партия 9. Луи Паульсен – Пол Морфи, Нью-Йорк 1857 (жертва ферзя)',
          introParagraphs: [
            'Во второй партии мы переносимся на Первый Американский шахматный конгресс в Нью-Йорке 1857 года. Луи Паульсен — один из сильнейших защитников того времени, а Пол Морфи демонстрирует свой фирменный атакующий стиль.',
            'Кульминацией партии становится эффектная жертва ферзя Морфи ради атаки на короля. Важно понять, как он сначала подводит фигуры к королю белых, а уже потом решается отдать главный материал ради форсированного разгрома.',
            'Обрати особое внимание на координацию фигур чёрных: практически каждая тяжёлая фигура и лёгкая фигура Морфи участвуют в атаке.'
          ],
          pgn: `
[Event "1st American Chess Congress"]
[Site "New York, NY USA"]
[Date "1857.11.03"]
[EventDate "1857.??.??"]
[Round "4.6"]
[Result "0-1"]
[White "Louis Paulsen"]
[Black "Paul Morphy"]
[ECO "C48"]
[WhiteElo "?"]
[BlackElo "?"]
[PlyCount "56"]
1. e4 e5 2. Nf3 Nc6 3. Nc3 Nf6 4. Bb5 Bc5 5. O-O O-O 6. Nxe5
Re8 7. Nxc6 dxc6 8. Bc4 b5 9. Be2 Nxe4 10. Nxe4 Rxe4 11. Bf3
Re6 12. c3 Qd3 13. b4 Bb6 14. a4 bxa4 15. Qxa4 Bd7 16. Ra2
Rae8 17. Qa6 Qxf3 18. gxf3 Rg6+ 19. Kh1 Bh3 20. Rd1 Bg2+ 21. Kg1
Bxf3+ 22. Kf1 Bg2+ 23. Kg1 Bh3+ 24. Kh1 Bxf2 25. Qf1 Bxf1 26. Rxf1
Re2 27. Ra1 Rh6 28. d4 Rxh2+ 0-1
          `.trim(),
          keyMoments: []
        },

        {
          id: 'game5',
          title: 'Партия 10. Сент-Аман / де Бастеро – Пол Морфи, Париж 1858 (консультативная)',
          introParagraphs: [
            'Пятая партия — ещё один шедевр Морфи в консультативном формате.',
            'В дебюте возникает классическая итальянская партия, и Морфи образцово играет против центра белых.',
            'Обрати внимание, как чёрные используют развитие, давление по диагонали a7–g1 и слабости тёмных полей.'
          ],
          pgn: `
[Event "Consultation game"]
[Site "Paris FRA"]
[Date "1858.11.??"]
[EventDate "1858.11.??"]
[Round "?"]
[Result "0-1"]
[White "Saint Amant / Marie Florimond de Basterot"]
[Black "Paul Morphy"]
[ECO "C54"]
[WhiteElo "?"]
[BlackElo "?"]
[Source "The Field, 1858.11.27, p.428"]
[PlyCount "44"]

1. e4 e5 2. Nf3 Nc6 3. Bc4 Bc5 4. c3 Nf6 5. d4 exd4 6. cxd4
Bb4+ 7. Bd2 Bxd2+ 8. Nbxd2 d5 9. exd5 Nxd5 10. O-O O-O 11. h3
Nf4 12. Kh2 Nxd4 13. Nxd4 Qxd4 14. Qc2 Qd6 15. Kh1 Qh6 16. Qc3
Bf5 17. Kh2 Rad8 18. Rad1 Bxh3 19. gxh3 Rd3 20. Qxd3 Nxd3
21. Bxd3 Qd6+ 22. f4 Qxd3 0-1
          `.trim(),
          keyMoments: [
            {
              index: 11,
              question: 'После 6.cxd4 найдите лучшее продолжение за чёрных.',
              correctMoveSan: 'Bb4+',
              options: ['Be7', 'Bb6', 'Bb4+', 'Bxd4'],
              explanations: {
                'Be7': 'Слишком пассивный отход: белые получают инициативу в центре.',
                'Bb6': 'Слон отступает без активной игры, позволяя белым спокойно развиваться.',
                'Bb4+': '6...Bb4+! — активное развитие с шахом, вынуждающее белых определиться и создающее давление.',
                'Bxd4': 'Отдавать слона за коня без нужды — позиционно сомнительно: у соперника остаётся пара слонов.'
              }
            },
            {
              index: 15,
              question: 'После 8.Nbxd2 каким ходом чёрные полностью уравнивают позицию и даже захватывают инициативу?',
              correctMoveSan: 'd5',
              options: ['O-O', 'd6', 'd5'],
              explanations: {
                'O-O': 'Простая рокировка, но после 9.e5 инициатива переходит к белым.',
                'd6': 'Слишком пассивно: белые могут захватить пространство ходом e5.',
                'd5': '8...d5! — ход-освобождение: чёрные решительно вскрывают центр и уравнивают игру.'
              }
            },
            {
              index: 21,
              question: 'После 11.h3 у чёрных есть сильный активный ход. Найдите его.',
              correctMoveSan: 'Nf4',
              options: ['Nf4', 'Qf6', 'Bf5'],
              explanations: {
                'Nf4': '11...Nf4! — конь устанавливается на мощный пункт, давит на h3 и g2 и готов поддержать атаку.',
                'Qf6': 'Ферзь на f6 выглядит активно, но конь на f4 объективно сильнее и устойчивее.',
                'Bf5': 'Развитие слона неплохо, но это не тот энергичный ход, который максимально использует положение белого короля.'
              }
            },
            {
              index: 33,
              question: 'Позиция после 17.Kh2. Найдите активный развивающий ход за чёрных.',
              correctMoveSan: 'Rad8',
              options: ['Rfe8', 'Rad8'],
              explanations: {
                'Rfe8': 'Ладья выходит, но контроль над линией d и давлением по диагонали не максимален.',
                'Rad8': '17...Rad8! — сильнее: ладья занимает открытую линию и прицеливается к коню d2 и полю d2.'
              }
            },
            {
              index: 35,
              type: 'manual',
              question: 'После 18.Rad1 найдите самый сильный ход за чёрных.',
              correctMoveSan: 'Bxh3',
              explanations: {
                'Bxh3': '18...Bxh3! — тактический удар по королю: разрушение прикрытия и вторжение тяжёлых фигур по линии g и диагонали.'
              }
            },
            {
              index: 37,
              type: 'manual',
              question: 'После 19.gxh3 найдите логичное продолжение комбинации.',
              correctMoveSan: 'Rd3',
              explanations: {
                'Rd3': '19...Rd3! — приём «перекрытие»: ладья вторгается на третью горизонталь, ограничивая координацию белых фигур.'
              }
            },
            {
              index: 41,
              type: 'manual',
              question: 'После 21.Bxd3 у чёрных есть финальный точный ход. Найдите его.',
              correctMoveSan: 'Qd6+',
              explanations: {
                'Qd6+': '21...Qd6+! — промежуточный шах с одновременной атакой на слона d3: чёрные забирают ещё и слона и остаются с лишним материалом.'
              }
            }
          ]
        },

        {
          id: 'game6',
          title: 'Партия 11. Джон В. Шультен – Пол Морфи, Нью-Йорк 1857 (гамбит короля)',
          introParagraphs: [
            'Шестая партия — динамичный гамбит короля против Пола Морфи. Белые жертвуют пешку ради инициативы, но Морфи хладнокровно принимает вызов.',
            'Обрати внимание, как чёрные используют темпы на развитие, вскрывают линии и постоянно создают угрозы королю белых.',
            'К кульминации партии Морфи жертвует качество, затем проводит мощную атаку с решающей матовой сетью.'
          ],
          pgn: `
[Event "New York"]
[Site "New York, NY USA"]
[Date "1857.??.??"]
[EventDate "1857.??.??"]
[Round "?"]
[Result "0-1"]
[White "John William Schulten"]
[Black "Paul Morphy"]
[ECO "C31"]
[WhiteElo "?"]
[BlackElo "?"]
[Source "Chess Monthly, vol.ii, January 1858, p.21"]
[PlyCount "46"]

1. e4 e5 2. f4 d5 3. exd5 e4 4. Nc3 Nf6 5. d3 Bb4 6. Bd2 e3
7. Bxe3 O-O 8. Bd2 Re8+ 9. Be2 Bxc3 10. bxc3 Bg4 11. c4 c6
12. dxc6 Nxc6 13. Kf1 Rxe2 14. Nxe2 Nd4 15. Qb1 Bxe2+ 16. Kf2
Ng4+ 17. Kg1 Nf3+ 18. gxf3 Qd4+ 19. Kg2 Qf2+ 20. Kh3 Qxf3+
21. Kh4 Ne3 22. Rg1 Nf5+ 23. Kg5 Qh5# 0-1
          `.trim(),
          keyMoments: [
            {
              index: 7,
              question: 'После ходов 1.e4 e5 2.f4 d5 3.exd5 e4 белые сыграли 4.Nc3. Какой естественный развивающий ход выбирает Морфи?',
              correctMoveSan: 'Nf6',
              points: 1,
              options: ['Nf6', 'Bb4', 'Qh4+', 'exd3'],
              explanations: {
                'Nf6': '4...Nf6 — простой и сильный ход: развитие фигуры с атакой на пешку d5 и давление в центре.',
                'Bb4': '4...Bb4+ возможно, но даёт белым темп на развитие с c3 или Bd2, не решая проблему развития коня g8.',
                'Qh4+': '4...Qh4+ — типичный мотив в гамбите короля, но здесь он преждевременен: белые могут спокойно закрыться g3 или Ke2.',
                'exd3': '4...exd3?! забирает пешку, но оставляет короля в центре и отстаёт в развитии.'
              }
            },
            {
              index: 11,
              question: 'После 5.d3 Морфи делает ход, усиливающий контроль над центром и создающий давление. Как он играет?',
              correctMoveSan: 'Bb4',
              points: 1,
              options: ['Bb4', 'exd3', 'Nxd5', 'Bg4'],
              explanations: {
                'Bb4': '5...Bb4! — активное развитие с шахом: чёрные связывают коня c3 и затрудняют развитие белых.',
                'exd3': '5...exd3?! — преждевременный обмен; лучше сначала вывести фигуры с темпом.',
                'Nxd5': '5...Nxd5? просто зевок: после dxe4 белые получают лучший центр.',
                'Bg4': '5...Bg4 возможно, но слон на b4 даёт шах и сильнее вмешивается в развитие белых.'
              }
            },
            {
              index: 12,
              question: 'После 6.Bd2 Морфи продолжает в духе «играть вперёд». Что он делает?',
              correctMoveSan: 'e3',
              points: 1,
              options: ['exd3', 'O-O', 'e3', 'c6'],
              explanations: {
                'e3': '6...e3! — мощный подрыв: пешка вторгается в лагерь белых, вскрывая диагональ a7–g1 и провоцируя ослабления.',
                'exd3': '6...exд3 даёт белым время укрепиться cxd3, и инициатива чёрных сдувается.',
                'O-O': '6...O-O — полезный ход, но Морфи предпочитает действовать сразу и конкретно в центре.',
                'c6': '6...c6 — подготовительный ход, но без прямого давления на короля.'
              }
            },
            {
              index: 16,
              question: 'После 8.Bd2 король чёрных уже в безопасности. Как Морфи наращивает давление по вертикали e?',
              correctMoveSan: 'Re8+',
              points: 1,
              options: ['Re7', 'c6', 'Re8+', 'Qb6'],
              explanations: {
                'Re8+': '8...Re8+! — ладья выходит с темпом, подключаясь к атаке на короля в центре.',
                'Re7': '8...Re7 пассивнее: ладья не оказывает немедленного давления.',
                'c6': '8...c6 — тихий ход; чёрные упускают возможность сыграть с темпом по линии e.',
                'Qb6': '8...Qb6 выглядит активно, но главное поле боя сейчас — вертикаль e.'
              }
            },
            {
              index: 20,
              question: 'После 9.Be2 слон белых ушёл с диагонали. Как Морфи использует тактическую возможность на c3?',
              correctMoveSan: 'Bxc3',
              points: 1,
              options: ['Bxe2', 'Bxc3', 'c6', 'Na6'],
              explanations: {
                'Bxc3': '9...Bxc3! — размен на c3 разрушает структуру белых и открывает линию b для возможной игры ферзём и ладьёй.',
                'Bxe2': '9...Bxe2? позволяет белым укрепить короля и разгрузить позицию.',
                'c6': '9...c6 — спокойное развитие, но тактика на c3 сейчас сильнее.',
                'Na6': '9...Na6 уводит коня с центра и упускает конкретный ресурс на c3.'
              }
            },
            {
              index: 26,
              question: 'После 13.Kf1 Морфи делает сильную жертву качества, вскрывая короля белых. Какой ход он играет?',
              correctMoveSan: 'Rxe2',
              points: 2,
              options: ['Qd7', 'Qd6', 'Rxe2', 'Rc8'],
              explanations: {
                'Rxe2': '13...Rxe2! — жертва качества ради атаки: чёрные открывают линию e и ослабляют прикрытие короля белых.',
                'Qd7': '13...Qd7 — слишком медленно: белые успеют увести короля в безопасное место.',
                'Qd6': '13...Qd6 не создаёт конкретных угроз и отдаёт инициативу.',
                'Rc8': '13...Rc8? — обычное развитие, но Морфи в этой позиции действует намного энергичнее.'
              }
            },
            {
              index: 34,
              question: 'После 16.Kf2 чёрные уже пожертвовали качество. Каким ходом Морфи усиливает давление на короля белых?',
              correctMoveSan: 'Ng4+',
              points: 1,
              options: ['Ng4+', 'Qh4+', 'Qd6', 'Rc8'],
              explanations: {
                'Ng4+': '16...Ng4+! — конь с шахом врывается к королю, вынуждая его на нестабильную позицию и поддерживая дальнейшую атаку.',
                'Qh4+': '16...Qh4+ выглядит грозно, но чёрный конь остаётся пассивным и не участвует в атаке.',
                'Qd6': '16...Qd6 не содержит конкретных угроз и позволяет белым укрепиться.',
                'Rc8': '16...Rc8 — обычный развивающий ход, но здесь пора действовать конкретно против короля.'
              }
            },
            {
              index: 42,
              question: 'После 21.Kh4 конь чёрных уже на e3. Как Морфи завершает подведение фигуры к матовой сети?',
              correctMoveSan: 'Ne3',
              points: 2,
              options: ['Ne3', 'Qf2+', 'Qh5+', 'Re8'],
              explanations: {
                'Ne3': '21...Ne3! — конь встаёт на мощный опорный пункт, угрожая Qf2+ и Qg4+ и лишая белого короля безопасных полей.',
                'Qf2+': '21...Qf2+?! возможно, но преждевременно: после Kh3 король ещё держится.',
                'Qh5+': '21...Qh5+ тоже даёт шах, но конь пока не использован максимально активно.',
                'Re8': '21...Re8 слишком медленно: позиция требует немедленной конкретики.'
              }
            }
          ]
        },

        {
          id: 'game4',
          title: 'Партия 13. Исидор Гунсберг – Михаил Чигорин, Гавана 1890',
          introParagraphs: [
            'Четвёртая партия — яркий пример активной, динамичной защиты в испанской партии от Михаила Чигорина.',
            'Гунсберг захватывает пространство и готовит атаку на королевском фланге, но Чигорин чутко реагирует на каждый ход и проводит контригру.',
            'В ключевые моменты обрати внимание, как чёрные используют ресурс ...d5–d4, переводы фигур и взаимодействие тяжёлых фигур против короля белых.'
          ],
          pgn: `
[Event "Chigorin - Gunsberg"]
[Site "Havana CUB"]
[Date "1890.01.03"]
[EventDate "1890.01.01"]
[Round "2"]
[Result "0-1"]
[White "Isidor Gunsberg"]
[Black "Mikhail Chigorin"]
[ECO "C77"]
[WhiteElo "?"]
[BlackElo "?"]
[PlyCount "84"]

1. e4 e5 2. Nf3 Nc6 3. Bb5 a6 4. Ba4 Nf6 5. d3 d6 6. c3 g6
7. Nbd2 Bg7 8. Nf1 O-O 9. h3 d5 10. Qe2 b5 11. Bc2 d4 12. g4
Qd6 13. N1d2 Be6 14. cxd4 Nxd4 15. Nxd4 Qxd4 16. Nf3 Qb4+ 
17. Kf1 Qd6 18. b3 c5 19. Bb2 Nd7 20. Ng5 Nb8 21. Nxe6 fxe6 
22. Kg2 Ra7 23. Rhf1 Raf7 24. f3 Nc6 25. Qd2 Rf4 26. Rad1 Qe7 
27. Qe1 Bf6 28. Qe2 Bh4 29. Bb1 h5 30. a3 hxg4 31. hxg4 Qg5 
32. Kh3 R8f7 33. Rc1 Qh6+ 34. Kg2 Rh7 35. Rh1 Rxf3 36. Qxf3 
Qd2+ 37. Kg1 Bf2+ 38. Kf1 Nd4 39. Bxd4 Qxc1+ 40. Ke2 Rxh1 
41. Bxf2 Qxb1 42. g5 Qf1+ 0-1
          `.trim(),
          keyMoments: [
            {
              index: 17,
              type: 'manual',
              question: 'Белые только что сыграли 9.h3 — промедление. Вспомни классическое правило и найди за чёрных лучшее продолжение.',
              correctMoveSan: 'd5',
              points: 2,
              explanations: {
                'd5': '9...d5! — стратегически важный подрыв в центре: если король соперника застрял в центре, вскрывай центр как можно быстрее.'
              }
            },
            {
              index: 27,
              question: 'После 14.cxd4 чем лучше всего съесть на d4 за чёрных?',
              correctMoveSan: 'Nxd4',
              points: 1,
              options: ['exd4', 'Nxd4'],
              explanations: {
                'Nxd4': '14...Nxd4 — надёжное и понятное решение: конь встаёт в центр, фигуры развиваются без ослаблений.',
                'exd4': '14...exd4 — смелое, но рискованное решение. Если ты точно посчитал вариант с 15.e5 и нашёл ответ 17...Bg4, такой план заслуживает 2 очка в самостоятельном разборе.'
              }
            },
            {
              index: 32,
              question: 'Чёрный ферзь дал шах 16...Qb4+, используя ослабленные поля. Как белым лучше всего защититься?',
              correctMoveSan: 'Kf1',
              points: 1,
              options: ['Kf1', 'Qd2', 'Bd2', 'Nd2'],
              explanations: {
                'Kf1': '17.Kf1 — практичное решение: король уходит с диагонали a7–g1, структура остаётся целой.',
                'Qd2': '17.Qd2 возможно, но неуклюже: фигуры стеснены, ферзевый фланг «забит» своими фигурами.',
                'Bd2': '17.Bd2? просто теряет пешку b2 — ферзь уже на b4.',
                'Nd2': '17.Nd2 блокирует слона c1 и мешает гармоничному развитию.'
              }
            },
            {
              index: 37,
              type: 'manual',
              question: 'Позиция после 19.Bb2. Найди за чёрных красивый манёвр, усиливающий фигуру.',
              correctMoveSan: 'Nd7',
              points: 3,
              explanations: {
                'Nd7': '19...Nd7! — конь стремится к идеальной опорной точке d4: Nb8–c6–d4. Классический манёвр Чигорина.'
              }
            },
            {
              index: 41,
              question: 'Белые только что забрали на e6: 21.Nxe6. Чем лучше всего взять этого коня?',
              correctMoveSan: 'fxe6',
              points: 1,
              options: ['fxe6', 'Qxe6'],
              explanations: {
                'fxe6': '21...fxe6! — более активное взятие: открывается линия f и диагональ a7–g1, появляются мотивы рентгена и атаки на короля.',
                'Qxe6': '21...Qxe6 — спокойное взятие, но без ярких атакующих идей и с уменьшением давления по линии f.'
              }
            },
            {
              index: 43,
              type: 'manual',
              question: 'Манёвр коня уже наметился. Как быстро и лаконично улучшить ещё одну фигуру за чёрных?',
              correctMoveSan: 'Ra7',
              points: 3,
              explanations: {
                'Ra7': '22...Ra7! — ладья готовится перевестись на f7, усиливая давление по линии f и против короля белых.'
              }
            },
            {
              index: 49,
              type: 'manual',
              question: 'После 25.Qd2 найди ход, который расширяет пространство и усиливает давление чёрных.',
              correctMoveSan: 'Rf4',
              points: 1,
              explanations: {
                'Rf4': '25...Rf4! — зажимающий ход: ладья вторгается на 4‑ю горизонталь, атакует слабости и создаёт множество тактических возможностей.'
              }
            },
            {
              index: 51,
              type: 'manual',
              question: 'После 26.Rad1 как можно улучшить позицию ферзя чёрных?',
              correctMoveSan: 'Qe7',
              points: 2,
              explanations: {
                'Qe7': '26...Qe7 — ферзь готовится перевестись на g5, усиливая давление на королевский фланг и взаимодействуя с ладьями.'
              }
            },
            {
              index: 53,
              type: 'manual',
              question: 'Осталось улучшить последнюю фигуру. Как бы ты сыграл(а) за чёрных и с какой идеей?',
              correctMoveSan: 'Bf6',
              points: 2,
              explanations: {
                'Bf6': '27...Bf6 — слон стремится на h4, усиливая давление на диагонали и поддерживая возможный вскрытый удар по королю белых.'
              }
            },
            {
              index: 57,
              question: 'После 29.Bb1 как чёрным ослабить пешечную структуру белых на королевском фланге?',
              correctMoveSan: 'h5',
              points: 1,
              options: ['c4', 'h5'],
              explanations: {
                'c4': '29...c4?! даёт белым возможность оживить ладью и получить контригру по линии c.',
                'h5': '29...h5! — сильный удар по пешечной структуре короля, подготавливающий вскрытие линий для тяжёлых фигур.'
              }
            },
            {
              index: 63,
              type: 'manual',
              question: 'Нет предела совершенству. Найди ещё одно улучшение фигуры за чёрных.',
              correctMoveSan: 'R8f7',
              points: 2,
              explanations: {
                'R8f7': '31...R8f7 — вторая ладья подключается к атаке; вскоре она может прийти и на линию h.'
              }
            },
            {
              index: 69,
              type: 'manual',
              question: 'Позиция созрела. Найди тактический удар за чёрных!',
              correctMoveSan: 'Rxf3',
              points: 2,
              explanations: {
                'Rxf3': '35...Rxf3! — типичный тактический удар: позиционные улучшения привели к тому, что жертва на f3 разрушает прикрытие короля белых.'
              }
            },
            {
              index: 73,
              question: 'Комбинация почти завершена. Как за чёрных точнее всего продолжить атаку?',
              correctMoveSan: 'Bf2+',
              points: 1,
              options: ['Rf7', 'Qb2', 'Bf2+'],
              explanations: {
                'Rf7': '37...Rf7? даёт белым шансы на контригру, например, после Qf7+.',
                'Qb2': '37...Qb2? позволяет белым консолидироваться ходом Rf1.',
                'Bf2+': '37...Bf2+! — точный разящий удар, который добивает атаку чёрных и ведёт к выигранному эндшпилю/мату.'
              }
            }
          ]
        },

        {
          id: 'chigorin_pollock_1889',
          title: 'Партия 14. Михаил Чигорин – Вильям Поллок, Нью-Йорк 1889',
          introParagraphs: [
            'Михаил Чигорин — главный герой русского шахматного возрождения — демонстрирует острую атаку в дебюте Эванса против блестящего тактика Поллока.',
            'Белые жертвуют пешку ради развития, очень быстро развивают фигуры и вскрывают линии на короля. Кульминацией становится красиый прорыв и жертва ферзя ради атаки.',
            'Потренируйся искать ключевые ходы — а Чигорин своим примером покажет, как играть одновременно строго и красиво!'
          ],
          pgn: `
[Event "6th American Chess Congress"]
[Site "New York, NY USA"]
[Date "1889.04.25"]
[EventDate "1889.03.25"]
[Round "23.1"]
[Result "1-0"]
[White "Mikhail Chigorin"]
[Black "William Henry Krause Pollock"]
[ECO "C51"]
[WhiteElo "?"]
[BlackElo "?"]
[PlyCount "73"]

1.e4 e5 2.Nf3 Nc6 3.Bc4 Bc5 4.b4 Bxb4 5.c3 Bc5 6.O-O d6 7.d4
exd4 8.cxd4 Bb6 9.Nc3 Na5 10.Bg5 f6 11.Bf4 Nxc4 12.Qa4+ Kf7
13.Qxc4+ Be6 14.d5 Bd7 15.Ne2 Qe8 16.a4 Ne7 17.Be3 Ng6 18.Bxb6
cxb6 19.Qb4 Qe7 20.Ng3 Rhc8 21.Nd4 Rc5 22.f4 Rac8 23.Qd2 Rc4
24.Ne6 Nh4 25.Qd1 Bxe6 26.dxe6 Kg8 27.Qg4 Ng6 28.Nf5 Qc7 29.e7
Kf7 30.Rad1 Qc5+ 31.Kh1 Rc6 32.e5 fxe5 33.Nxd6+ Rxd6 34.fxe5
Rf6 35.e8=Q+ Kxe8 36.Qd7+ Kf8 37.exf6 1-0
          `.trim(),
          keyMoments: [
            {
              index: 7,
              question: 'Как называется этот гамбит?',
              correctMoveSan: 'Гамбит Эванса',
              options: ['Гамбит жареной печенки', 'Гамбит Эванса', 'Будапештский гамбит', 'Пиратский гамбит'],
            },
            {
              index: 12,
              question: 'Ради чего белые пожертвовали пешку?',
              type: 'manual',
              correctMoveSan: 'd4',
              explanations: {
                'd4': 'Всё ради центра!'
              }
            },
            {
              index: 20,
              question: '21.Nd4 — белые укрепляют позицию и готовят перехват. Как за белых продолжить давление?',
              correctMoveSan: 'f4',
              options: ['f4', 'Nf5', 'Rac1', 'a5'],
              explanations: {
                'f4': '22.f4! — включаем максимум сил, подготавливая e5 или f5, усиливая контроль центра.',
                'Nf5': '22.Nf5 выглядит логично, но пока преждевременно.',
                'Rac1': '22.Rac1 — стандартное давление, но пешка f4 и тактика в центре главнее.',
                'a5': '22.a5 слабо — не создаёт реальных угроз.'
              }
            },
            {
              index: 29,
              question: 'Каким ходом Чигорин «прорывается» в лагерь соперника, используя все фигуры?',
              correctMoveSan: 'e7',
              options: ['e7', 'Nxd6+', 'Rc1', 'h4'],
              explanations: {
                'e7': '29.e7! — пешка проходит и вызывает панику в стане чёрных.',
                'Nxd6+': '29.Nxd6+ — промежуточный удар, но ход e7 быстрее создаёт решающие угрозы.',
                'Rc1': '29.Rc1 усиливает давление, но пока не основной конкретный ход.',
                'h4': '29.h4 — полезная профилактика, но не решает проблему сразу.'
              }
            },
            {
              index: 34,
              question: 'После жертвы и вскрытия линии f — какой ключевой ход находит Чигорин?',
              correctMoveSan: 'Rf6',
              options: ['Rf6', 'Rcd8', 'Qf4', 'Rfe8'],
              explanations: {
                'Rf6': '34...Rf6 — взметает по линии f: двойной удар и матовые угрозы.',
                'Rcd8': '34...Rcd8 — обычное давление без разящей силы.',
                'Qf4': '34...Qf4 активен, но вскрытие по линии f важнее.',
                'Rfe8': '34...Rfe8 пока не создаёт угроз.'
              }
            },
            {
              index: 35,
              question: 'Белые только что пожертвовали ферзя и превратили пешку. Как завершить атаку?',
              correctMoveSan: 'Qd7+',
              options: ['Qd7+', 'Qb5+', 'Rd7', 'Rfe1'],
              explanations: {
                'Qd7+': '36.Qd7+! — шах с атакой короля и неизбежными угрозами мата.',
                'Qb5+': '36.Qb5+ — шах, но не столь силён, как Qd7+.',
                'Rd7': '36.Rd7 — не используется максимальных ресурсов поля d7.',
                'Rfe1': '36.Rfe1 — обычное развитие, но надо атаковать!'
              }
            }
          ]
        },

        {
          id: 'steinitz_chigorin_havana_1892',
          title: 'Партия 15. М. Чигорин – В. Стейниц, Гавана 1892 (матч на первенство мира)',
          introParagraphs: [
            'Одна из ярких атакующих партий Михаила Чигорина против чемпиона мира Вильгельма Стейница.',
            'В остром дебюте итальянской партии Чигорин жертвует пешку (гамбит Эванса), затем фигурой и быстро атакует по линиям “b”, “e” и на королевском фланге.',
            'Найдите ключевые моменты перехода централизованной борьбы в классическую атаку на короля!'
          ],
          pgn: `
[Event "Steinitz - Chigorin World Championship Rematch"]
[Site "Havana CUB"]
[Date "1892.01.01"]
[EventDate "?"]
[Round "1"]
[Result "1-0"]
[White "Mikhail Chigorin"]
[Black "Wilhelm Steinitz"]
[ECO "C52"]
[WhiteElo "?"]
[BlackElo "?"]
[PlyCount "61"]

1. e4 e5 2. Nf3 Nc6 3. Bc4 Bc5 4. b4 Bxb4 5. c3 Ba5 6. O-O d6
7. d4 Bg4 8. Bb5 exd4 9. cxd4 Bd7 10. Bb2 Nce7 11. Bxd7+ Qxd7
12. Na3 Nh6 13. Nc4 Bb6 14. a4 c6 15. e5 d5 16. Nd6+ Kf8
17. Ba3 Kg8 18. Rb1 Nhf5 19. Nxf7 Kxf7 20. e6+ Kxe6 21. Ne5
Qc8 22. Re1 Kf6 23. Qh5 g6 24. Bxe7+ Kxe7 25. Nxg6+ Kf6
26. Nxh8 Bxd4 27. Rb3 Qd7 28. Rf3 Rxh8 29. g4 Rg8 30. Qh6+ Rg6
31. Rxf5+ 1-0
          `.trim(),
          keyMoments: [
            {
              index: 7,
              question: 'Какое название носит этот ход в теории?',
              correctMoveSan: 'Гамбит Эванса',
              options: [
                'Гамбит Эванса',
                'Протасовский гамбит',
                'Гамбит Греко',
                'Датский гамбит'
              ],
              explanations: {
                'Гамбит Эванса': 'Гамбит Эванса (Evans Gambit) — агрессивный дебют, начинающийся 4.b4!? с жертвой пешки ради развития и атаки.',
              }
            },
            {
              index: 14,
              question: 'Как защитить пешку d4, не двигая её вперед?',
              type: 'manual',
              correctMoveSan: 'Bb5',
              explanations: {
                'Bb5': 'Нейтрализуем давление на пункт d4.',
              }
            },
            {
              index: 22,
              type: 'manual',
              question: 'Как воспользоваться уязвимостью слона на а5?',
              correctMoveSan: 'Na3',
              points: 2,
              explanations: {
                'Na3': 'Белые охотятся за слоном и выигрывают важный темп.',
              }
            },
            {
              index: 26,
              question: 'Найдите ход, провоцирующий ослабление пешечной структуры черных.',
              correctMoveSan: 'a4',
              options: [
                'a4',
                'e5'
              ],
              explanations: {
                'a4': 'Черные вынуждены ослаблять ферзевый фланг, чтобы не потерять слона.'
              }
            },
            {
              index: 28,
              question: 'Найдите сильнейшее продолжение за белых.',
              correctMoveSan: 'e5',
              options: [
                'e5',
                'a5',
                'Re1'
              ],
              explanations: {
                'e5': 'Белые подготавливают форпост для коня.'
              }
            },
            {
              index: 32,
              question: 'Какое усиление нашёл Чигорин?',
              type: 'manual',
              correctMoveSan: 'Ba3',
              points: 2,
              explanations: {
                'Ba3': 'Естественное усиление слона.'
              }
            },
            {
              index: 33,
              question: 'Оцените позицию.',
              correctMoveSan: '+2.6',
              options: [
                '-1.0',
                '+1.3',
                '+2.6'
              ],
              explanations: {
                '+2.6': 'У белых позиционно почти лишняя фигура.'
              }
            },
            {
              index: 34,
              question: 'Какое усиление фигуры белых опаснее?',
              correctMoveSan: 'Rb1',
              options: [
                'Rb1',
                'Qd3',
                'Re1'
              ],
              explanations: {
                'Rb1': 'Возможен потенциальный удар а5.'
              }
            },
            {
              index: 36,
              question: 'Найдите лучшее продолжение.',
              type: 'manual',
              points: 3,
              correctMoveSan: 'Nxf7',
              explanations: {
                'Nxf7': 'Бриллиантовый ход!'
              }
            },
            {
              index: 42,
              question: 'Как улучшить еще одну фигуру?',
              correctMoveSan: 'Re1',
              options: [
                'Re1',
                'Qg4',
                'Qe2'
              ],
              explanations: {
                'Re1': 'Пора включить ладью!'
              }
            },
            {
              index: 44,
              question: 'Подключите по горячим следам ферзя.',
              correctMoveSan: 'Qh5',
              options: [
                'Qh5',
                'Qf3',
              ],
              explanations: {
                'Qh5': 'Куда же без ферзя?'
              }
            }
          ]
        },

        {
          id: 'steinitz_sellman_Baltimore_1885',
          title: 'Партия 16. В. Стейниц - А. Зельман, Балтимор 1885',
          introParagraphs: [
            'Позиционный шедевр от Стейница.',
            'Поучимся игре во французской защите от маэстро Вильгельма Стейница. Отличный план, чистое исполнение.',
            'Найдите ключевые моменты позиционной игры. Поехали!'
          ],
          pgn: `
[Event "Exhibition Match Game"]
[Site "Baltimore, MD USA"]
[Date "1885.02.09"]
[EventDate "?"]
[Round "1"]
[Result "1-0"]
[White "Wilhelm Steinitz"]
[Black "Alexander G Sellman"]
[ECO "C11"]
[WhiteElo "?"]
[BlackElo "?"]
[PlyCount "69"]

1. e4 e6 2. d4 d5 3. Nc3 Nf6 4. e5 Nfd7 5. f4 c5 6. dxc5 Bxc5
7. Nf3 a6 8. Bd3 Nc6 9. Qe12 Nb4 10. Bd2 b5 11. Nd1 Nxd3+
12. cxd3 Qb6 13. b4 Be7 14. a3 f5 15. Rc1 Bb7 16. Be3 Qd8
17. Nd4 Nf8 18. O-O h5 19. Nc3 Kf7 20. Nb1 g6 21. Nd2 Nd7
22. N2b3 Rc8 23. Na5 Ba8 24. Rxc8 Qxc8 25. Rc1 Qb8 26. Qc2 Bd8
27. Nac6 Qb7 28. Nxd8+ Rxd8 29. Qc7 Qb8 30. Bf2 Qb6 31. Nf3
Qxc7 32. Rxc7 Ke8 33. Ng5 Nf8 34. Bc5 Nd7 35. Bd6 1-0
          `.trim(),
          keyMoments: [
            {
              index: 22,
              question: 'Чем бы вы взяли на d3?',
              correctMoveSan: 'cxd3',
              options: [
                'cxd3',
                'Qxd3'
              ],
              explanations: {
                'cxd3': 'Начало позиционного шедевра',
              }
            }
           ]
         },

        {
          id: 'lasker_example_1',
          title: 'Партия 17. Эмануэль Ласкер – И. Бауэр',
          introParagraphs: [
            'Теперь переходим к эпохе Ласкера – более строгие и глубокие позиционные идеи.',
            'В этой партии Ласкер постепенно наращивает давление и использует тактические ресурсы в нужный момент.',
            'Попробуем найти его ключевые решения.'
          ],
          pgn: `
[Event "Amsterdam"]
[Site "Amsterdam NED"]
[Date "1889.08.26"]
[EventDate "1889.08.26"]
[Round "1"]
[Result "1-0"]
[White "Emanuel Lasker"]
[Black "Johann Hermann Bauer"]
[ECO "A03"]
[WhiteElo "?"]
[BlackElo "?"]
[PlyCount "75"]

1.f4 d5 2.e3 Nf6 3.b3 e6 4.Bb2 Be7 5.Bd3 b6 6.Nc3 Bb7 7.Nf3
Nbd7 8.O-O O-O 9.Ne2 c5 10.Ng3 Qc7 11.Ne5 Nxe5 12.Bxe5 Qc6
13.Qe2 a6 14.Nh5 Nxh5 15.Bxh7+ Kxh7 16.Qxh5+ Kg8 17.Bxg7 Kxg7
18.Qg4+ Kh7 19.Rf3 e5 20.Rh3+ Qh6 21.Rxh6+ Kxh6 22.Qd7 Bf6
23.Qxb7 Kg7 24.Rf1 Rab8 25.Qd7 Rfd8 26.Qg4+ Kf8 27.fxe5 Bg7
28.e6 Rb7 29.Qg6 f6 30.Rxf6+ Bxf6 31.Qxf6+ Ke8 32.Qh8+ Ke7
33.Qg7+ Kxe6 34. Qxb7 Rd6 35. Qxa6 d4 36. exd4 cxd4 37. h4 d3
38. Qxd3 1-0          `.trim(),
          keyMoments: [
            {
              index: 15,
              question: 'Какой развивающий ход делают белые?',
              correctMoveSan: '0-0',
              options: ['a4', '0-0', 'h3', 'Qc1'],
              explanations: {
                'a4': '7.a4 - ход в честь любимого блогера',
                '0-0': '7.0-0 - самый разивающий ход. Почему бы и нет, а?',
                'h3': '7.h3 - вы о чем, мой друг?',
                'Qc1': '7.Qc1 - что за дикость.'
              }
            }
          ]
        },
{
          id: 'lasker_example_1',
          title: 'Партия 17. Эмануэль Ласкер – И. Бауэр',
          introParagraphs: [
            'Теперь переходим к эпохе Ласкера – более строгие и глубокие позиционные идеи.',
            'В этой партии Ласкер постепенно наращивает давление и использует тактические ресурсы в нужный момент.',
            'Попробуем найти его ключевые решения.'
          ],
          pgn: `


[Event "Capablanca - Marshall"]
[Site "Morristown, NJ USA"]
[Date "1909.04.29"]
[EventDate "1909.04.19"]
[Round "6"]
[Result "1-0"]
[White "Jose Raul Capablanca"]
[Black "Frank James Marshall"]
[ECO "C62"]
[WhiteElo "?"]
[BlackElo "?"]
[PlyCount "77"]

1.e4 e5 2.Nf3 Nc6 3.Bb5 d6 4.c3 Bg4 5.d3 Be7 6.Nbd2 Nf6 7.O-O
O-O 8.Re1 h6 9.Nf1 Nh7 10.Ne3 Bh5 11.g4 Bg6 12.Nf5 h5 13.h3
hxg4 14.hxg4 Bg5 15.Nxg5 Nxg5 16.Kg2 d5 17.Qe2 Re8 18.Rh1 Re6
19.Qe3 f6 20.Ba4 Ne7 21.Bb3 c6 22.Qg3 a5 23.a4 Nf7 24.Be3 b6
25.Rh4 Kf8 26.Rah1 Ng8 27.Qf3 Bxf5 28.gxf5 Rd6 29.Qh5 Ra7
30.Qg6 Nfh6 31.Rxh6 gxh6 32.Bxh6+ Ke7 33.Qg7+ Ke8 34.Qxg8+ Kd7
35.Qh7+ Qe7 36.Bf8 Qxh7 37.Rxh7+ Ke8 38.Rxa7 Kxf8 39.Kf3 1-0 `.trim(),
          keyMoments: [
            {
              index: 11,
              question: 'Какой типичный коневой маневр начинают белые?',
              correctMoveSan: 'Nbd2',
              options: ['a4', 'a3', 'Nbd2', 'h3'],
              explanations: {
                'a4': '7.a4 - вы серьезно?',
                '0-0': '7.Nbd2 - вот он, стандартный перевод коня на f1',
                'h3': '7.h3 - Хм.. Давайте еще подумаем?',
                'Qc1': '7.a3 - что за дикость.'
              }
            }
          ]
        }

      ];

      const game = new Chess();

      let currentGameIndex = 0;
      let referenceGame = null;
      let movesList = [];
      let keyMoments = [];
      let currentMoveIndex = 0;

      let score = 0;
      const answeredMoments = new Set();
      const diamondMoves = new Set();
      let questionActive = false;
      let manualQuestionActive = false;
      let activeManualMoment = null;
      let summaryShown = false;

      let survivalMode = false;
      let lives = 3;

      const board = Chessboard('board', {
        draggable: true,
        position: 'start',
        pieceTheme: 'img/chesspieces/alpha/{piece}.png',
        onDragStart: onDragStart,
        onDrop: onDrop,
        onSnapEnd: onSnapEnd
      });

      const boardWrapperEl = document.getElementById('board-wrapper');

      const wizardBubbleEl = document.getElementById('wizard-bubble');
      const wizardBubbleTextEl = document.getElementById('wizard-bubble-text');

      function wizardSay(text) {
        if (!wizardBubbleEl || !wizardBubbleTextEl) return;
        const safeText = (text || '').toString().trim();
        if (!safeText) return;
        wizardBubbleTextEl.textContent = safeText;
        wizardBubbleEl.classList.add('visible');
      }

      function wizardCommentForAnswer(moment, selectedSan, isCorrect) {
        const expl =
          (moment && moment.explanations && moment.explanations[selectedSan])
            ? moment.explanations[selectedSan]
            : '';

        if (expl) {
          wizardSay(expl);
          return;
        }

        if (isCorrect) {
          wizardSay(`Ход ${selectedSan} — верно.`);
        } else {
          wizardSay(`Ход ${selectedSan} — не лучший. Попробуй иначе.`);
        }
      }

      function triggerHitImpact() {
        if (!boardWrapperEl) return;
        boardWrapperEl.classList.remove('hit-impact');
        void boardWrapperEl.offsetWidth;
        boardWrapperEl.classList.add('hit-impact');
      }

function triggerDiamondImpact() {
  if (!boardWrapperEl) return;
  boardWrapperEl.classList.remove('hit-impact-diamond');
  void boardWrapperEl.offsetWidth;
  boardWrapperEl.classList.add('hit-impact-diamond');
}



      function clearHoverHighlights() {
        const squares = document.querySelectorAll('#board .square-55d63');
        squares.forEach(sq => {
          sq.classList.remove('hover-highlight-from', 'hover-highlight-to');
        });
      }

      function highlightMoveOnBoard(from, to) {
        clearHoverHighlights();
        if (!from || !to) return;

        const fromEl = document.querySelector(
          '#board .square-55d63[data-square="' + from + '"]'
        );
        const toEl = document.querySelector(
          '#board .square-55d63[data-square="' + to + '"]'
        );

        if (fromEl) fromEl.classList.add('hover-highlight-from');
        if (toEl) fromEl && toEl.classList.add('hover-highlight-to');
      }

      function getMoveSquaresForSan(moment, san) {
        const tmp = new Chess();
        for (let i = 0; i < moment.index && i < movesList.length; i++) {
          tmp.move(movesList[i]);
        }
        const legal = tmp.moves({ verbose: true });
        const mv = legal.find(m => m.san === san);
        if (!mv) return null;
        return { from: mv.from, to: mv.to };
      }


let tapSelectedSquare = null;
let tapLegalTargets = new Set();
const boardElLocal = document.getElementById('board');
function isMobileTapMode(){
  return window.matchMedia('(max-width: 900px)').matches;
}

function clearTapHints(){
  tapSelectedSquare = null;
  tapLegalTargets.clear();
  const all = document.querySelectorAll('#board .square-55d63');
  all.forEach(sq => sq.classList.remove('tap-selected','tap-legal','tap-capture'));
}

function showTapHints(fromSquare){
  clearTapHints();
  tapSelectedSquare = fromSquare;

  const fromEl = document.querySelector('#board .square-55d63[data-square="' + fromSquare + '"]');
  if (fromEl) fromEl.classList.add('tap-selected');

  const legal = game.moves({ verbose: true });
  legal
    .filter(m => m.from === fromSquare)
    .forEach(m => {
      tapLegalTargets.add(m.to);
      const toEl = document.querySelector('#board .square-55d63[data-square="' + m.to + '"]');
      if (!toEl) return;
      toEl.classList.add('tap-legal');
      if (m.flags && m.flags.includes('c')) {
        toEl.classList.add('tap-capture');
      }
    });
}

function tryTapMove(toSquare){
  if (!tapSelectedSquare) return false;
  if (!tapLegalTargets.has(toSquare)) return false;

  const move = game.move({
    from: tapSelectedSquare,
    to: toSquare,
    promotion: 'q'
  });

  if (!move) return false;

  // обработка "manual" вопроса (важно: повторяем вашу логику из onDrop)
  if (manualQuestionActive && activeManualMoment) {
    const san = move.san;
    const correctSan = activeManualMoment.correctMoveSan;

    if (san === correctSan) {
      const delta = getMomentPoints(activeManualMoment);
      score += delta;
      updateScoreDisplay(delta);

      if (delta === 3) {
        playDiamondSound();
        triggerDiamondImpact();;
        diamondMoves.add(activeManualMoment.index);
      } else {
        playRightSound();
      }

      statusEl.style.color = 'green';
      statusEl.textContent = 'Верно!';

      const expl =
        activeManualMoment.explanations &&
        activeManualMoment.explanations[correctSan]
          ? activeManualMoment.explanations[correctSan]
          : '';

      if (explanationEl) {
        explanationEl.textContent = expl;
        explanationEl.style.color = '#333';
      } wizardCommentForAnswer(activeManualMoment, san, true);

      answeredMoments.add(activeManualMoment.index);
      updateProgress();

      manualQuestionActive = false;
      activeManualMoment = null;
      questionActive = false;

      prevMoveBtn.disabled = false;
      nextMoveBtn.disabled = false;

      syncCurrentIndexWithGame();
      board.position(game.fen());
      updateBoardAndNotation();

      clearTapHints();
      return true;
    } else {
      // откатываем ход
      game.undo();

      loseLife();

      statusEl.style.color = 'red';
      statusEl.textContent = 'Неправильно, попробуй найти более сильное продолжение.';

      const delta = -1;
      score += delta;
      updateScoreDisplay(delta);

      playWrongSound();

      const explWrong =
        activeManualMoment.explanations &&
        activeManualMoment.explanations[san]
          ? activeManualMoment.explanations[san]
          : '';

      if (explanationEl) {
        explanationEl.textContent = explWrong;
        explanationEl.style.color = '#333';
      }

      wizardCommentForAnswer(activeManualMoment, san, false);

      // остаёмся в режиме подсказок
      board.position(game.fen());
      showTapHints(tapSelectedSquare);
      return false;
    }
  }

  // обычный режим
  wizardSay(`Выбран ход: ${move.san}`);
  syncCurrentIndexWithGame();
  board.position(game.fen());
  updateBoardAndNotation();

  clearTapHints();
  return true;
}

/* Делегирование кликов по клеткам */
if (boardElLocal) {
  boardElLocal.addEventListener('click', (e) => {
    if (!isMobileTapMode()) return;
    if (questionActive && !manualQuestionActive) return;

    const sqEl = e.target.closest('#board .square-55d63');
    if (!sqEl) return;

    const square = sqEl.getAttribute('data-square');
    if (!square) return;

    // 1) если есть выбранная фигура — пробуем сделать ход
    if (tapSelectedSquare) {
      if (square === tapSelectedSquare) {
        clearTapHints();
        return;
      }
      if (tryTapMove(square)) return;
      // если не получилось — продолжаем (возможно, хотим выбрать другую фигуру)
    }

    // 2) выбираем фигуру, если она наша и сейчас её ход
    const piece = game.get(square);
    if (!piece) {
      clearTapHints();
      return;
    }

    const myColor = game.turn(); // 'w' or 'b'
    if (piece.color !== myColor) {
      clearTapHints();
      return;
    }
    showTapHints(square);
  }, { passive: true });
}

/* при перелистывании ходов/перезагрузке/ресайзе — чистим точки */
window.addEventListener('resize', () => {
  if (!isMobileTapMode()) clearTapHints();
});







     function onDragStart(source, piece, position, orientation) {
  if (window.matchMedia('(max-width: 900px)').matches) return false; // mobile: only tap-to-move
  if (game.game_over()) return false;
  if (questionActive && !manualQuestionActive) return false;
  if (game.turn() === 'w' && piece[0] === 'b') return false;
  if (game.turn() === 'b' && piece[0] === 'w') return false;
}

      function onDrop(source, target) {
        if (questionActive && !manualQuestionActive) return 'snapback';

        const move = game.move({
          from: source,
          to: target,
          promotion: 'q'
        });
        if (move === null) return 'snapback';

        if (manualQuestionActive && activeManualMoment) {
          const san = move.san;
          const correctSan = activeManualMoment.correctMoveSan;

          if (san === correctSan) {
            const delta = getMomentPoints(activeManualMoment);
            score += delta;
            updateScoreDisplay(delta);

            if (delta === 3) {
              playDiamondSound();
              triggerDiamondImpact();
              diamondMoves.add(activeManualMoment.index);
            } else {
              playRightSound();
            }

            statusEl.style.color = 'green';
            statusEl.textContent = 'Верно!';

            const expl =
              activeManualMoment.explanations &&
              activeManualMoment.explanations[correctSan]
                ? activeManualMoment.explanations[correctSan]
                : '';

            if (explanationEl) {
              explanationEl.textContent = expl;
              explanationEl.style.color = '#333';
            }

            wizardCommentForAnswer(activeManualMoment, san, true);

            answeredMoments.add(activeManualMoment.index);
            updateProgress();

            manualQuestionActive = false;
            activeManualMoment = null;
            questionActive = false;

            prevMoveBtn.disabled = false;
            nextMoveBtn.disabled = false;

            syncCurrentIndexWithGame();
            board.position(game.fen());
            updateBoardAndNotation();

            clearHoverHighlights();
            return;
          } else {
            game.undo();

            loseLife();

            statusEl.style.color = 'red';
            statusEl.textContent = 'Неправильно, попробуй найти более сильное продолжение.';

            const delta = -1;
            score += delta;
            updateScoreDisplay(delta);

            playWrongSound();

            const explWrong =
              activeManualMoment.explanations &&
              activeManualMoment.explanations[san]
                ? activeManualMoment.explanations[san]
                : '';

            if (explanationEl) {
              explanationEl.textContent = explWrong;
              explanationEl.style.color = '#333';
            }

            wizardCommentForAnswer(activeManualMoment, san, false);

            return 'snapback';
          }
        }

        wizardSay(`Выбран ход: ${move.san}`);
        syncCurrentIndexWithGame();
        updateBoardAndNotation();
      }

      function onSnapEnd() {
        board.position(game.fen());
      }

      const questionTitleEl = document.getElementById('question-title');
      const questionTextEl = document.getElementById('question-text');
      const answersEl = document.getElementById('answers');
      const statusEl = document.getElementById('status');
      const explanationEl = document.getElementById('explanation');
      const nextBtn = document.getElementById('next-btn');
      const notationContentEl = document.getElementById('notation-content');
      const moveCounterEl = document.getElementById('move-counter');
      const prevMoveBtn = document.getElementById('prev-move-btn');
      const nextMoveBtn = document.getElementById('next-move-btn');
      const introTextEl = document.getElementById('intro-text');
      const scoreContainerEl = document.getElementById('score');
      const scoreValueEl = document.getElementById('score-value');
      const flipBoardBtn = document.getElementById('flip-board-btn');
      const victoryEffectEl = document.getElementById('victory-effect');
      const victorySoundEl = document.getElementById('victory-sound');
      const fullVictorySoundEl = document.getElementById('full-victory-sound');
      const soundRightEl = document.getElementById('sound-right');
      const soundWrongEl = document.getElementById('sound-wrong');
      const diamondSoundEl = document.getElementById('diamond-sound');
      const gameoverSoundEl = document.getElementById('gameover-sound');
      const gameoverOverlayEl = document.getElementById('gameover-overlay');
      const gameoverRestartBtnEl = document.getElementById('gameover-restart-btn');
      const gameoverVideoEl = document.getElementById('gameover-video');
      const resizeHandleEl = document.getElementById('resize-board-handle');
      const boardEl = document.getElementById('board');
      const notationBlockEl = document.getElementById('notation-block');
// === FIX: не увеличиваем доску на десктопе ===
// На широких экранах оставляем "дизайнерский" размер из макета,
// на узких (<=900px) включаем авто-подгон.
function autoFitBoard() {
  if (!boardEl) return;

  const isNarrow = window.matchMedia('(max-width: 900px)').matches;

  if (!isNarrow) {
    // Десктоп: фиксированные размеры как в CSS/макете
    const desktopBoardSize = 380;
    const desktopNotationSize = 420;

    boardEl.style.width = desktopBoardSize + 'px';
    if (notationBlockEl) {
      notationBlockEl.style.width = desktopNotationSize + 'px';
    }

    try { board.resize(); } catch (e) {}
    try { updateAllArrowsPositions(); } catch (e) {}
    return;
  }

  // Мобильные/планшеты: резиновый размер под контейнер
  const padding = 24;
  const container =
    document.getElementById('quest-container') ||
    document.getElementById('layout') ||
    document.body;

  const containerWidth =
    container.getBoundingClientRect().width || window.innerWidth;

  let size = Math.floor(containerWidth - padding);
  size = Math.max(260, Math.min(size, 520));

  boardEl.style.width = size + 'px';
  if (notationBlockEl) {
    notationBlockEl.style.width = size + 'px';
  }

  try { board.resize(); } catch (e) {}
  try { updateAllArrowsPositions(); } catch (e) {}
}
      const progressContainerEl = document.getElementById('progress-container');
      const progressBarEl = document.getElementById('progress-bar');
      const progressLabelEl = document.getElementById('progress-label');

      const survivalBtnEl = document.getElementById('survival-btn');
      const livesContainerEl = document.getElementById('lives-container');

      const tocButtons = document.querySelectorAll('#toc .toc-item');

// === MOBILE TOC toggle ===
const tocToggleBtn = document.getElementById('toc-toggle-btn');
const tocOverlay = document.getElementById('toc-overlay');

function isMobileLayout() {
  return window.matchMedia('(max-width: 900px)').matches;
}

function openToc() {
  document.body.classList.add('toc-open');
  if (tocOverlay) tocOverlay.hidden = false;
  if (tocToggleBtn) tocToggleBtn.setAttribute('aria-expanded', 'true');
}

function closeToc() {
  document.body.classList.remove('toc-open');
  if (tocOverlay) tocOverlay.hidden = true;
  if (tocToggleBtn) tocToggleBtn.setAttribute('aria-expanded', 'false');
}

function toggleToc() {
  if (document.body.classList.contains('toc-open')) closeToc();
  else openToc();
}

if (tocToggleBtn) {
  tocToggleBtn.addEventListener('click', () => {
    if (!isMobileLayout()) return; // на десктопе кнопка и так скрыта, но на всякий случай
    toggleToc();
  });
}

if (tocOverlay) {
  tocOverlay.addEventListener('click', () => {
    closeToc();
  });
}

// Закрывать меню по ESC (удобно на планшетах/клавиатурах)
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeToc();
});

// При смене ориентации/resize: если вышли на десктоп — снять блокировки
window.addEventListener('resize', () => {
  if (!isMobileLayout()) closeToc();
});



      const boardArrowLayerEl = document.getElementById('board-arrow-layer');

      const eraProgressEl = document.getElementById('era-progress');
      const eraProgressFillEl = document.getElementById('era-progress-fill');
      const eraProgressThumbEl = document.getElementById('era-progress-thumb');
      const eraProgressCurrentEl = document.getElementById('era-progress-current');

      const eraProgressMap = {
        0: 0,   // Greco 1623
        1: 3,
        2: 6,
        3: 9,
        4: 12,  // La Bourdonnais – McDonnell 1834
        5: 15,  // Anderssen–Kieseritzky 1851
        6: 20,  // Anderssen–Dufresne 1852
        7: 30,  // Morphy 1857–58
        8: 33,
        9: 36,
        10: 39,
        11: 55, // Gunsberg–Chigorin 1890
        12: 58, // Chigorin–Pollock 1889
        13: 60, // Chigorin–Steinitz 1892
        14: 50  // Steinitz–Sellman 1885
      };

      const eraTextMap = {
        0: 'Ранний романтизм · Греко, XVII век',
        1: 'Ранний романтизм · Греко',
        2: 'Ранний романтизм · Греко',
        3: 'Ранний романтизм · Греко',
        4: 'Переход к классическому романтизму · Ла Бурдонне vs Макдоннелл',
        5: 'Классический романтизм · Андерссен (Бессмертная партия)',
        6: 'Классический романтизм · Андерссен',
        7: 'Классический романтизм · Морфи',
        8: 'Классический романтизм · Морфи',
        9: 'Классический романтизм · Морфи',
        10: 'Классический романтизм · Морфи',
        11: 'Конец XIX века · Чигорин',
        12: 'Конец XIX века · Чигорин',
        13: 'Конец XIX века · Чигорин vs Стейниц',
        14: 'Конец XIX века · Стейниц'
      };

      function setEraProgressForGame(gameIndex) {
        if (!eraProgressFillEl || !eraProgressThumbEl) return;
        const pct = (gameIndex in eraProgressMap) ? eraProgressMap[gameIndex] : 0;
        eraProgressFillEl.style.width = pct + '%';
        eraProgressThumbEl.style.left = pct + '%';

        if (eraProgressCurrentEl) {
          const text = eraTextMap[gameIndex] || '';
          eraProgressCurrentEl.textContent = text;
        }
      }

      const boardArrows = new Map();

      let rightMouseDown = false;
      let rightMouseStartSquare = null;
      let rightMouseStartPos = { x: 0, y: 0 };
      let rightMouseDragged = false;

      function renderLives() {
        if (!livesContainerEl) return;
        const hearts = livesContainerEl.querySelectorAll('.life-heart');
        hearts.forEach((h, idx) => {
          const lifeIndex = idx + 1;
          if (lifeIndex <= lives) {
            h.classList.remove('lost');
          } else {
            h.classList.add('lost');
          }
        });
      }

      function setSurvivalUIVisible(isVisible) {
        if (!livesContainerEl) return;
        if (isVisible) {
          livesContainerEl.classList.add('visible');
        } else {
          livesContainerEl.classList.remove('visible');
        }
      }

      function resetLives() {
        lives = 3;
        renderLives();
      }

      function loseLife() {
        if (!survivalMode) return;
        if (lives <= 0) return;
        lives -= 1;
        renderLives();
        if (lives <= 0) {
          triggerDefeat();
        }
      }

      function triggerDefeat() {
        questionActive = true;
        manualQuestionActive = false;
        activeManualMoment = null;

        prevMoveBtn.disabled = true;
        nextMoveBtn.disabled = true;

        clearHoverHighlights();

        hideGameoverOverlay();
        showGameoverOverlay();

        if (introTextEl) {
          introTextEl.style.display = 'none';
        }

        questionTitleEl.style.display = 'block';
        questionTextEl.style.display = 'block';
        questionTitleEl.textContent = 'Поражение';
        questionTextEl.textContent = 'Ты исчерпал(а) все жизни в режиме выживания.';

        answersEl.innerHTML = '';
        statusEl.style.color = '#b91c1c';
        statusEl.textContent = 'Жизни закончились.';
        if (explanationEl) explanationEl.textContent = '';

        const restartBtn = document.createElement('button');
        restartBtn.className = 'restart-btn';
        restartBtn.textContent = 'Начать заново';
        restartBtn.addEventListener('click', () => {
          loadGame(currentGameIndex);
        });
        answersEl.appendChild(restartBtn);

        wizardSay('Режим выживания: 3 ошибки — поражение. Нажми «Начать заново», чтобы попробовать ещё раз.');
      }

      function updateScoreDisplay(delta = 0) {
        if (!scoreValueEl) return;

        scoreValueEl.textContent = 'Очки: ' + score;

        if (delta !== 0 && scoreContainerEl) {
          if (delta > 0) {
            scoreValueEl.classList.add('score-pulse');
            setTimeout(() => {
              scoreValueEl.classList.remove('score-pulse');
            }, 350);
          }

          const popup = document.createElement('span');
          popup.classList.add('score-popup');
          popup.classList.add(delta > 0 ? 'positive' : 'negative');
          popup.textContent = (delta > 0 ? '+' : '') + delta;
          scoreContainerEl.appendChild(popup);

          popup.addEventListener('animationend', () => {
            popup.remove();
          });
        }
      }

      function getMomentPoints(moment) {
        if (!moment) return 0;
        return typeof moment.points === 'number' ? moment.points : 1;
      }

      function getMaxScoreForCurrentGame() {
        if (!keyMoments || keyMoments.length === 0) return 0;
        return keyMoments.reduce((sum, m) => sum + getMomentPoints(m), 0);
      }

      function updateProgress() {
        if (!progressContainerEl || !progressBarEl || !progressLabelEl) return;

        if (!keyMoments || keyMoments.length === 0) {
          progressContainerEl.style.display = 'none';
          return;
        }

        const total = keyMoments.length;
        const done = answeredMoments.size;
        const percent = Math.round((done / total) * 100);

        progressContainerEl.style.display = 'block';
        progressBarEl.style.width = percent + '%';
        progressLabelEl.textContent = `Прогресс квеста: ${done}/${total}`;
      }

      if (flipBoardBtn) {
        flipBoardBtn.addEventListener('click', () => {
          board.flip();
          updateAllArrowsPositions();
        });
      }

      if (resizeHandleEl && boardEl) {
        let isResizing = false;
        let startX = 0;
        let startY = 0;
        let startSize = 0;

        const minSize = 260;
        const maxSize = 720;

        function onMouseMoveResize(e) {
          if (!isResizing) return;
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          const delta = Math.max(dx, dy);
          let newSize = startSize + delta;
          if (newSize < minSize) newSize = minSize;
          if (newSize > maxSize) newSize = maxSize;

          boardEl.style.width = newSize + 'px';
          if (notationBlockEl) {
            notationBlockEl.style.width = newSize + 'px';
          }
          board.resize();
          updateAllArrowsPositions();
        }

        function onMouseUpResize() {
          if (!isResizing) return;
          isResizing = false;
          document.removeEventListener('mousemove', onMouseMoveResize);
          document.removeEventListener('mouseup', onMouseUpResize);
        }

        resizeHandleEl.addEventListener('mousedown', (e) => {
          e.preventDefault();
          isResizing = true;
          startX = e.clientX;
          startY = e.clientY;
          startSize = boardEl.getBoundingClientRect().width;
          document.addEventListener('mousemove', onMouseMoveResize);
          document.addEventListener('mouseup', onMouseUpResize);
        });
      }

      function applyMovesUpTo(moveIndex) {
        const tmpGame = new Chess();
        for (let i = 0; i < moveIndex && i < movesList.length; i++) {
          tmpGame.move(movesList[i]);
        }
        game.load(tmpGame.fen());
        board.position(game.fen());
      }

      function syncCurrentIndexWithGame() {
        const tmp = new Chess();
        let idx = 0;
        for (let i = 0; i < movesList.length; i++) {
          tmp.move(movesList[i]);
          if (tmp.fen() === game.fen()) {
            idx = i + 1;
            break;
          }
        }
        currentMoveIndex = idx;
      }

      function getMomentByIndex(index) {
        return keyMoments.find(m => m.index === index) || null;
      }

      function checkForQuestion() {
        const moment = getMomentByIndex(currentMoveIndex);

        if (!moment || answeredMoments.has(moment.index)) {
          return;
        }

        if (moment.type === 'manual') {
          showManualQuestion(moment);
          return;
        }

        showQuestionForMoment(moment);
      }

      function updateBoardAndNotation() {
        applyMovesUpTo(currentMoveIndex);
	clearTapHints();
        if (moveCounterEl) {
          moveCounterEl.textContent = `Ход: ${currentMoveIndex}/${movesList.length}`;
        }

        let html = '';
        const visibleMovesCount = currentMoveIndex;
        for (let i = 0; i < visibleMovesCount; i++) {
          const move = movesList[i];
          if (i % 2 === 0) {
            const moveNumber = (i / 2) + 1;
            html += moveNumber + '. ';
          }
          const isCurrent = (i === currentMoveIndex - 1);
          const san = move.san;
          let displaySan = san;
          if (diamondMoves.has(i)) {
            displaySan = san + '!!';
          }
          if (isCurrent) {
            html += '<span class="current-move">' + displaySan + '</span> ';
          } else {
            html += displaySan + ' '; 
          }

        }
        notationContentEl.innerHTML = html;
        const currentSpan = notationContentEl.querySelector('.current-move');
        if (currentSpan) {
          const top = currentSpan.offsetTop - notationContentEl.offsetTop;
          notationContentEl.scrollTop = top - 20;
        } else {
          notationContentEl.scrollTop = 0;
        }

        if (!questionActive) {
          clearHoverHighlights();
          checkForQuestion();
        }

        if (
          !summaryShown &&
          currentMoveIndex === movesList.length &&
          (!keyMoments || keyMoments.length === 0 || answeredMoments.size === keyMoments.length)
        ) {
          showFinalSummary();
        }
      }

function goToNextQuest() {
  const nextIndex = currentGameIndex + 1;
  if (nextIndex < gamesData.length) {
    loadGame(nextIndex);
  } else {
    // Если квестов больше нет — можно показать сообщение волшебника
    wizardSay('Это был последний квест в списке. Скоро появятся новые!');
  }
}


      function loadGame(index) {
        currentGameIndex = index;
        const data = gamesData[index];
        hideGameoverOverlay();

        if (introTextEl) {
          introTextEl.innerHTML = '';
          const h2 = document.createElement('h2');
          h2.textContent = data.title;
          introTextEl.appendChild(h2);
          data.introParagraphs.forEach(text => {
            const p = document.createElement('p');
            p.textContent = text;
            introTextEl.appendChild(p);
          });
          introTextEl.style.display = 'block';
        }

        questionTitleEl.style.display = 'none';
        questionTextEl.style.display = 'none';
        answersEl.innerHTML = '';
        statusEl.textContent = '';
        if (explanationEl) {
          explanationEl.textContent = '';
          explanationEl.style.color = '#333';
        }
        nextBtn.style.display = 'none';

        score = 0;
        updateScoreDisplay(0);
        answeredMoments.clear();
        diamondMoves.clear();
        questionActive = false;
        manualQuestionActive = false;
        activeManualMoment = null;
        summaryShown = false;

        stopVictoryEffect();
        stopVictorySound();

        if (survivalMode) {
          resetLives();
        }
        renderLives();

        referenceGame = new Chess();
        const ok = referenceGame.load_pgn(data.pgn);
        if (!ok) {
          console.error('Не удалось загрузить PGN для партии:', data.id);
          movesList = [];
        } else {
          movesList = referenceGame.history({ verbose: true });
        }
        keyMoments = data.keyMoments || [];

        game.reset();
        currentMoveIndex = 0;
        board.orientation('white');
        board.position('start');
        clearHoverHighlights();
        clearAllUserHighlights();
        clearAllArrows();
        updateBoardAndNotation();

        updateProgress();
        autoFitBoard();
        prevMoveBtn.disabled = false;
        nextMoveBtn.disabled = false;

        updateTocHighlight();

        setEraProgressForGame(index);

        wizardSay('Выбери партию и листай ходы. А в ключевые моменты я буду подсказывать смысл ходов!');
      }

     function updateTocHighlight() {
  tocButtons.forEach((btn) => {
    const idx = parseInt(btn.dataset.gameIndex, 10);
    if (!Number.isNaN(idx) && idx === currentGameIndex) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });

  // Подсветка группы, где находится активный пункт
  const groups = document.querySelectorAll('#toc .toc-group');
  groups.forEach(g => g.classList.remove('has-active'));
  const active = document.querySelector('#toc .toc-item.active');
  if (active) {
    const parent = active.closest('.toc-group');
    if (parent) parent.classList.add('has-active');
  }
}


      prevMoveBtn.addEventListener('click', () => {
        if (questionActive) return;
        if (currentMoveIndex > 0) {
          currentMoveIndex--;
          const mv = movesList[currentMoveIndex - 1];
          if (mv && mv.san) wizardSay(`Смотрим позицию после: ${mv.san}`);
          updateBoardAndNotation();
        }
      });

      nextMoveBtn.addEventListener('click', () => {
        if (questionActive) return;
        if (currentMoveIndex < movesList.length) {
          currentMoveIndex++;
          const mv = movesList[currentMoveIndex - 1];
          if (mv && mv.san) wizardSay(`Ход партии: ${mv.san}`);
          updateBoardAndNotation();
        }
      });

      document.addEventListener('keydown', (event) => {
        if (questionActive) return;

        if (event.key === 'ArrowLeft') {
          event.preventDefault();
          if (currentMoveIndex > 0) {
            currentMoveIndex--;
            const mv = movesList[currentMoveIndex - 1];
            if (mv && mv.san) wizardSay(`Смотрим позицию после: ${mv.san}`);
            updateBoardAndNotation();
          }
        } else if (event.key === 'ArrowRight') {
          event.preventDefault();
          if (currentMoveIndex < movesList.length) {
            currentMoveIndex++;
            const mv = movesList[currentMoveIndex - 1];
            if (mv && mv.san) wizardSay(`Ход партии: ${mv.san}`);
            updateBoardAndNotation();
          }
        }
      });

      tocButtons.forEach(btn => {
        const idx = parseInt(btn.dataset.gameIndex, 10);

        btn.addEventListener('mouseenter', () => {
          if (Number.isNaN(idx)) return;
          setEraProgressForGame(idx);
        });

        btn.addEventListener('mouseleave', () => {
          setEraProgressForGame(currentGameIndex);
        });

        btn.addEventListener('click', () => {
if (Number.isNaN(idx)) return;

  /* 1) сворачиваем группу, где был выбран пункт */
  const parentGroup = btn.closest('.toc-group');
  if (parentGroup) {
    parentGroup.classList.add('collapsed');
  }

  /* 2) закрываем мобильную панель */
  if (isMobileLayout()) {
    closeToc();
  }

  /* 3) грузим квест */
  loadGame(idx);
        });
      });

      const tocGroups = document.querySelectorAll('#toc .toc-group');
      tocGroups.forEach(group => {
        const title = group.querySelector('.toc-group-title');
        const list = group.querySelector('ol');
        if (!title || !list) return;

        title.addEventListener('click', () => {
          group.classList.toggle('collapsed');
        });
      });

      if (survivalBtnEl) {
        survivalBtnEl.addEventListener('click', () => {
          survivalMode = !survivalMode;

          if (survivalMode) {
            resetLives();
            setSurvivalUIVisible(true);
            survivalBtnEl.classList.add('active');
            wizardSay('Режим выживания включён: у тебя 3 жизни. Каждая ошибка — минус жизнь.');
          } else {
            setSurvivalUIVisible(false);
            survivalBtnEl.classList.remove('active');
            wizardSay('Режим выживания выключен.');
          }

          renderLives();
        });
      }

      function launchVictoryEffect() {
        if (!victoryEffectEl) return;
        victoryEffectEl.innerHTML = '';
        victoryEffectEl.style.display = 'block';

        const colors = [
          '#f97316',
          '#facc15',
          '#22c55e',
          '#06b6d4',
          '#3b82f6',
          '#6366f1',
          '#a855f7',
          '#ec4899',
          '#ffffff'
        ];

        const bursts = 10;
        const particlesPerBurst = 26;

        for (let b = 0; b < bursts; b++) {
          const centerX = 10 + Math.random() * 80;
          const centerY = 15 + Math.random() * 45;

          const core = document.createElement('div');
          core.className = 'firework-core';
          core.style.left = centerX + 'vw';
          core.style.top = centerY + 'vh';
          core.style.background = 'radial-gradient(circle, ' +
            colors[Math.floor(Math.random() * colors.length)] +
            ' 0%, rgba(255,255,255,0) 70%)';
          core.style.animationDelay = (b * 0.12) + 's';
          victoryEffectEl.appendChild(core);

          const ring = document.createElement('div');
          ring.className = 'firework-ring';
          ring.style.left = centerX + 'vw';
          ring.style.top = centerY + 'vh';
          ring.style.borderColor = colors[Math.floor(Math.random() * colors.length)];
          ring.style.animationDelay = (b * 0.12 + 0.05) + 's';
          victoryEffectEl.appendChild(ring);

          for (let i = 0; i < particlesPerBurst; i++) {
            const angle = (Math.PI * 2 * i) / particlesPerBurst;
            const distance = 90 + Math.random() * 80;

            const dx = Math.cos(angle) * distance;
            const dy = Math.sin(angle) * distance;

            const dot = document.createElement('div');
            dot.className = 'firework';
            dot.style.left = centerX + 'vw';
            dot.style.top = centerY + 'vh';
            dot.style.setProperty('--dx', dx + 'px');
            dot.style.setProperty('--dy', dy + 'px');
            dot.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            dot.style.boxShadow =
              '0 0 10px ' + dot.style.backgroundColor +
              ', 0 0 22px ' + dot.style.backgroundColor;
            dot.style.animationDelay = (b * 0.12 + Math.random() * 0.08) + 's';

            victoryEffectEl.appendChild(dot);
          }
        }

        setTimeout(() => {
          stopVictoryEffect();
        }, 2600);
      }

      function stopVictoryEffect() {
        if (!victoryEffectEl) return;
        victoryEffectEl.style.display = 'none';
        victoryEffectEl.innerHTML = '';
      }

      function showGameoverOverlay() {
        if (!gameoverOverlayEl) return;
        gameoverOverlayEl.classList.add('visible');

        if (gameoverVideoEl) {
          try {
            gameoverVideoEl.currentTime = 0;
            gameoverVideoEl.play().catch(() => {});
          } catch (e) {
            console.warn('Не удалось воспроизвести видео Game Over:', e);
          }
        }
      }

      function hideGameoverOverlay() {
        if (!gameoverOverlayEl) return;
        gameoverOverlayEl.classList.remove('visible');

        if (gameoverVideoEl) {
          try {
            gameoverVideoEl.pause();
          } catch (e) {}
        }
      }

      function playVictorySound() {
        if (!victorySoundEl) return;
        try {
          victorySoundEl.currentTime = 0;
          victorySoundEl.volume = 0.7;
          victorySoundEl.play().catch(() => {});
        } catch (e) {
          console.warn('Не удалось проиграть звук победы:', e);
        }
      }

      function stopVictorySound() {
        if (!victorySoundEl) return;
        try {
          victorySoundEl.pause();
          victorySoundEl.currentTime = 0;
        } catch (e) {}
      }

      function playFullVictorySound() {
        if (!fullVictorySoundEl) return;
        try {
          fullVictorySoundEl.currentTime = 0;
          fullVictorySoundEl.volume = 0.8;
          fullVictorySoundEl.play().catch(() => {});
        } catch (e) {
          console.warn('Не удалось проиграть full_victory.mp3:', e);
        }
      }

      function playRightSound() {
        if (!soundRightEl) return;
        try {
          soundRightEl.currentTime = 0;
          soundRightEl.volume = 0.9;
          soundRightEl.play().catch(() => {});
        } catch (e) {
          console.warn('Не удалось проиграть sound_right.mp3:', e);
        }
      }

      function playWrongSound() {
        if (!soundWrongEl) return;
        try {
          soundWrongEl.currentTime = 0;
          soundWrongEl.volume = 0.9;
          soundWrongEl.play().catch(() => {});
        } catch (e) {
          console.warn('Не удалось проиграть sound_no_right.mp3:', e);
        }
      }

      function playDiamondSound() {
        if (!diamondSoundEl) return;
        try {
          diamondSoundEl.currentTime = 0;
          diamondSoundEl.volume = 0.9;
          diamondSoundEl.play().catch(() => {});
        } catch (e) {
          console.warn('Не удалось проиграть diamond.mp3:', e);
        }
      }

      function playGameoverSound() {
        if (!gameoverSoundEl) return;
        try {
          gameoverSoundEl.currentTime = 0;
          gameoverSoundEl.volume = 0.9;
          gameoverSoundEl.play().catch(() => {});
        } catch (e) {
          console.warn('Не удалось проиграть gameover.mp3:', e);
        }
      }

      function stopGameoverSound() {
        if (!gameoverSoundEl) return;
        try {
          gameoverSoundEl.pause();
          gameoverSoundEl.currentTime = 0;
        } catch (e) {}
      }

function showFinalSummary() {
  summaryShown = true;

  updateProgress();

  if (!keyMoments || keyMoments.length === 0) {
    questionTitleEl.style.display = 'block';
    questionTextEl.style.display = 'block';
    questionTitleEl.textContent = 'Квест пройден!';
    questionTextEl.textContent =
      'В этой партии не было вопросов‑квестов. Можно спокойно просмотреть ходы и перейти к следующей партии через оглавление слева.';
    answersEl.innerHTML = '';
    statusEl.textContent = '';
    if (explanationEl) explanationEl.textContent = '';

    launchVictoryEffect();
    playVictorySound();

    wizardSay('Партия завершена. Здесь вопросов не было — просто наслаждайся просмотром!');
    return;
  }

  const maxScore = getMaxScoreForCurrentGame();

  questionActive = false;
  manualQuestionActive = false;
  activeManualMoment = null;
  clearHoverHighlights();

  if (introTextEl) {
    introTextEl.style.display = 'none';
  }
  questionTitleEl.style.display = 'block';
  questionTextEl.style.display = 'block';

  questionTitleEl.textContent = 'Квест пройден!';
  questionTextEl.textContent =
    `Твой результат: ${score} из ${maxScore} очков.`;

  // очищаем блок с ответами и статус
  answersEl.innerHTML = '';
  statusEl.textContent = '';
  if (explanationEl) {
    explanationEl.textContent = '';
  }

// Кнопка "Перейти к следующему квесту" (если он есть)
const nextIndex = currentGameIndex + 1;
if (nextIndex < gamesData.length) {
  const nextQuestBtn = document.createElement('button');
  nextQuestBtn.textContent = 'Следующий квест';
  nextQuestBtn.className = 'next-quest-btn';
  nextQuestBtn.classList.add('is-shimmering');
  nextQuestBtn.addEventListener('click', () => {
    goToNextQuest();
  });

  answersEl.appendChild(nextQuestBtn);
} else {
  const info = document.createElement('p');
  info.textContent = 'Это был последний квест в текущем наборе.';
  info.style.marginTop = '10px';
  answersEl.appendChild(info);
}


  prevMoveBtn.disabled = false;
  nextMoveBtn.disabled = false;

  launchVictoryEffect();
  playVictorySound();

  wizardSay(`Итог: ${score} / ${maxScore}. Отличная работа! Можешь перейти к следующему квесту.`);
}
      function showQuestionForMoment(moment) {
        if (survivalMode && lives <= 0) return;

        questionActive = true;
        manualQuestionActive = false;
        activeManualMoment = null;

        statusEl.textContent = '';
        statusEl.style.color = '';
        if (explanationEl) {
          explanationEl.textContent = '';
          explanationEl.style.color = '#333';
        }
        nextBtn.style.display = 'none';
        answersEl.innerHTML = '';
        clearHoverHighlights();

        if (introTextEl) {
          introTextEl.style.display = 'none';
        }
        questionTitleEl.style.display = 'block';
        questionTextEl.style.display = 'block';

        prevMoveBtn.disabled = true;
        nextMoveBtn.disabled = true;

        const questionIndex = keyMoments.findIndex(m => m.index === moment.index);
        const questionNumber = questionIndex !== -1 ? questionIndex + 1 : '';
        questionTitleEl.textContent = questionNumber ? `Вопрос № ${questionNumber}` : 'Вопрос';

        questionTextEl.textContent = moment.question;

        wizardSay(moment.question);

        const sanToSquares = {};
        (moment.options || []).forEach(san => {
          sanToSquares[san] = getMoveSquaresForSan(moment, san);
        });

        const shuffledOptions = (moment.options || [])
          .map(o => ({ value: o, sort: Math.random() }))
          .sort((a, b) => a.sort - b.sort)
          .map(o => o.value);

        const letters = ['A', 'B', 'C', 'D', 'E', 'F'];

        shuffledOptions.forEach((optionSan, idx) => {
          const btn = document.createElement('button');
          btn.textContent = optionSan;
          btn.classList.add('answer-option');
          btn.dataset.letter = letters[idx] || '';

          const squares = sanToSquares[optionSan] || null;

          btn.addEventListener('mouseenter', () => {
            if (!questionActive) return;
            if (squares) {
              highlightMoveOnBoard(squares.from, squares.to);
            }
          });

          btn.addEventListener('mouseleave', () => {
            if (!questionActive) return;
            clearHoverHighlights();
          });

          btn.addEventListener('click', () => {
            checkAnswerForMoment(optionSan, moment);
          });
          answersEl.appendChild(btn);
        });
      }

      function showManualQuestion(moment) {
        if (survivalMode && lives <= 0) return;

        questionActive = true;
        manualQuestionActive = true;
        activeManualMoment = moment;

        statusEl.textContent = '';
        statusEl.style.color = '';
        if (explanationEl) {
          explanationEl.textContent = '';
          explanationEl.style.color = '#333';
        }
        nextBtn.style.display = 'none';
        answersEl.innerHTML = '';
        clearHoverHighlights();

        if (introTextEl) {
          introTextEl.style.display = 'none';
        }
        questionTitleEl.style.display = 'block';
        questionTextEl.style.display = 'block';

        prevMoveBtn.disabled = true;
        nextMoveBtn.disabled = true;

        const questionIndex = keyMoments.findIndex(m => m.index === moment.index);
        const questionNumber = questionIndex !== -1 ? questionIndex + 1 : '';
        questionTitleEl.textContent = questionNumber ? `Вопрос № ${questionNumber}` : 'Вопрос';

        questionTextEl.textContent = moment.question;

        statusEl.style.color = '#333';
        statusEl.textContent = 'Подумай и сделай ход на доске.';

        wizardSay(moment.question + '\nСделай ход на доске.');
      }

      function checkAnswerForMoment(selectedSan, moment) {
        if (survivalMode && lives <= 0) return;

        const buttons = Array.from(answersEl.querySelectorAll('button'));

        buttons.forEach(b => b.disabled = true);

        const explanationText =
          (moment.explanations && moment.explanations[selectedSan]) ?
            moment.explanations[selectedSan] :
            '';

        clearHoverHighlights();

        if (selectedSan === moment.correctMoveSan) {
          const delta = getMomentPoints(moment);
          score += delta;
          updateScoreDisplay(delta);

          if (delta === 3) {
            playDiamondSound();
            triggerDiamondImpact();
            diamondMoves.add(moment.index);
          } else {
            playRightSound();
          }

          statusEl.style.color = 'green';
          statusEl.textContent = 'Верно!';

          if (explanationEl) {
            explanationEl.textContent = explanationText;
            explanationEl.style.color = '#333';
          }

          wizardCommentForAnswer(moment, selectedSan, true);

          buttons.forEach(b => {
            if (b.textContent === moment.correctMoveSan) {
              b.classList.add('correct');
            }
          });

          answeredMoments.add(moment.index);
          updateProgress();

          game.move(moment.correctMoveSan);
          board.position(game.fen());

          syncCurrentIndexWithGame();

          questionActive = false;
          prevMoveBtn.disabled = false;
          nextMoveBtn.disabled = false;
          updateBoardAndNotation();
          nextBtn.style.display = 'none';
        } else {
          loseLife();
          if (survivalMode && lives <= 0) {
            return;
          }

          const delta = -1;
          score += delta;
          updateScoreDisplay(delta);

          playWrongSound();

          statusEl.style.color = 'red';
          statusEl.textContent = 'Попробуй ещё раз.';

          if (explanationEl) {
            explanationEl.textContent = explanationText;
            explanationEl.style.color = '#333';
          }

          wizardCommentForAnswer(moment, selectedSan, false);

          buttons.forEach(b => {
            if (b.textContent === selectedSan) {
              b.classList.add('incorrect');
            }
          });

          buttons.forEach(b => {
            if (b.textContent !== selectedSan) b.disabled = false;
          });
        }
      }

      if (boardEl) {
        boardEl.addEventListener('contextmenu', (e) => {
          e.preventDefault();
        });
      }

      function getSquareByClientPos(clientX, clientY) {
        const elem = document.elementFromPoint(clientX, clientY);
        if (!elem) return null;
        const sqEl = elem.closest('#board .square-55d63');
        if (!sqEl) return null;
        return sqEl.getAttribute('data-square') || null;
      }

      function toggleSquareHighlight(square) {
        if (!square) return;
        const sqEl = document.querySelector('#board .square-55d63[data-square="' + square + '"]');
        if (!sqEl) return;
        sqEl.classList.toggle('user-highlight-square');
      }

      function clearAllUserHighlights() {
        const squares = document.querySelectorAll('#board .square-55d63.user-highlight-square');
        squares.forEach(sq => sq.classList.remove('user-highlight-square'));
      }

      function toggleArrow(from, to) {
        if (!from || !to || from === to || !boardArrowLayerEl) return;
        const key = from + '-' + to;
        if (boardArrows.has(key)) {
          const obj = boardArrows.get(key);
          if (obj && obj.lineEl && obj.lineEl.parentNode) {
            obj.lineEl.parentNode.removeChild(obj.lineEl);
          }
          boardArrows.delete(key);
          return;
        }

        const coordsFrom = squareToSvgCoords(from);
        const coordsTo = squareToSvgCoords(to);
        if (!coordsFrom || !coordsTo) return;

        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.classList.add('board-arrow');
        line.setAttribute('x1', coordsFrom.x);
        line.setAttribute('y1', coordsFrom.y);
        line.setAttribute('x2', coordsTo.x);
        line.setAttribute('y2', coordsTo.y);
        line.setAttribute('marker-end', 'url(#board-arrow-head-marker)');
        boardArrowLayerEl.appendChild(line);

        boardArrows.set(key, {
          from,
          to,
          lineEl: line
        });
      }

      function squareToSvgCoords(square) {
        if (!boardEl || !boardArrowLayerEl) return null;

        const boardRect = boardEl.getBoundingClientRect();
        const svgRect = boardArrowLayerEl.getBoundingClientRect();
        const size = boardRect.width;
        const squareSize = size / 8;

        const fileChar = square[0];
        const rankChar = square[1];

        const files = ['a','b','c','d','e','f','g','h'];
        const ranks = ['1','2','3','4','5','6','7','8'];

        const orientation = board.orientation ? board.orientation() : 'white';

        let fileIndex = files.indexOf(fileChar);
        let rankIndex = ranks.indexOf(rankChar);

        if (fileIndex === -1 || rankIndex === -1) return null;

        let xIndex, yIndex;
        if (orientation === 'white') {
          xIndex = fileIndex;
          yIndex = 7 - rankIndex;
        } else {
          xIndex = 7 - fileIndex;
          yIndex = rankIndex;
        }

        const boardX = (xIndex + 0.5) * squareSize;
        const boardY = (yIndex + 0.5) * squareSize;

        const x = (boardRect.left - svgRect.left) + boardX;
        const y = (boardRect.top - svgRect.top) + boardY;

        return { x, y };
      }

      function updateArrowPosition(obj) {
        if (!obj || !obj.lineEl) return;
        const coordsFrom = squareToSvgCoords(obj.from);
        const coordsTo = squareToSvgCoords(obj.to);
        if (!coordsFrom || !coordsTo) return;

        obj.lineEl.setAttribute('x1', coordsFrom.x);
        obj.lineEl.setAttribute('y1', coordsFrom.y);
        obj.lineEl.setAttribute('x2', coordsTo.x);
        obj.lineEl.setAttribute('y2', coordsTo.y);
      }

      function updateAllArrowsPositions() {
        boardArrows.forEach(obj => updateArrowPosition(obj));
      }

      function clearAllArrows() {
        boardArrows.forEach(obj => {
          if (obj.lineEl && obj.lineEl.parentNode) {
            obj.lineEl.parentNode.removeChild(obj.lineEl);
          }
        });
        boardArrows.clear();
      }

      if (boardEl) {
        boardEl.addEventListener('mousedown', (e) => {
          if (e.button === 0) {
            clearAllArrows();
            clearAllUserHighlights();
          }
        });

        boardEl.addEventListener('mousedown', (e) => {
          if (e.button !== 2) return;

          e.preventDefault();
          e.stopPropagation();

          const sqEl = e.target.closest('.square-55d63');
          if (!sqEl) return;

          rightMouseDown = true;
          rightMouseDragged = false;
          rightMouseStartPos = { x: e.clientX, y: e.clientY };
          rightMouseStartSquare = sqEl.getAttribute('data-square') || null;
        }, true);

        document.addEventListener('mousemove', (e) => {
          if (!rightMouseDown) return;
          const dx = e.clientX - rightMouseStartPos.x;
          const dy = e.clientY - rightMouseStartPos.y;
          const dist2 = dx * dx + dy * dy;
          const threshold2 = 6 * 6;
          if (dist2 > threshold2) {
            rightMouseDragged = true;
          }
        });

        document.addEventListener('mouseup', (e) => {
          if (!rightMouseDown || e.button !== 2) return;
          e.preventDefault();

          rightMouseDown = false;

          const endSquare = getSquareByClientPos(e.clientX, e.clientY);

          if (!rightMouseDragged) {
            if (rightMouseStartSquare && rightMouseStartSquare === endSquare) {
              toggleSquareHighlight(rightMouseStartSquare);
            }
          } else {
            if (rightMouseStartSquare && endSquare && rightMouseStartSquare !== endSquare) {
              toggleArrow(rightMouseStartSquare, endSquare);
            }
          }

          rightMouseStartSquare = null;
          rightMouseDragged = false;
        });
      }

      const welcomeScreen = document.getElementById('welcome-screen');
      const layout = document.getElementById('layout');
      const startBtn = document.getElementById('start-quest-btn');
      
startBtn.addEventListener('click', () => {
  playFullVictorySound();

  if (gameoverRestartBtnEl) {
    gameoverRestartBtnEl.addEventListener('click', () => {
      hideGameoverOverlay();
      stopGameoverSound();
      loadGame(currentGameIndex);
    });
  }

  welcomeScreen.style.display = 'none';
  layout.style.display = 'grid';

  setTimeout(() => autoFitBoard(), 0);
  board.orientation('white');

  if (eraProgressEl) {
    eraProgressEl.style.display = 'block';
  }

  setSurvivalUIVisible(survivalMode);
  renderLives();

  loadGame(0);
});


      currentMoveIndex = 0;
      game.reset();
      board.position('start');
      updateScoreDisplay(0);

      setSurvivalUIVisible(false);
      renderLives();

      setEraProgressForGame(0);

loadGame(0);
setTimeout(() => autoFitBoard(), 0);

window.addEventListener('resize', () => {
  autoFitBoard();
});



    });
  </script>
</body>
</html>
